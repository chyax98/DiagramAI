# DiagramAI ä¸‰çº§æç¤ºè¯ç³»ç»Ÿåˆ†æ

> åˆ†ææ—¶é—´: 2025-10-18  
> åˆ†æèŒƒå›´: æç¤ºè¯æ¶æ„ã€åˆæˆæœºåˆ¶ã€ç‰ˆæœ¬ç®¡ç†ã€æ•°æ®æµ

---

## ğŸ“Š æ¶æ„æ¦‚è§ˆ

DiagramAI ä½¿ç”¨**ä¸‰å±‚é‡‘å­—å¡”å¼ Prompt æ¶æ„**ï¼Œå°†æç¤ºè¯æŒ‰ç…§æŠ½è±¡å±‚çº§åˆ†ä¸ºä¸‰å±‚ï¼Œå®ç°äº†æç¤ºè¯çš„æ¨¡å—åŒ–ã€å¤ç”¨å’Œç²¾ç¡®æ§åˆ¶ã€‚

```mermaid
graph TB
    subgraph "æç¤ºè¯å±‚çº§ç»“æ„"
        L1["L1: é€šç”¨è§„èŒƒ<br/>universal.txt<br/>æ‰€æœ‰å›¾è¡¨å…±äº«"]
        L2["L2: è¯­è¨€è§„èŒƒ<br/>{language}/common.txt<br/>ç‰¹å®šæ¸²æŸ“è¯­è¨€<br/>å¯é€‰"]
        L3["L3: ç±»å‹è§„èŒƒ<br/>{language}/{type}.txt<br/>ç‰¹å®šå›¾è¡¨ç±»å‹<br/>å¿…éœ€"]
    end
    
    subgraph "ä½¿ç”¨åœºæ™¯ç¤ºä¾‹"
        L1 --> L2_mermaid["L2: Mermaid é€šç”¨è§„èŒƒ"]
        L2_mermaid --> L3_flow["L3: Mermaid Flowchart"]
        L2_mermaid --> L3_seq["L3: Mermaid Sequence"]
        L2_mermaid --> L3_other["L3: å…¶ä»– Mermaid ç±»å‹"]
    end
    
    style L1 fill:#e1f5ff
    style L2 fill:#fff3e0
    style L3 fill:#f3e5f5
```

---

## ğŸ” ä¸‰å±‚æç¤ºè¯è¯¦è§£

### L1: é€šç”¨è§„èŒƒå±‚ï¼ˆUniversalï¼‰

**æ–‡ä»¶ä½ç½®**: `data/prompts/universal.txt`ï¼ˆçº¦ 641 è¡Œï¼‰

**ä½œç”¨åŸŸ**: æ‰€æœ‰å›¾è¡¨ç±»å‹

**æ ¸å¿ƒå†…å®¹**:
1. **ä»»åŠ¡è¯†åˆ«ç³»ç»Ÿ**ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   - `<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>` - ç”Ÿæˆæ–°å›¾è¡¨
   - `<<<SYSTEM_INSTRUCTION: ADJUST_EXISTING_DIAGRAM>>>` - è°ƒæ•´ç°æœ‰å›¾è¡¨
   - `<<<SYSTEM_INSTRUCTION: FIX_SYNTAX_ERRORS_ONLY>>>` - ä»…ä¿®å¤è¯­æ³•é”™è¯¯

2. **é€šç”¨è¾“å‡ºè¦æ±‚**
   - çº¯ä»£ç è¾“å‡ºï¼Œæ—  Markdown åŒ…è£…
   - æ— æ³¨é‡Šå’Œè§£é‡Šæ–‡æœ¬
   - è¯­æ³•æ­£ç¡®æ€§ä¿è¯

3. **AI è¡Œä¸ºè§„èŒƒ**
   - ç†è§£ç”¨æˆ·æ„å›¾çš„æ–¹æ³•
   - ä»£ç ç”Ÿæˆçš„åŸåˆ™
   - é”™è¯¯å¤„ç†çš„ç­–ç•¥

**ç¤ºä¾‹ç‰‡æ®µ**:
```text
## âš ï¸ ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ã€‘ä»»åŠ¡è¯†åˆ«

æ¯æ¡ç”¨æˆ·æ¶ˆæ¯çš„**å¼€å¤´**ä¼šåŒ…å«ä¸€ä¸ª `<<<SYSTEM_INSTRUCTION>>>` æ ‡è®°ï¼Œè¿™æ˜¯ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œ
**ä¼˜å…ˆçº§é«˜äºæ‰€æœ‰å…¶ä»–è§„èŒƒå’Œæœ€ä½³å®è·µ**ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‚

### ğŸ“‹ ä¸‰ç§ä»»åŠ¡æŒ‡ä»¤
...
```

---

### L2: è¯­è¨€è§„èŒƒå±‚ï¼ˆLanguage-Specificï¼‰

**æ–‡ä»¶ä½ç½®**: `data/prompts/{language}/common.txt`

**ä½œç”¨åŸŸ**: ç‰¹å®šæ¸²æŸ“è¯­è¨€çš„æ‰€æœ‰å›¾è¡¨ç±»å‹

**ç‰¹ç‚¹**: 
- **å¯é€‰å±‚çº§** - 21/23 ç§è¯­è¨€æœ‰æ­¤æ–‡ä»¶
- æ—  L2 æ—¶ä¸å½±å“ç³»ç»Ÿè¿è¡Œ

**æ ¸å¿ƒå†…å®¹**ï¼ˆä»¥ Mermaid ä¸ºä¾‹ï¼‰:
1. **è¯­è¨€å¼ºåˆ¶è§„åˆ™**
   - ä¿ç•™å…³é”®å­—åˆ—è¡¨
   - ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰è§„åˆ™
   - æ³¨é‡Šè¯­æ³•è§„èŒƒ

2. **è¯­è¨€æœ€ä½³å®è·µ**
   - å‘½åè§„èŒƒ
   - å¸ƒå±€å»ºè®®
   - æ ·å¼çº¦å®š

**ç¤ºä¾‹ç‰‡æ®µ**ï¼ˆ`mermaid/common.txt`ï¼‰:
```text
## ğŸš¨ Mermaid å¼ºåˆ¶è§„åˆ™ï¼ˆè¿åå³ç¼–è¯‘å¤±è´¥ï¼‰

### è§„åˆ™1: ä¿ç•™å…³é”®å­—å†²çª
**å…¨å±€ä¿ç•™å…³é”®å­—**ï¼ˆä¸èƒ½ç”¨ä½œèŠ‚ç‚¹ IDï¼‰:
graph, subgraph, end, flowchart, direction,
class, classDef, style, click, call, href, callback,
title, section, note

**æ£€æµ‹æ–¹æ³•**: åœ¨ç”Ÿæˆå‰æ‰«ææ‰€æœ‰èŠ‚ç‚¹ IDï¼Œä¸ä¿ç•™å…³é”®å­—åˆ—è¡¨å¯¹æ¯”ã€‚
```

---

### L3: ç±»å‹è§„èŒƒå±‚ï¼ˆType-Specificï¼‰

**æ–‡ä»¶ä½ç½®**: `data/prompts/{language}/{type}.txt`

**ä½œç”¨åŸŸ**: ç‰¹å®šå›¾è¡¨ç±»å‹

**ç‰¹ç‚¹**: 
- **å¿…éœ€å±‚çº§** - æ¯ä¸ªå›¾è¡¨ç±»å‹éƒ½å¿…é¡»æœ‰å¯¹åº”çš„ L3 æ–‡ä»¶
- æœ€ç²¾ç¡®ã€æœ€å…·é’ˆå¯¹æ€§çš„æç¤ºè¯

**æ ¸å¿ƒå†…å®¹**ï¼ˆä»¥ `mermaid/flowchart.txt` ä¸ºä¾‹ï¼‰:
1. **ä¸“å®¶è§†è§’å®šä¹‰**
   - æµç¨‹è®¾è®¡ä¸“å®¶
   - Mermaid Flowchart å·¥ç¨‹å¸ˆ
   - ä»£ç è´¨é‡å®¡æŸ¥å‘˜

2. **æ ¸å¿ƒè¯­æ³•è§„èŒƒ**
   - å›¾è¡¨å£°æ˜æ–¹å¼
   - èŠ‚ç‚¹ç±»å‹å®šä¹‰
   - è¿æ¥çº¿è§„èŒƒ

3. **é«˜çº§ç‰¹æ€§**
   - å­å›¾ï¼ˆsubgraphï¼‰ç”¨æ³•
   - æ ·å¼å®šåˆ¶
   - é“¾æ¥å’Œäº¤äº’

**ç¤ºä¾‹ç‰‡æ®µ**ï¼ˆ`mermaid/flowchart.txt`ï¼‰:
```text
## ä¸“å®¶è§†è§’

ä½œä¸ºæµç¨‹å›¾ä¸“å®¶ï¼Œä½ éœ€è¦åŒæ—¶æ‰®æ¼”ï¼š

1. **æµç¨‹è®¾è®¡ä¸“å®¶**
   - å°†å¤æ‚ä¸šåŠ¡é€»è¾‘è½¬åŒ–ä¸ºæ¸…æ™°çš„æµç¨‹å›¾
   - è¯†åˆ«æµç¨‹ä¸­çš„å…³é”®å†³ç­–ç‚¹å’Œåˆ†æ”¯è·¯å¾„
   - ç¡®ä¿æµç¨‹çš„å®Œæ•´æ€§ï¼ˆæœ‰æ˜ç¡®çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼‰

2. **Mermaid Flowchart å·¥ç¨‹å¸ˆ**
   - ç²¾é€š Flowchart è¯­æ³•çš„æ‰€æœ‰ç»†èŠ‚
   - ç†Ÿæ‚‰å„ç§èŠ‚ç‚¹ç±»å‹å’Œè¿æ¥æ–¹å¼
   - æŒæ¡æ ·å¼å®šåˆ¶å’Œå¸ƒå±€ä¼˜åŒ–æŠ€å·§
```

---

## ğŸ”§ æç¤ºè¯åˆæˆæœºåˆ¶

### åˆæˆæµç¨‹

```mermaid
flowchart TD
    Start[ç”¨æˆ·è¯·æ±‚] --> Parse[è§£æå‚æ•°]
    Parse --> |renderLanguage<br/>diagramType| LoadL1[åŠ è½½ L1 é€šç”¨è§„èŒƒ]
    
    LoadL1 --> CheckDB1{æ•°æ®åº“æœ‰<br/>è‡ªå®šä¹‰ç‰ˆæœ¬?}
    CheckDB1 -->|æ˜¯| UseDB1[ä½¿ç”¨æ•°æ®åº“ç‰ˆæœ¬]
    CheckDB1 -->|å¦| UseFile1[ä½¿ç”¨ universal.txt]
    
    UseDB1 --> LoadL2[åŠ è½½ L2 è¯­è¨€è§„èŒƒ]
    UseFile1 --> LoadL2
    
    LoadL2 --> CheckDB2{æ•°æ®åº“æœ‰<br/>è‡ªå®šä¹‰ç‰ˆæœ¬?}
    CheckDB2 -->|æ˜¯| UseDB2[ä½¿ç”¨æ•°æ®åº“ç‰ˆæœ¬]
    CheckDB2 -->|å¦| CheckFile2{æ–‡ä»¶ç³»ç»Ÿæœ‰<br/>common.txt?}
    CheckFile2 -->|æ˜¯| UseFile2[ä½¿ç”¨ common.txt]
    CheckFile2 -->|å¦| SkipL2[è·³è¿‡ L2<br/>å¯é€‰å±‚]
    
    UseDB2 --> LoadL3[åŠ è½½ L3 ç±»å‹è§„èŒƒ]
    UseFile2 --> LoadL3
    SkipL2 --> LoadL3
    
    LoadL3 --> CheckDB3{æ•°æ®åº“æœ‰<br/>è‡ªå®šä¹‰ç‰ˆæœ¬?}
    CheckDB3 -->|æ˜¯| UseDB3[ä½¿ç”¨æ•°æ®åº“ç‰ˆæœ¬]
    CheckDB3 -->|å¦| UseFile3[ä½¿ç”¨ {type}.txt]
    
    UseDB3 --> Merge[åˆå¹¶ä¸‰å±‚æç¤ºè¯]
    UseFile3 --> Merge
    
    Merge --> Final[æœ€ç»ˆ Prompt]
    Final --> SendAI[å‘é€ç»™ AI æ¨¡å‹]
    
    style LoadL1 fill:#e1f5ff
    style LoadL2 fill:#fff3e0
    style LoadL3 fill:#f3e5f5
    style Merge fill:#c8e6c9
    style Final fill:#ffccbc
```

### æ ¸å¿ƒä»£ç å®ç°

#### 1. ä¸»å…¥å£å‡½æ•°ï¼ˆ`src/lib/constants/prompts/index.ts`ï¼‰

```typescript
export function getGeneratePrompt(
  renderLanguage: RenderLanguage,
  diagramType: DiagramType
): string {
  const db = getDatabaseInstance();
  const repo = new PromptRepository(db);

  // 1. L1: é€šç”¨è§„èŒƒ (æ‰€æœ‰å›¾è¡¨å…±äº«)
  const l1 = repo.findActive(1);

  // 2. L2: è¯­è¨€è§„èŒƒ (å¦‚ Mermaid é€šç”¨è§„èŒƒ)
  const l2 = repo.findActive(2, renderLanguage);

  // 3. L3: ç±»å‹è§„èŒƒ (å¦‚ Flowchart ç‰¹å®šè¦æ±‚)
  const l3 = repo.findActive(3, renderLanguage, diagramType);

  // ç»„åˆæ‰€æœ‰å±‚çº§çš„ prompt
  const parts: string[] = [];
  if (l1) parts.push(l1.content);
  if (l2) parts.push(l2.content);
  if (l3) parts.push(l3.content);

  if (parts.length === 0) {
    throw new Error(`æœªæ‰¾åˆ°æç¤ºè¯: renderLanguage=${renderLanguage}, diagramType=${diagramType}`);
  }

  // ä½¿ç”¨ "---" åˆ†éš”ç¬¦è¿æ¥
  return parts.join("\n\n---\n\n");
}
```

#### 2. åŠ è½½å™¨é€»è¾‘ï¼ˆ`src/lib/utils/prompt-loader.ts`ï¼‰

```typescript
export async function loadPrompt(
  renderLanguage: RenderLanguage,
  diagramType: string
): Promise<PromptLoadResult> {
  const db = getDatabaseInstance();
  const promptRepo = new PromptRepository(db);

  // ===== L1: é€šç”¨æç¤ºè¯ =====
  let l1_content: string | null = null;
  let l1_version: string | undefined = undefined;
  let l1_id: number | undefined = undefined;

  const l1Custom = promptRepo.findActive(1);
  if (l1Custom) {
    l1_content = l1Custom.content;
    l1_version = l1Custom.version;
    l1_id = l1Custom.id;
  } else {
    // Fallback åˆ°æ–‡ä»¶ç³»ç»Ÿ
    const universalPath = join(PROMPTS_DIR, "universal.txt");
    l1_content = await readFile(universalPath, "utf-8");
    l1_version = "system-default";
  }

  // ===== L2: è¯­è¨€çº§æç¤ºè¯ (å¯é€‰) =====
  let l2_content: string | null = null;
  let l2_version: string | undefined = undefined;
  let l2_id: number | undefined = undefined;

  const l2Custom = promptRepo.findActive(2, renderLanguage);
  if (l2Custom) {
    l2_content = l2Custom.content;
    l2_version = l2Custom.version;
    l2_id = l2Custom.id;
  } else {
    // Fallback åˆ°æ–‡ä»¶ç³»ç»Ÿ (æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨,å¿½ç•¥é”™è¯¯)
    try {
      const commonPath = join(PROMPTS_DIR, renderLanguage, "common.txt");
      l2_content = await readFile(commonPath, "utf-8");
      l2_version = "system-default";
    } catch {
      // L2 æ˜¯å¯é€‰çš„,ä¸å­˜åœ¨æ—¶è·³è¿‡
      l2_content = null;
    }
  }

  // ===== L3: ç±»å‹çº§æç¤ºè¯ (å¿…éœ€) =====
  let l3_content: string | null = null;
  let l3_version: string | undefined = undefined;
  let l3_id: number | undefined = undefined;

  const l3Custom = promptRepo.findActive(3, renderLanguage, diagramType);
  if (l3Custom) {
    l3_content = l3Custom.content;
    l3_version = l3Custom.version;
    l3_id = l3Custom.id;
  } else {
    // Fallback åˆ°æ–‡ä»¶ç³»ç»Ÿ
    const typePath = join(PROMPTS_DIR, renderLanguage, `${diagramType}.txt`);
    l3_content = await readFile(typePath, "utf-8");
    l3_version = "system-default";
  }

  // ===== ç»„åˆæœ€ç»ˆ Prompt =====
  const parts: string[] = [];
  if (l1_content) parts.push(l1_content);
  if (l2_content) parts.push(l2_content);
  if (l3_content) parts.push(l3_content);

  const final_prompt = parts.join("\n\n---\n\n");

  return {
    l1_content,
    l2_content,
    l3_content,
    final_prompt,
    versions: { l1_version, l2_version, l3_version },
    prompt_ids: { l1_id, l2_id, l3_id },
  };
}
```

#### 3. æ•°æ®åº“æŸ¥è¯¢ï¼ˆ`src/lib/repositories/PromptRepository.ts`ï¼‰

```typescript
/**
 * è·å–æ¿€æ´»çš„æç¤ºè¯ç‰ˆæœ¬
 */
findActive(level: 1 | 2 | 3, language?: string, type?: string): CustomPrompt | null {
  const stmt = this.db.prepare(`
    SELECT * FROM custom_prompts
    WHERE prompt_level = ?
      AND (render_language = ? OR (render_language IS NULL AND ? IS NULL))
      AND (diagram_type = ? OR (diagram_type IS NULL AND ? IS NULL))
      AND is_active = 1
    LIMIT 1
  `);

  const row = stmt.get(
    level, 
    language || null, 
    language || null, 
    type || null, 
    type || null
  ) as CustomPrompt | undefined;

  return row || null;
}
```

---

## ğŸ”„ æ•°æ®æµå‘

### å®Œæ•´çš„ç”Ÿæˆæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant API as API è·¯ç”±<br/>/api/chat
    participant Service as DiagramGenerationService
    participant PromptSystem as æç¤ºè¯ç³»ç»Ÿ
    participant DB as æ•°æ®åº“
    participant FS as æ–‡ä»¶ç³»ç»Ÿ
    participant AI as AI æ¨¡å‹

    User->>API: POST è¯·æ±‚<br/>{userMessage, renderLanguage, diagramType}
    API->>Service: chat(params)
    
    Service->>PromptSystem: getGeneratePrompt(language, type)
    
    PromptSystem->>DB: æŸ¥è¯¢ L1 æ¿€æ´»ç‰ˆæœ¬
    alt æ•°æ®åº“æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬
        DB-->>PromptSystem: è¿”å›è‡ªå®šä¹‰ L1
    else æ— è‡ªå®šä¹‰ç‰ˆæœ¬
        PromptSystem->>FS: è¯»å– universal.txt
        FS-->>PromptSystem: è¿”å›é»˜è®¤ L1
    end
    
    PromptSystem->>DB: æŸ¥è¯¢ L2 æ¿€æ´»ç‰ˆæœ¬
    alt æ•°æ®åº“æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬
        DB-->>PromptSystem: è¿”å›è‡ªå®šä¹‰ L2
    else æ— è‡ªå®šä¹‰ç‰ˆæœ¬
        PromptSystem->>FS: è¯»å– {language}/common.txt
        alt æ–‡ä»¶å­˜åœ¨
            FS-->>PromptSystem: è¿”å›é»˜è®¤ L2
        else æ–‡ä»¶ä¸å­˜åœ¨
            PromptSystem->>PromptSystem: L2 = null (å¯é€‰å±‚)
        end
    end
    
    PromptSystem->>DB: æŸ¥è¯¢ L3 æ¿€æ´»ç‰ˆæœ¬
    alt æ•°æ®åº“æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬
        DB-->>PromptSystem: è¿”å›è‡ªå®šä¹‰ L3
    else æ— è‡ªå®šä¹‰ç‰ˆæœ¬
        PromptSystem->>FS: è¯»å– {language}/{type}.txt
        FS-->>PromptSystem: è¿”å›é»˜è®¤ L3
    end
    
    PromptSystem->>PromptSystem: åˆå¹¶: L1 + "---" + L2 + "---" + L3
    PromptSystem-->>Service: è¿”å›å®Œæ•´ Prompt
    
    Service->>Service: æ„å»ºä»»åŠ¡æ ‡è®°<br/>(GENERATE/ADJUST/FIX)
    Service->>AI: generateText({<br/>  system: prompt,<br/>  messages: [{<br/>    role: "user",<br/>    content: taskHint + userMessage<br/>  }]<br/>})
    
    AI-->>Service: ç”Ÿæˆçš„ä»£ç 
    Service->>Service: cleanCode() æ¸…ç†ä»£ç 
    Service-->>API: è¿”å›ç»“æœ
    API-->>User: è¿”å›å›¾è¡¨ä»£ç 
```

---

## ğŸ“¦ ç‰ˆæœ¬ç®¡ç†æœºåˆ¶

### ç‰ˆæœ¬ç”Ÿå‘½å‘¨æœŸ

```mermaid
stateDiagram-v2
    [*] --> v0_Official: ç³»ç»Ÿåˆå§‹åŒ–<br/>å¯¼å…¥å®˜æ–¹æç¤ºè¯
    
    v0_Official --> v1_Custom: ç”¨æˆ·é¦–æ¬¡ç¼–è¾‘<br/>åˆ›å»º v1
    v1_Custom --> v2_Custom: å†æ¬¡ç¼–è¾‘<br/>åˆ›å»º v2
    v2_Custom --> v3_Custom: ç»§ç»­ç¼–è¾‘<br/>åˆ›å»º v3
    v3_Custom --> vN_Custom: ...
    
    v1_Custom --> v0_Official: æ¿€æ´» v0<br/>(å›é€€åˆ°å®˜æ–¹ç‰ˆæœ¬)
    v2_Custom --> v1_Custom: æ¿€æ´» v1<br/>(å›é€€åˆ°æ—§ç‰ˆæœ¬)
    v3_Custom --> v2_Custom: æ¿€æ´» v2
    
    note right of v0_Official
        version = "v0"
        is_active = 1
        (å®˜æ–¹ç‰ˆæœ¬)
    end note
    
    note right of v1_Custom
        version = "v1"
        is_active = 0/1
        (ç”¨æˆ·ç‰ˆæœ¬)
    end note
```

### ç‰ˆæœ¬å·ç”Ÿæˆè§„åˆ™

```typescript
/**
 * è‡ªåŠ¨ç‰ˆæœ¬å·ç”Ÿæˆé€»è¾‘
 * 
 * è§„åˆ™:
 * 1. æŸ¥è¯¢åŒä¸€ä½ç½®çš„æœ€å¤§ç‰ˆæœ¬å·
 * 2. è§£æç‰ˆæœ¬å·: "v123" -> 123
 * 3. é€’å¢: 123 + 1 = 124
 * 4. è¿”å›: "v124"
 */
private getNextVersion(level: 1 | 2 | 3, language?: string, type?: string): string {
  const stmt = this.db.prepare(`
    SELECT version FROM custom_prompts
    WHERE prompt_level = ?
      AND (render_language = ? OR (render_language IS NULL AND ? IS NULL))
      AND (diagram_type = ? OR (diagram_type IS NULL AND ? IS NULL))
    ORDER BY version DESC
    LIMIT 1
  `);

  const row = stmt.get(level, language || null, language || null, type || null, type || null);

  if (!row) {
    return "v1"; // é¦–ä¸ªè‡ªå®šä¹‰ç‰ˆæœ¬
  }

  const currentVersionNum = parseInt(row.version.substring(1), 10);
  
  if (isNaN(currentVersionNum)) {
    return "v1";
  }

  return `v${currentVersionNum + 1}`;
}
```

### ç‰ˆæœ¬æ¿€æ´»æœºåˆ¶

```typescript
/**
 * æ¿€æ´»æŒ‡å®šç‰ˆæœ¬
 * 
 * åŠŸèƒ½:
 * 1. å–æ¶ˆåŒä¸€ä½ç½®æ‰€æœ‰ç‰ˆæœ¬çš„æ¿€æ´»çŠ¶æ€
 * 2. æ¿€æ´»æŒ‡å®šç‰ˆæœ¬
 * 3. ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
 */
activate(id: number): void {
  const transaction = this.db.transaction((promptId: number) => {
    const prompt = this.findById(promptId);
    if (!prompt) {
      throw new Error(`Prompt with id ${promptId} not found`);
    }

    // 1. å–æ¶ˆåŒä¸€ä½ç½®æ‰€æœ‰ç‰ˆæœ¬çš„æ¿€æ´»çŠ¶æ€
    const deactivateStmt = this.db.prepare(`
      UPDATE custom_prompts
      SET is_active = 0
      WHERE prompt_level = ?
        AND (render_language = ? OR (render_language IS NULL AND ? IS NULL))
        AND (diagram_type = ? OR (diagram_type IS NULL AND ? IS NULL))
        AND id != ?
    `);

    deactivateStmt.run(
      prompt.prompt_level,
      prompt.render_language,
      prompt.render_language,
      prompt.diagram_type,
      prompt.diagram_type,
      promptId
    );

    // 2. æ¿€æ´»æŒ‡å®šç‰ˆæœ¬
    const activateStmt = this.db.prepare(`
      UPDATE custom_prompts
      SET is_active = 1
      WHERE id = ?
    `);

    activateStmt.run(promptId);
  });

  transaction(id);
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### custom_prompts è¡¨ç»“æ„

```sql
CREATE TABLE IF NOT EXISTS custom_prompts (
  -- ä¸»é”®
  id INTEGER PRIMARY KEY AUTOINCREMENT,

  -- æç¤ºè¯å±‚çº§ (L1/L2/L3)
  prompt_level INTEGER NOT NULL CHECK(prompt_level IN (1, 2, 3)),

  -- æ¸²æŸ“è¯­è¨€ (L2/L3 å¿…å¡«, L1 ä¸º NULL)
  render_language TEXT,

  -- å›¾è¡¨ç±»å‹ (L3 å¿…å¡«, L1/L2 ä¸º NULL)
  diagram_type TEXT,

  -- ç‰ˆæœ¬å· (å¦‚ "v1", "v2", "v3")
  version TEXT NOT NULL,

  -- ç‰ˆæœ¬åç§° (å¯é€‰)
  name TEXT,

  -- ç‰ˆæœ¬æè¿° (å¯é€‰)
  description TEXT,

  -- å½“å‰æ¿€æ´»ç‰ˆæœ¬æ ‡è®° (0: å†å²ç‰ˆæœ¬, 1: å½“å‰æ¿€æ´»ç‰ˆæœ¬)
  is_active INTEGER DEFAULT 0 CHECK(is_active IN (0, 1)),

  -- æç¤ºè¯å†…å®¹
  content TEXT NOT NULL CHECK(length(content) > 0),

  -- å®¡è®¡å­—æ®µ
  created_by INTEGER NOT NULL,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now')),

  -- ä¸šåŠ¡é€»è¾‘çº¦æŸ
  -- L1: render_language å’Œ diagram_type å¿…é¡»ä¸º NULL
  CHECK (
    (prompt_level = 1 AND render_language IS NULL AND diagram_type IS NULL)
    OR prompt_level IN (2, 3)
  ),

  -- L2: render_language å¿…é¡»æœ‰å€¼, diagram_type å¿…é¡»ä¸º NULL
  CHECK (
    (prompt_level = 2 AND render_language IS NOT NULL AND diagram_type IS NULL)
    OR prompt_level IN (1, 3)
  ),

  -- L3: render_language å’Œ diagram_type å¿…é¡»éƒ½æœ‰å€¼
  CHECK (
    (prompt_level = 3 AND render_language IS NOT NULL AND diagram_type IS NOT NULL)
    OR prompt_level IN (1, 2)
  )
);
```

### æ•°æ®ç¤ºä¾‹

```sql
-- L1: é€šç”¨æç¤ºè¯
INSERT INTO custom_prompts (prompt_level, render_language, diagram_type, version, name, content, is_active, created_by)
VALUES (1, NULL, NULL, 'v0', 'å®˜æ–¹é€šç”¨è§„èŒƒ', '...', 1, 0);

-- L2: Mermaid è¯­è¨€è§„èŒƒ
INSERT INTO custom_prompts (prompt_level, render_language, diagram_type, version, name, content, is_active, created_by)
VALUES (2, 'mermaid', NULL, 'v0', 'Mermaid å®˜æ–¹è§„èŒƒ', '...', 1, 0);

-- L3: Mermaid Flowchart ç±»å‹è§„èŒƒ
INSERT INTO custom_prompts (prompt_level, render_language, diagram_type, version, name, content, is_active, created_by)
VALUES (3, 'mermaid', 'flowchart', 'v0', 'Flowchart å®˜æ–¹è§„èŒƒ', '...', 1, 0);

-- ç”¨æˆ·è‡ªå®šä¹‰ç‰ˆæœ¬
INSERT INTO custom_prompts (prompt_level, render_language, diagram_type, version, name, content, is_active, created_by)
VALUES (3, 'mermaid', 'flowchart', 'v1', 'ä¼˜åŒ–ç®­å¤´æ ·å¼', '...', 1, 1);
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. æç¤ºè¯åˆ†å±‚åŸåˆ™

**L1ï¼ˆé€šç”¨å±‚ï¼‰**:
- âœ… æ”¾ç½®é€‚ç”¨äº**æ‰€æœ‰å›¾è¡¨ç±»å‹**çš„é€šç”¨è§„åˆ™
- âœ… ä»»åŠ¡è¯†åˆ«ã€è¾“å‡ºæ ¼å¼ã€AI è¡Œä¸ºå‡†åˆ™
- âŒ é¿å…æ”¾ç½®ç‰¹å®šè¯­è¨€çš„è¯­æ³•ç»†èŠ‚

**L2ï¼ˆè¯­è¨€å±‚ï¼‰**:
- âœ… æ”¾ç½®**æŸç§æ¸²æŸ“è¯­è¨€**çš„é€šç”¨è§„åˆ™
- âœ… ä¿ç•™å…³é”®å­—ã€ç‰¹æ®Šå­—ç¬¦ã€æ³¨é‡Šè¯­æ³•
- âŒ é¿å…æ”¾ç½®ç‰¹å®šå›¾è¡¨ç±»å‹çš„ç»†èŠ‚

**L3ï¼ˆç±»å‹å±‚ï¼‰**:
- âœ… æ”¾ç½®**ç‰¹å®šå›¾è¡¨ç±»å‹**çš„ä¸“ç”¨è§„åˆ™
- âœ… èŠ‚ç‚¹ç±»å‹ã€å¸ƒå±€æ–¹å¼ã€é«˜çº§ç‰¹æ€§
- âŒ é¿å…é‡å¤ L1/L2 å·²æœ‰çš„å†…å®¹

### 2. ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

**ä½•æ—¶åˆ›å»ºæ–°ç‰ˆæœ¬**:
- âœ… å‘ç°è¯­æ³•é”™è¯¯éœ€è¦ä¿®æ­£
- âœ… éœ€è¦æ·»åŠ æ–°çš„è§„åˆ™æˆ–æœ€ä½³å®è·µ
- âœ… ä¼˜åŒ–æç¤ºè¯ä»¥æé«˜ç”Ÿæˆè´¨é‡
- âŒ é¿å…é¢‘ç¹åˆ›å»ºæ— æ„ä¹‰çš„ç‰ˆæœ¬

**ç‰ˆæœ¬å‘½åå»ºè®®**:
```typescript
// å¥½çš„ç‰ˆæœ¬åç§°
"ä¿®æ­£ç®­å¤´è¯­æ³• -> æ”¹ä¸º -->"
"æ·»åŠ å­å›¾ä½¿ç”¨è§„èŒƒ"
"ä¼˜åŒ–èŠ‚ç‚¹å‘½åçº¦å®š"

// ä¸å¥½çš„ç‰ˆæœ¬åç§°
"æ–°ç‰ˆæœ¬"
"æ›´æ–°"
"v2"
```

### 3. åˆæˆä¼˜åŒ–

**ç¼“å­˜ç­–ç•¥**:
```typescript
// å¯ä»¥è€ƒè™‘æ·»åŠ ç¼“å­˜å±‚
const promptCache = new Map<string, string>();

function getCachedPrompt(key: string): string | null {
  return promptCache.get(key) || null;
}

function setCachedPrompt(key: string, value: string): void {
  promptCache.set(key, value);
}
```

**æ€§èƒ½ä¼˜åŒ–**:
- æ•°æ®åº“æŸ¥è¯¢ä½¿ç”¨ç´¢å¼•ï¼ˆ`prompt_level`, `render_language`, `diagram_type`, `is_active`ï¼‰
- L2 å¯é€‰å±‚çš„å¤„ç†è¦é«˜æ•ˆï¼ˆé¿å…ä¸å¿…è¦çš„æ–‡ä»¶è¯»å–ï¼‰
- ä½¿ç”¨äº‹åŠ¡ä¿è¯ç‰ˆæœ¬æ¿€æ´»çš„åŸå­æ€§

---

## ğŸš¨ å¸¸è§é—®é¢˜

### Q1: L2 å±‚å¯é€‰ï¼Œä½•æ—¶éœ€è¦ L2ï¼Ÿ

**ç­”**: å½“æŸç§æ¸²æŸ“è¯­è¨€æœ‰**è·¨æ‰€æœ‰å›¾è¡¨ç±»å‹**çš„é€šç”¨è§„åˆ™æ—¶éœ€è¦ L2ã€‚

ä¾‹å¦‚:
- âœ… Mermaid: æœ‰ä¿ç•™å…³é”®å­—ã€ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰ç­‰é€šç”¨è§„åˆ™ â†’ éœ€è¦ L2
- âŒ Excalidraw: æ¯ç§å›¾è¡¨ç±»å‹çš„è§„åˆ™å·®å¼‚è¾ƒå¤§ â†’ ä¸éœ€è¦ L2

### Q2: ä¸ºä»€ä¹ˆä½¿ç”¨ `---` ä½œä¸ºåˆ†éš”ç¬¦ï¼Ÿ

**ç­”**: 
1. Markdown æ ‡å‡†çš„æ°´å¹³åˆ†éš”çº¿ï¼ŒAI æ¨¡å‹èƒ½å¾ˆå¥½è¯†åˆ«
2. è§†è§‰ä¸Šæ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•å’Œé˜…è¯»
3. ä¸ä¼šä¸ä»»ä½•å›¾è¡¨è¯­è¨€çš„è¯­æ³•å†²çª

### Q3: å¦‚ä½•è°ƒè¯•åˆæˆåçš„æœ€ç»ˆ Promptï¼Ÿ

**ç­”**: åœ¨å¼€å‘ç¯å¢ƒä¸­æ·»åŠ æ—¥å¿—ï¼š

```typescript
if (process.env.NODE_ENV === "development") {
  console.log("=== æœ€ç»ˆ Prompt ===");
  console.log(final_prompt);
  console.log("=== L1 ===");
  console.log(l1_content);
  console.log("=== L2 ===");
  console.log(l2_content);
  console.log("=== L3 ===");
  console.log(l3_content);
}
```

### Q4: ç”¨æˆ·è‡ªå®šä¹‰ç‰ˆæœ¬ä¼šå½±å“å…¶ä»–ç”¨æˆ·å—ï¼Ÿ

**ç­”**: 
- âŒ **å½“å‰è®¾è®¡**: å…¨å±€å…±äº«æ¨¡å¼ï¼Œä¸€ä¸ªç”¨æˆ·çš„ä¿®æ”¹ä¼šå½±å“æ‰€æœ‰ç”¨æˆ·
- âœ… **å¦‚éœ€éš”ç¦»**: å¯ä»¥åœ¨æ•°æ®åº“ä¸­æ¢å¤ `user_id` å­—æ®µï¼Œå®ç°ç”¨æˆ·çº§éš”ç¦»

### Q5: å¦‚ä½•å›é€€åˆ°å®˜æ–¹ç‰ˆæœ¬ï¼Ÿ

**ç­”**: æ¿€æ´» `version = "v0"` çš„æç¤ºè¯ï¼š

```typescript
// 1. æŸ¥æ‰¾å®˜æ–¹ç‰ˆæœ¬
const officialVersion = repo.findVersions(level, language, type)
  .find(v => v.version === 'v0');

// 2. æ¿€æ´»å®˜æ–¹ç‰ˆæœ¬
if (officialVersion) {
  repo.activate(officialVersion.id);
}
```

---

## ğŸ“Š ç³»ç»Ÿç»Ÿè®¡

### æç¤ºè¯æ–‡ä»¶ç»Ÿè®¡

| æ¸²æŸ“è¯­è¨€ | L2 (common.txt) | L3 æ–‡ä»¶æ•°é‡ | æ€»è®¡ |
|---------|----------------|-----------|------|
| mermaid | âœ… | 14 | 15 |
| plantuml | âœ… | 8 | 9 |
| d2 | âœ… | 7 | 8 |
| graphviz | âœ… | 4 | 5 |
| excalidraw | âœ… | 7 | 8 |
| ... | ... | ... | ... |
| **æ€»è®¡** | **21** | **100+** | **120+** |

### æ•°æ®æµç»Ÿè®¡

**æ¯æ¬¡ç”Ÿæˆè¯·æ±‚**:
- æ•°æ®åº“æŸ¥è¯¢: 3 æ¬¡ï¼ˆL1/L2/L3ï¼‰
- æ–‡ä»¶ç³»ç»Ÿè¯»å–: 0-3 æ¬¡ï¼ˆFallback æ—¶ï¼‰
- å­—ç¬¦ä¸²æ‹¼æ¥: 1 æ¬¡
- AI æ¨¡å‹è°ƒç”¨: 1 æ¬¡

**æ€§èƒ½æ•°æ®** (ä¼°ç®—):
- æç¤ºè¯åŠ è½½æ—¶é—´: < 10ms
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´: < 5ms
- æ–‡ä»¶è¯»å–æ—¶é—´: < 5ms (ç¼“å­˜å‘½ä¸­ç‡ 90%+)
- æ€»ä½“å¼€é”€: å¯å¿½ç•¥ï¼ˆç›¸æ¯” AI ç”Ÿæˆæ—¶é—´ï¼‰

---

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æç¤ºè¯å‹ç¼©

**é—®é¢˜**: L1 æç¤ºè¯è¾ƒé•¿ï¼ˆ641 è¡Œï¼‰ï¼Œå¯èƒ½å½±å“ Token ä½¿ç”¨

**æ–¹æ¡ˆ**:
```typescript
// ä½¿ç”¨æœ€å°åŒ–ç‰ˆæœ¬
const l1_minimal = repo.findActive(1, undefined, undefined, { minimal: true });
```

### 2. åŠ¨æ€æç¤ºè¯

**é—®é¢˜**: ä¸åŒå¤æ‚åº¦çš„éœ€æ±‚å¯èƒ½éœ€è¦ä¸åŒè¯¦ç»†ç¨‹åº¦çš„æç¤ºè¯

**æ–¹æ¡ˆ**:
```typescript
// æ ¹æ®ç”¨æˆ·è¾“å…¥å¤æ‚åº¦é€‰æ‹©æç¤ºè¯ç‰ˆæœ¬
function selectPromptVersion(userInput: string): 'minimal' | 'standard' | 'detailed' {
  const complexity = analyzeComplexity(userInput);
  if (complexity < 0.3) return 'minimal';
  if (complexity < 0.7) return 'standard';
  return 'detailed';
}
```

### 3. A/B æµ‹è¯•æ”¯æŒ

**ç›®æ ‡**: å¯¹æ¯”ä¸åŒæç¤ºè¯ç‰ˆæœ¬çš„æ•ˆæœ

**æ–¹æ¡ˆ**:
```typescript
// æ·»åŠ å®éªŒæ ‡è®°
interface CustomPrompt {
  // ... ç°æœ‰å­—æ®µ
  experiment_group?: string; // 'A' | 'B' | 'control'
  success_rate?: number;    // åŸºäºç”¨æˆ·åé¦ˆè®¡ç®—
}
```

### 4. è‡ªåŠ¨ä¼˜åŒ–

**ç›®æ ‡**: åŸºäºå¤±è´¥æ—¥å¿—è‡ªåŠ¨æ”¹è¿›æç¤ºè¯

**æ–¹æ¡ˆ**:
```typescript
// åˆ†æå¤±è´¥æ¨¡å¼
function analyzeFailurePatterns(logs: RenderFailureLog[]): PromptImprovement[] {
  // 1. æå–å¸¸è§é”™è¯¯ç±»å‹
  // 2. è¯†åˆ«æç¤ºè¯ä¸è¶³çš„éƒ¨åˆ†
  // 3. ç”Ÿæˆæ”¹è¿›å»ºè®®
  return improvements;
}
```

---

## ğŸ“ æ€»ç»“

DiagramAI çš„ä¸‰çº§æç¤ºè¯ç³»ç»Ÿæ˜¯ä¸€ä¸ª**æ¨¡å—åŒ–ã€å¯æ‰©å±•ã€ç‰ˆæœ¬å¯æ§**çš„ AI æç¤ºè¯ç®¡ç†æ–¹æ¡ˆï¼š

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **æ¨¡å—åŒ–è®¾è®¡**: L1/L2/L3 å„å¸å…¶èŒï¼Œæ˜“äºç»´æŠ¤  
âœ… **çµæ´»ç»„åˆ**: æ”¯æŒ 100+ ç§å›¾è¡¨ç±»å‹çš„ç²¾ç¡®æ§åˆ¶  
âœ… **ç‰ˆæœ¬ç®¡ç†**: å®Œæ•´çš„ç‰ˆæœ¬å†å²ï¼Œå¯éšæ—¶å›é€€  
âœ… **Fallback æœºåˆ¶**: æ•°æ®åº“ä¼˜å…ˆï¼Œæ–‡ä»¶ç³»ç»Ÿå…œåº•ï¼Œä¿è¯å¯ç”¨æ€§  
âœ… **æ€§èƒ½ä¼˜åŒ–**: æ•°æ®åº“ç´¢å¼• + æ–‡ä»¶ç¼“å­˜ï¼Œå“åº”è¿…é€Ÿ  

### å…³é”®æ•°æ®

- **3** ä¸ªå±‚çº§ï¼ˆL1/L2/L3ï¼‰
- **23** ç§æ¸²æŸ“è¯­è¨€
- **100+** ç§å›¾è¡¨ç±»å‹ç»„åˆ
- **120+** ä¸ªæç¤ºè¯æ–‡ä»¶
- **<10ms** æç¤ºè¯åŠ è½½æ—¶é—´

### æ ¸å¿ƒå…¬å¼

```
æœ€ç»ˆ Prompt = L1 (é€šç”¨) + "---" + L2 (è¯­è¨€) + "---" + L3 (ç±»å‹)
              â†“                    â†“                    â†“
         universal.txt    {language}/common.txt  {language}/{type}.txt
              â†“                    â†“                    â†“
         (æ•°æ®åº“ä¼˜å…ˆ)          (å¯é€‰å±‚)           (å¿…éœ€å±‚)
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-18  
**ç»´æŠ¤è€…**: DiagramAI Team

