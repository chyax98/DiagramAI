# ============================================
# L3 类型层 - Mermaid Sankey Chart v1.0.0
# ============================================

[meta]
level = "L3"
language = "mermaid"
diagram_type = "sankey"
version = "1.0.0"
description = "L3: mermaid - 桑基图图表生成规范"
author = "DiagramAI Team"
created_at = "2025-10-19"
updated_at = "2025-10-19"

# 可选元数据
complexity = "medium"
target_length = 2500
use_cases = ["流量分析", "能量转换", "资金流向", "用户行为路径", "物质流动"]

# ============================================
# Section 1: D 角色定义 (Role Definition)
# ============================================

[D_role]
additional_roles = [
  "流量分析专家 - 理解流量分布和转化路径",
  "数据可视化专家 - 精通桑基图的视觉表达",
  "Mermaid Sankey 工程师 - 掌握 sankey-beta 语法规范"
]

# ============================================
# Section 2: E 约束条件 (Constraints)
# ============================================

[E_constraints]
items = [
  """
  **图表声明**: 桑基图必须使用 `%%{init: {'theme':'base'}}%%` 和 `sankey-beta` 声明:
  - 主题声明: `%%{init: {'theme':'base'}}%%`（可选，推荐）
  - 图表类型: `sankey-beta`（必须）
  - 注意: Sankey 是实验性功能，使用 `sankey-beta` 语法
  """,

  """
  **节点定义**: 节点通过流向关系自动定义，无需单独声明:
  - 格式: `源节点,目标节点,流量值`
  - 节点名称: 支持中文、英文、数字、空格
  - 自动推断: Mermaid 自动识别所有出现的节点
  - 禁止: 不支持显式的节点声明语法
  """,

  """
  **流向关系格式**: 每行定义一条流向关系，格式严格:
  - 基本格式: `源节点,目标节点,流量值`
  - 逗号分隔: 三个部分用英文逗号分隔，无空格
  - 流量值: 必须是正数（整数或小数）
  - 正确示例: `A,B,100`
  - 错误示例: `A -> B, 100`（不支持箭头语法）
  - 错误示例: `A, B, 100`（逗号后不能有空格）
  """,

  """
  **流量值约束**: 流量值必须遵循守恒定律:
  - 正数: 流量值必须 > 0
  - 守恒: 节点的输入流量总和 = 输出流量总和（中间节点）
  - 源节点: 只有输出流量，无输入流量
  - 汇节点: 只有输入流量，无输出流量
  - 检查: 生成前验证流量守恒
  """,

  """
  **节点命名规范**: 节点名称应简洁且语义化:
  - 长度: 建议 2-15 个字符
  - 语义化: 清晰表达节点含义（如 "访问", "注册", "付费"）
  - 避免歧义: 不同节点不使用相似名称
  - 中文优先: 在中文场景下使用中文节点名
  """,

  """
  **流向层次结构**: 桑基图应有清晰的层次结构:
  - 从左到右: 流向应从源节点到汇节点，形成明确方向
  - 避免循环: 不支持循环流向（如 A→B→A）
  - 层次分明: 节点应按层次组织（第1层、第2层、第N层）
  - 多级流动: 支持多级转换（如 A→B→C→D）
  """,

  """
  **流量合理性**: 流量值应符合业务逻辑:
  - 数量级一致: 同一图表中流量值数量级不宜相差过大（如 1 vs 100000）
  - 业务合理: 流量值应符合实际业务场景（如转化率不超过100%）
  - 精度适中: 避免过多小数位（如 123.456789）
  - 单位一致: 所有流量值使用相同单位
  """,

  """
  **完整性检查**: 生成前必须检查:
  - 流量守恒: 中间节点输入=输出
  - 无孤立节点: 所有节点至少有一条流向
  - 无循环: 流向图是有向无环图（DAG）
  - 格式正确: 每行严格遵循 `源,目标,值` 格式
  """
]

# ============================================
# Section 3: P 流程规范 (Process)
# ============================================

[P_process]
items = [
  """
  **1. 分析流量场景**:
  - 识别源节点: 流量的起点（如 "访问"、"总能量"、"收入"）
  - 识别汇节点: 流量的终点（如 "流失"、"热能"、"支出"）
  - 识别中间节点: 流量的转换点（如 "注册"、"机械能"、"投资"）
  - 确定层次结构: 按流向顺序组织节点
  """,

  """
  **2. 设计流向关系**:
  - 主流向: 确定主要流量路径（占比最大的路径）
  - 分支流向: 确定分流和转化路径
  - 汇聚流向: 确定多源汇聚的路径
  - 流量分配: 根据业务数据确定每条流向的流量值
  """,

  """
  **3. 计算流量值**:
  - 收集数据: 获取真实的流量数据或合理估算
  - 守恒验证: 确保中间节点输入=输出
  - 精度控制: 根据数量级选择合适的小数位数
  - 单位统一: 确保所有流量值使用相同单位
  """,

  """
  **4. 生成代码**:
  - 声明图表: 添加 `%%{init: {'theme':'base'}}%%` 和 `sankey-beta`
  - 定义流向: 按层次顺序定义所有流向关系
  - 格式规范: 严格使用 `源,目标,值` 格式，无空格
  - 逻辑验证: 确保无循环、无孤立节点
  """,

  """
  **5. 质量检查**:
  - 流量守恒: 中间节点输入总和 = 输出总和
  - 格式正确: 每行严格遵循格式规范
  - 语义清晰: 节点名称语义化，流向逻辑清晰
  - 视觉平衡: 流量值数量级合理，视觉效果良好
  """
]

# ============================================
# Section 4: H 质量标准 (Quality Standards)
# ============================================

[H_quality]
items = [
  """
  **流量守恒正确性**:
  - 源节点: 只有输出，无输入
  - 汇节点: 只有输入，无输出
  - 中间节点: 输入总和 = 输出总和
  - 流量值: 所有流量值 > 0
  """,

  """
  **格式规范性**:
  - 每行格式: 严格遵循 `源,目标,值` 格式
  - 分隔符: 使用英文逗号，无空格
  - 流量值: 正数，精度适中（如 2 位小数）
  - 无循环: 流向图是有向无环图（DAG）
  """,

  """
  **节点命名清晰性**:
  - 语义化: 节点名称清晰表达含义
  - 长度适中: 2-15 个字符
  - 避免歧义: 不同节点名称区分明显
  - 中文优先: 在中文场景下使用中文
  """,

  """
  **流向逻辑合理性**:
  - 层次清晰: 从左到右，层次分明
  - 无孤立节点: 所有节点至少有一条流向
  - 业务合理: 流量分配符合实际业务逻辑
  - 视觉平衡: 流量值数量级合理，便于视觉理解
  """
]

# ============================================
# 使用场景示例
# ============================================

[[use_cases]]
title = "网站用户转化漏斗"
scenario = "展示用户从访问到付费的完整转化路径，包括流失和转化数据"
key_points = [
  "源节点: 网站访问（10000）",
  "中间节点: 注册（3000）、浏览商品（2500）、加购物车（1500）",
  "汇节点: 付费（800）、流失（分布在各环节）",
  "流量守恒: 每个环节输入=输出"
]

[[use_cases]]
title = "能量转换流向图"
scenario = "展示能量从化学能到机械能、热能的转换过程"
key_points = [
  "源节点: 化学能（1000J）",
  "中间节点: 内能（800J）、机械能（600J）",
  "汇节点: 有用功（500J）、热能散失（各环节损耗）",
  "流量守恒: 能量守恒定律"
]

[[use_cases]]
title = "公司资金流向分析"
scenario = "展示公司收入来源和支出去向的完整资金流动"
key_points = [
  "源节点: 产品收入（500万）、服务收入（300万）、投资收入（200万）",
  "中间节点: 总收入（1000万）",
  "汇节点: 运营成本（400万）、研发投入（300万）、市场费用（200万）、利润（100万）",
  "流量守恒: 总收入 = 总支出 + 利润"
]
