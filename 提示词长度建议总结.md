# 提示词长度建议总结

> 创建时间: 2025-10-18  
> 目的: 为 DiagramAI 三级提示词系统明确长度范围，优化成本和性能

---

## 📊 当前状况

### 实测数据

```
当前提示词大小（以 Mermaid Flowchart 为例）：

L1 (universal.txt):        18,318 字符 ≈ 4,500 tokens
L2 (mermaid/common.txt):    3,915 字符 ≈ 1,000 tokens
L3 (mermaid/flowchart.txt): 14,469 字符 ≈ 3,600 tokens
───────────────────────────────────────────────────
合计:                      36,702 字符 ≈ 9,100 tokens

所有提示词文件总大小: 226 KB

问题：
⚠️ 超出推荐长度 4-5 倍
⚠️ 成本过高（$0.273/次请求，GPT-4）
⚠️ 响应时间慢（2-3 秒）
⚠️ 可能超出小模型上下文窗口
```

---

## 🎯 推荐的长度范围

### 目标 Token 分配（基于 2025 最佳实践）

```
总目标: 2,000 tokens（8,000-9,000 字符）

三级分配：
┌─────────────┬──────────┬──────────┬────────┐
│    层级     │ 字符数   │  Tokens  │  占比  │
├─────────────┼──────────┼──────────┼────────┤
│ L1 通用层   │ 3,200    │   800    │  40%   │
│ L2 语言层   │ 1,600    │   400    │  20%   │
│ L3 类型层   │ 3,200    │   800    │  40%   │
├─────────────┼──────────┼──────────┼────────┤
│   合计      │ 8,000    │  2,000   │ 100%   │
└─────────────┴──────────┴──────────┴────────┘

需要压缩：
L1: 18,318 → 3,200 字符 (压缩 82%)
L2:  3,915 → 1,600 字符 (压缩 59%)
L3: 14,469 → 3,200 字符 (压缩 78%)
```

### 为什么是 2,000 tokens？

1. **行业标准**: 复杂任务推荐 500-2,000 tokens
2. **模型兼容**: 适配 4K 上下文的小模型
3. **成本效益**: 78% 成本节省
4. **性能提升**: 60% 响应速度提升
5. **注意力聚焦**: 模型更容易抓住重点

---

## 📋 三级提示词的明确范围界定

### L1: 通用规范层

**目标**: 3,200 字符 (800 tokens)

**保留内容**（按优先级）：

```
优先级 1 - 必须保留 (40%，320 tokens):
├─ 任务识别指令
│   • GENERATE_NEW_DIAGRAM
│   • ADJUST_EXISTING_DIAGRAM
│   • FIX_SYNTAX_ERRORS_ONLY
│   保留: 200-300 字
│
├─ 输出格式要求
│   • 纯代码输出
│   • 无 Markdown 包装
│   • 无注释和解释
│   保留: 50-100 字
│
└─ 专家视角定义
    • 需求分析专家
    • 图表设计师
    • 代码生成工程师
    保留: 100-150 字

优先级 2 - 重点保留 (40%，320 tokens):
├─ 核心原则
│   • 准确性优先
│   • 简洁清晰
│   • 中文优先
│   • 完整性保证
│   保留: 每条 50-80 字
│
└─ 通用输出规范
    • 代码格式
    • 错误处理
    保留: 100-150 字

优先级 3 - 选择性保留 (20%，160 tokens):
├─ 质量标准精简版
│   保留: 100-150 字
│
└─ 关键注意事项
    保留: 50-100 字

❌ 删除内容:
├─ 过于详细的示例（每个规则只保留 1 个最典型的）
├─ 重复的说明
├─ 过长的列表（只保留 Top 3-5）
├─ 过于具体的语言语法（移到 L2）
└─ 特定图表类型的细节（移到 L3）
```

---

### L2: 语言规范层

**目标**: 1,600 字符 (400 tokens)

**保留内容**（按优先级）：

```
优先级 1 - 必须保留 (50%，200 tokens):
├─ 保留关键字列表
│   • 一行列出，逗号分隔
│   • 示例: "graph, subgraph, end, ..."
│   保留: 50-100 字
│
├─ 特殊字符转义规则
│   • 哪些字符需要转义
│   • 如何转义
│   保留: 50-100 字
│
└─ 注释语法
    • 单行/多行注释
    保留: 30-50 字

优先级 2 - 重点保留 (35%，140 tokens):
├─ 语言强制规则 (Top 3-5)
│   • 每条: 错误示例 + 正确示例
│   保留: 每条 30-50 字
│
└─ 命名约定
    保留: 30-50 字

优先级 3 - 选择性保留 (15%，60 tokens):
└─ 最佳实践 (Top 2-3)
    保留: 50-80 字

❌ 删除内容:
├─ 过长的最佳实践列表（只保留 Top 3）
├─ 详细的语法教程
├─ 过多的示例代码（每个规则 1 个示例）
├─ 历史版本兼容性说明
└─ 与 L1 重复的内容
```

---

### L3: 类型规范层

**目标**: 3,200 字符 (800 tokens)

**保留内容**（按优先级）：

```
优先级 1 - 必须保留 (45%，360 tokens):
├─ 专家视角（精简版）
│   • 2-3 个专家角色
│   • 每个 1 句话描述
│   保留: 50-80 字
│
├─ 核心语法结构
│   • 图表声明方式
│   • 基础节点类型（5-8 种最常用）
│   • 连接方式（3-5 种最常用）
│   保留: 150-200 字
│
└─ 布局方向
    • 支持的方向
    • 何时使用
    保留: 50-80 字

优先级 2 - 重点保留 (35%，280 tokens):
├─ 最佳实践 (Top 5-7)
│   • 每条: 1 句话 + 1 个简短示例
│   保留: 每条 30-50 字
│
└─ 常见错误 (Top 3-5)
    • 错误示例 + 正确示例
    保留: 每条 20-30 字

优先级 3 - 选择性保留 (20%，160 tokens):
├─ 高级特性 (Top 2-3)
│   • 子图、样式定制
│   保留: 每个 30-50 字
│
└─ 样式建议
    保留: 30-50 字

❌ 删除内容:
├─ 详细的语法教程
├─ 所有节点类型的完整列表（只保留最常用的）
├─ 过多的高级特性（只保留 Top 2-3）
├─ 冗长的示例代码
├─ 边缘情况处理
└─ 与 L1/L2 重复的内容
```

---

## 💰 预期优化效果

### Token 和成本对比

| 项目                     | 优化前  | 优化后  | 改进            |
| ------------------------ | ------- | ------- | --------------- |
| **Token 总数**           | 9,100   | 2,000   | ↓ 78%           |
| **单次请求成本** (GPT-4) | $0.273  | $0.060  | ↓ 78%           |
| **响应时间**             | 2.5s    | 1.0s    | ↑ 60%           |
| **月度成本** (30K 请求)  | $8,190  | $1,800  | 节省 $6,390     |
| **年度成本**             | $98,280 | $21,600 | 节省 $76,680 💰 |

### 性能提升

```
生成速度: 2.5s → 1.0s (提升 60%)
首次 Token 时间: 800ms → 300ms (提升 62%)
并发能力: 100 QPM → 455 QPM (提升 355%)
模型注意力: 分散 → 聚焦 (质量提升)
```

---

## 🔧 压缩技巧示例

### 技巧 1: 合并相似内容

**变更前** (200 字):

```
### 规则 1: 避免使用保留关键字
不要使用保留关键字作为节点 ID。保留关键字包括 graph, subgraph, end 等。

### 规则 2: 不要使用系统关键字
系统关键字如 class, style, click 也不能作为节点 ID。
```

**变更后** (50 字):

```
### 保留关键字禁用
不可作为节点 ID: graph, subgraph, end, class, style, click
```

节省: 150 字 (75% 压缩) ✅

---

### 技巧 2: 列表精简化

**变更前** (300 字):

```
### 节点类型
1. 矩形节点: A[文本]
2. 圆角矩形: B(文本)
3. 圆形: C((文本))
... (共 10 种)
```

**变更后** (80 字):

```
### 节点类型 (Top 5)
矩形: A[文本] | 圆角: B(文本) | 圆形: C((文本)) | 菱形: D{文本} | 六边形: E{{文本}}
```

节省: 220 字 (73% 压缩) ✅

---

### 技巧 3: 示例最小化

**变更前** (400 字):

````
### 错误示例 1
```mermaid
graph TD
    end --> start
````

这段代码会报错...

### 正确写法 1

```mermaid
graph TD
    finish[结束] --> start[开始]
```

将 'end' 改为 'finish'...

```

**变更后** (80 字):
```

### 常见错误

❌ end --> start (保留关键字) ✅ finish[结束] --> start[开始]

```

节省: 320 字 (80% 压缩) ✅

---

## 🚀 实施建议

### 分阶段优化

```

阶段 1: L1 通用层优化 (优先级最高)
└─ 影响所有图表，优化收益最大
└─ 预计节省 3,700 tokens (41% 总成本)

阶段 2: L3 类型层优化 (优先级第二)
└─ 影响单个图表类型
└─ 预计节省 2,800 tokens (31% 总成本)

阶段 3: L2 语言层优化 (优先级第三)
└─ 影响单个语言的所有类型
└─ 预计节省 600 tokens (7% 总成本)

阶段 4: A/B 测试和调优
└─ 对比优化前后效果
└─ 确保质量不下降

```

### 质量保证

```

每次优化后必须测试:
├─ 生成成功率（不能下降 > 5%）
├─ 语法错误率（不能上升 > 10%）
├─ 用户满意度（持平或提升）
└─ 响应时间（提升 > 50%）

不符合标准 → 立即回滚

```

---

## 📚 相关文档

- **提示词长度优化指南.md** - 详细的优化策略和实施计划
- **三级提示词功能分析.md** - 系统架构和代码实现
- **三级提示词合成示例.md** - 实际案例和效果对比

---

## ✅ 行动清单

### 立即执行

- [ ] 阅读 **提示词长度优化指南.md**
- [ ] 备份所有原始提示词文件
- [ ] 记录当前生成成功率基线

### 短期目标（1-2 周）

- [ ] 优化 L1 通用层（压缩到 3,200 字符）
- [ ] 创建 A/B 测试环境
- [ ] 测试优化版本效果

### 中期目标（1 个月）

- [ ] 优化所有 L3 类型层
- [ ] 优化所有 L2 语言层
- [ ] 全面切换到优化版本

### 长期维护

- [ ] 每季度审查提示词长度
- [ ] 根据失败日志持续优化
- [ ] 定期更新最佳实践

---

## 💡 核心要点

```

1. 当前提示词过长: 9,100 tokens → 目标 2,000 tokens
2. 需要压缩 78%，保留最核心的 20% 内容
3. 预期节省成本 78%，提升性能 60%
4. 优先优化 L1，影响最大
5. 每次优化后必须 A/B 测试验证效果

```

---

**创建时间**: 2025-10-18
**维护者**: DiagramAI Team
**版本**: 1.0
**状态**: ⚠️ 待优化

```
