# RackDiag Prompt 系统审查报告

**语言**: RackDiag
**文件位置**: `/root/Diagram/DiagramAI/src/lib/constants/prompts/rackdiag/`
**审查日期**: 2025-10-13
**审查范围**: L2 (common.txt) + L3 (datacenter.txt, rack.txt)

---

## 📊 文件清单

| 文件 | 类型 | 行数 | 功能 |
|------|------|------|------|
| `common.txt` | L2 通用规范 | 290 行 | RackDiag 语法基础 (最长的 L2) |
| `datacenter.txt` | L3 图表类型 | 244 行 | 数据中心机柜布局 (多机柜) |
| `rack.txt` | L3 图表类型 | 253 行 | 单机柜设备布局 (42U) |

**总计**: 787 行

---

## ✅ 优点分析

### 1. L2 通用规范极其详细

**强制规则覆盖全面** (5 个规则,是所有语言中最多的):
- ✅ 规则 1: `rackdiag {}` 图表声明
- ✅ 规则 2: **U 位范围 1-42** - RackDiag 特有硬性约束
- ✅ 规则 3: **多 U 设备必须使用 `[2U]` 标记** - 防止空间冲突
- ✅ 规则 4: **多 U 设备不能导致 U 位重叠** - 逻辑校验
- ✅ 规则 5: 中文描述必须使用双引号

**核心语法详细** (第 142-220 行):
- 设备定义、多 U 设备标记、设备属性
- **常用设备类型和 U 位占用表格** - 非常实用
  - UPS (2-3U), Switch (1U), Blade Server (10U), Storage Array (4U)
- **U 位计算规则清晰**: `[2U]` 占用当前 U 位及上面 1 个 U 位

**常见错误覆盖完整** (第 221-273 行,3 个错误):
- 错误 1: U 位超出 42 范围
- 错误 2: 多 U 设备未标记
- 错误 3: U 位重叠

---

### 2. L3 文件类型区分明确

**datacenter.txt (多机柜数据中心)**:
- ✅ 强调 **冗余配置**: 双 UPS、双 PDU、双交换机、双存储
- ✅ 强调 **分区规划**: 电源→网络→计算→存储→管理分层
- ✅ 强调 **散热优化**: 避免高功耗设备集中
- ✅ 3 个示例: 企业级标准机柜、云服务商高密度机柜、金融级强冗余机柜

**rack.txt (单机柜设备布局)**:
- ✅ 强调 **U 位规划**: 从底部 (U1) 到顶部 (U42)
- ✅ 强调 **设备分层**: 电源底部、网络中部、管理顶部
- ✅ 强调 **重量分布**: 重设备底部,轻设备上部
- ✅ 3 个示例: Web 服务器机架、高密度计算机架、存储专用机架

**类型区分清晰度**: 9/10 - DataCenter 强调冗余和架构,Rack 强调 U 位规划

---

## ⚠️ 问题与改进建议

### 问题 1: RackDiag 依赖 NwDiag 的 L2 文件 (与 PacketDiag 相同问题)

**严重问题**: RackDiag 有独立的 L2 文件 (`common.txt` 290 行),但 NwDiag 的 L2 文件也提到了 RackDiag

**证据**: `/prompts/nwdiag/common.txt` 第 138-152 行提到:
```markdown
### 1. 图表声明
```
nwdiag {}
rackdiag {}
packetdiag {}
```
```

**当前 RackDiag 的 L2**: 290 行,内容完整且独立,**但与 NwDiag 系列共用设计不一致**

**改进建议**:
- 删除 NwDiag L2 中关于 RackDiag 的内容
- 明确 RackDiag 有独立的 L2 文件,不依赖 NwDiag

---

### 问题 2: datacenter.txt 和 rack.txt 的差异不够明确

**当前问题**:
- 两者都使用 `rackdiag {}` 声明
- 两者的语法完全相同
- 差异仅在于 "设计原则" 和 "应用场景"

**改进建议**:
```markdown
## 在 datacenter.txt 开头添加
> **DataCenter vs Rack 的核心区别**
> - **DataCenter**: 关注整体架构、冗余设计、扩展能力
>   - 适用场景: 企业级数据中心、云服务商机柜、金融级机房
>   - 设计重点: N+1 冗余、分区规划、散热优化、扩展预留 15-20%
> - **Rack**: 关注单机柜设备布局、U 位规划、线缆管理
>   - 适用场景: 部门级服务器机柜、实验室设备机架、存储专用机柜
>   - 设计重点: 设备分层、重量分布、散热考虑

## 在 rack.txt 开头添加
> **何时使用 Rack 而非 DataCenter**
> - 仅规划单个机柜的设备布局
> - 不涉及跨机柜冗余设计
> - 关注 U 位空间利用率而非系统高可用性
```

---

### 问题 3: L2 过长,包含过多 L3 特有内容

**问题严重性**: 🟡 中等

**当前 L2 长度**: 290 行 (是所有语言中最长的)

**包含的 L3 内容**:
- 第 176-181 行: **常用设备类型和 U 位占用表格** - 应该放在 rack.txt
- 第 192-204 行: **U 位计算规则和示例** - 应该放在 rack.txt
- 第 207-220 行: **设备属性详细说明** - 应该放在 rack.txt

**改进建议**:
```markdown
## L2 应该保留的内容 (缩减到约 150 行)
- 强制规则 (5 个,必须保留)
- 专家视角 (简化版本)
- 基础语法 (图表声明、设备定义、多 U 标记)
- 常见错误 (3 个,必须保留)
- 生成检查清单 (通用版本)

## L3 应该包含的内容
### rack.txt
- 常用设备类型表格
- U 位计算规则详细说明
- 设备分层原则
- 设计原则 (4 个)

### datacenter.txt
- 冗余配置原则
- 分区规划原则
- 散热优化原则
- 扩展预留原则
```

---

### 问题 4: 缺少机柜类型的说明

**发现**: RackDiag 支持哪些机柜类型?
- 标准 42U 机柜 (默认)
- 非标准机柜 (如 24U、36U、48U) ?

**当前文件**: 仅提到 "标准 42U 机柜",未说明是否支持其他高度

**改进建议**:
```markdown
## 在 L2 (common.txt) 中添加
### 机柜类型支持
- **标准机柜**: 42U (默认,推荐使用)
- **非标准机柜**: 24U、36U、48U (需在图表声明中指定高度)
  - 语法: `rackdiag { height = 24; ... }`
  - 如果不支持,明确说明: "RackDiag 仅支持 42U 标准机柜"
```

---

## 📈 量化评分

| 评估维度 | 得分 | 说明 |
|---------|------|------|
| **L2 覆盖度** | 10/10 | 规则最完整,设备类型表格实用 |
| **L3 示例质量** | 9/10 | 示例专业,覆盖真实数据中心场景 |
| **错误预防** | 10/10 | 5 个强制规则,覆盖所有关键错误 |
| **内容去重** | 6/10 | L2 过长,包含过多 L3 特有内容 |
| **类型特异性** | 8/10 | DataCenter 和 Rack 区分较清晰 |
| **可维护性** | 7/10 | L2 过长,不易维护 |
| **总体评分** | **8.3/10** | 优秀,但 L2 需要精简 |

---

## 🎯 优先改进建议

### 高优先级 (P0)
1. **精简 L2,将设备类型表格和 U 位计算规则移到 rack.txt** - 减少 L2 长度约 40%
2. **明确 RackDiag 不依赖 NwDiag 的 L2** - 删除 NwDiag L2 中的 RackDiag 内容

### 中优先级 (P1)
3. **在两个 L3 文件开头添加 DataCenter vs Rack 区别说明** - 增强类型区分
4. **明确是否支持非标准机柜 (非 42U)** - 避免用户尝试不支持的语法

---

## 📝 总结

**RackDiag Prompt 系统整体质量优秀**,**L2 规则最完整,错误预防最全面**。但 **L2 过长 (290 行),包含过多 L3 特有内容**,建议精简 L2,将设备类型表格和 U 位计算规则移到 rack.txt。

**DataCenter 和 Rack 的类型区分较清晰**,但可以进一步增强。建议在两个 L3 文件开头添加明确的区别说明。
