# Prompt 三层架构审查报告

**审查日期**: 2025-10-13
**审查范围**: Excalidraw, Vega-Lite, DBML, BPMN 四种渲染语言
**审查标准**: 三层架构规范 (L1 + L2 + L3)

---

## 📋 执行摘要

本次审查严格按照 DiagramAI 的三层 Prompt 架构规范,对 4 种渲染语言的文件结构、类型对齐和层级职责进行了全面检查。

### ✅ 总体结论

**4 种语言全部通过审查**,符合三层架构规范要求:
- ✅ 类型定义与 Prompt 文件 100% 对齐
- ✅ 目录结构完整 (L1 + L2 + L3)
- ✅ 层级职责划分清晰
- ✅ 无冗余或缺失文件

---

## 🏗️ 三层架构规范回顾

### 架构设计

```
L1: universal.txt (18,336 bytes)
    → 所有图表共享的通用规范
    → 任务类型识别 (GENERATE/ADJUST/FIX)
    → 输出格式要求

L2: {language}/common.txt
    → 每种语言的通用规范
    → 强制规则、基础语法、命名规范
    → 常见错误和最佳实践

L3: {language}/{type}.txt
    → 特定图表类型的规范
    → 专家视角、生成要求、示例代码
    → 必须与前端类型定义对齐
```

### Prompt 构建逻辑

```typescript
最终 Prompt = L1 + "---" + L2 + "---" + L3
```

---

## 📊 审查结果详情

### 1. Excalidraw (手绘风格图表)

#### ✅ 类型对齐检查
- **前端定义**: 5 种图表类型
- **L3 文件数**: 5 个
- **对齐状态**: ✅ 完全对齐

| 前端类型 | L3 文件 | 文件大小 | 状态 |
|---------|---------|----------|------|
| sketch | sketch.txt | 15,461 bytes | ✅ |
| wireframe | wireframe.txt | 22,741 bytes | ✅ |
| diagram | diagram.txt | 21,462 bytes | ✅ |
| flowchart | flowchart.txt | 57,655 bytes | ✅ |
| architecture | architecture.txt | 31,964 bytes | ✅ |

#### ✅ 目录结构检查
- ✅ L2 层: `common.txt` 存在 (8,185 bytes)
- ✅ L3 层: 5 个图表类型文件
- ✅ 无冗余文件

#### ✅ 层级职责检查

**L2 (common.txt)**:
- ✅ 强制规则 (6 条): 顶层 JSON 结构、位置尺寸、ID 唯一性、JSON 格式、箭头绑定
- ✅ 基础语法: 核心元素类型、必需属性、样式属性
- ✅ 命名规范: 元素 ID、颜色规范
- ✅ 常见错误: 6 种致命错误及修复方法
- ✅ Kroki 兼容性要求

**L3 (sketch.txt 示例)**:
- ✅ 专家视角: 创意设计师 + JSON 工程师 + 用户体验专家
- ✅ 核心语法: 手绘风格特定的形状元素
- ✅ 常见错误: 特定于草图的错误模式
- ❌ 无强制规则重复 (已在 L2 定义)

---

### 2. Vega-Lite (数据可视化)

#### ✅ 类型对齐检查
- **前端定义**: 6 种图表类型
- **L3 文件数**: 6 个 (不含 expert-guide.txt)
- **对齐状态**: ✅ 完全对齐

| 前端类型 | L3 文件 | 文件大小 | 状态 |
|---------|---------|----------|------|
| bar | bar.txt | 9,133 bytes | ✅ |
| line | line.txt | 10,295 bytes | ✅ |
| point | point.txt | 9,870 bytes | ✅ |
| area | area.txt | 10,558 bytes | ✅ |
| pie | pie.txt | 9,423 bytes | ✅ |
| heatmap | heatmap.txt | 11,093 bytes | ✅ |

#### ✅ 目录结构检查
- ✅ L2 层: `common.txt` 存在 (11,836 bytes)
- ✅ L3 层: 6 个图表类型文件
- ℹ️ 额外文件: `expert-guide.txt` (32,140 bytes)
  - **定位**: 独立参考手册,不参与 Prompt 组合
  - **用途**: 开发者学习和深度查阅
  - **说明**: 文件头部已明确标注 "不应直接用于 prompt 组合"

#### ✅ 层级职责检查

**L2 (common.txt)**:
- ✅ 强制规则 (4 条): $schema 声明、data.values 格式、encoding 必需字段、mark 类型
- ✅ 基础语法: JSON 结构、核心概念 (数据类型、标记类型、编码通道)
- ✅ 命名规范: 字段名、描述文本
- ✅ 常见错误: 5 种致命错误及修复方法

**L3 (bar.txt 示例)**:
- ✅ 专家视角: 数据可视化专家 + JSON 工程师 + 代码质量审查员
- ✅ 核心语法: 柱状图特定的配置选项 (简单、分组、堆叠、水平)
- ✅ 常见错误: 特定于柱状图的错误模式
- ❌ 无强制规则重复 (已在 L2 定义)

---

### 3. DBML (数据库 ER 图)

#### ✅ 类型对齐检查
- **前端定义**: 4 种图表类型
- **L3 文件数**: 4 个
- **对齐状态**: ✅ 完全对齐

| 前端类型 | L3 文件 | 文件大小 | 状态 |
|---------|---------|----------|------|
| schema | schema.txt | 12,255 bytes | ✅ |
| single_table | single_table.txt | 11,285 bytes | ✅ |
| erd | erd.txt | 12,240 bytes | ✅ |
| migration | migration.txt | 13,570 bytes | ✅ |

#### ✅ 目录结构检查
- ✅ L2 层: `common.txt` 存在 (11,846 bytes)
- ✅ L3 层: 4 个图表类型文件
- ✅ 无冗余文件

#### ✅ 层级职责检查

**L2 (common.txt)**:
- ✅ 强制规则 (6 条): Table 关键字大小写、类型参数、关系箭头方向、引用完整性、主键约束、字段类型规范
- ✅ 基础语法: 表定义、字段类型、约束、关系、索引、枚举
- ✅ 命名规范: 表名、字段名、枚举命名
- ✅ 常见错误: 6 种致命错误及修复方法
- ✅ 最佳实践: 表设计、关系设计、索引策略、数据类型选择

**L3 (schema.txt 示例)**:
- ✅ 专家视角: 数据库架构师 + DBML 工程师 + 数据建模专家
- ✅ 核心语法: 完整 Schema 的设计要求 (多表关系、规范化)
- ✅ 常见错误: 特定于完整 Schema 的错误模式
- ❌ 无强制规则重复 (已在 L2 定义)

---

### 4. BPMN (业务流程建模)

#### ✅ 类型对齐检查
- **前端定义**: 1 种图表类型
- **L3 文件数**: 1 个
- **对齐状态**: ✅ 完全对齐

| 前端类型 | L3 文件 | 文件大小 | 状态 |
|---------|---------|----------|------|
| process | process.txt | 38,579 bytes | ✅ |

#### ✅ 目录结构检查
- ✅ L2 层: `common.txt` 存在 (11,945 bytes)
- ✅ L3 层: 1 个图表类型文件
- ✅ 无冗余文件

#### ✅ 层级职责检查

**L2 (common.txt)**:
- ✅ 角色定义: BPMN 2.0 业务流程建模专家
- ✅ 强制规则 (6 条): XML 声明和命名空间、ID 全局唯一性、sourceRef/targetRef 精确匹配、网关条件表达式、XML 特殊字符转义、输入输出流定义
- ✅ 基础语法: XML 结构、流程容器、泳道、事件、任务、网关、序列流、消息流
- ✅ 命名规范: ID 命名、名称命名、流程 ID、协作 ID
- ✅ 最佳实践: 9 条规范 (XML 声明、ID 唯一性、流程连接、网关条件等)

**L3 (process.txt)**:
- ✅ 专家视角: 业务流程分析师 + BPMN 2.0 标准工程师 + 流程质量保证专家
- ✅ 核心语法: 业务流程特定的 XML 结构、协作流程、泳道设计
- ✅ 常见错误: 特定于业务流程的错误模式
- ✅ 最佳实践: 流程设计的高级指导
- ❌ 无强制规则重复 (已在 L2 定义)

**⚠️ 特殊发现**:
- BPMN 的 L2 文件包含了角色定义,这在其他语言中通常放在 L3
- 原因: BPMN 只有 1 种图表类型,角色定义放在 L2 更合理
- 结论: 符合实际业务需求,无需调整

---

## 📈 统计数据汇总

### 文件数量统计

| 语言 | L1 | L2 | L3 | 额外文件 | 总计 |
|------|----|----|----|---------|----- |
| L1 (universal.txt) | 1 | - | - | - | 1 |
| Excalidraw | - | 1 | 5 | 0 | 6 |
| Vega-Lite | - | 1 | 6 | 1 (参考手册) | 8 |
| DBML | - | 1 | 4 | 0 | 5 |
| BPMN | - | 1 | 1 | 0 | 2 |
| **总计** | 1 | 4 | 16 | 1 | 22 |

### 文件大小统计

| 语言 | L2 大小 | L3 总大小 | 平均 L3 大小 |
|------|---------|-----------|-------------|
| Excalidraw | 8,185 bytes | 149,283 bytes | 29,857 bytes |
| Vega-Lite | 11,836 bytes | 60,372 bytes | 10,062 bytes |
| DBML | 11,846 bytes | 49,350 bytes | 12,338 bytes |
| BPMN | 11,945 bytes | 38,579 bytes | 38,579 bytes |

### Token 预估

基于 1 token ≈ 4 字符的比例:

| 层级 | 总大小 | 预估 Token |
|------|--------|-----------|
| L1 (universal.txt) | 18,336 bytes | ~4,584 tokens |
| L2 (4 个 common.txt) | 43,812 bytes | ~10,953 tokens |
| L3 (16 个文件) | 297,584 bytes | ~74,396 tokens |
| **总计** | 359,732 bytes | ~89,933 tokens |

---

## ✅ 审查结论

### 全面通过项

1. ✅ **类型对齐**: 所有 4 种语言的前端定义与 L3 文件 100% 对齐
2. ✅ **目录结构**: 所有语言都包含完整的 L1 + L2 + L3 结构
3. ✅ **层级职责**:
   - L1 负责通用任务识别和输出规范
   - L2 负责语言特定的强制规则和基础语法
   - L3 负责图表类型特定的专家视角和生成要求
4. ✅ **无冗余文件**: 除 Vega-Lite 的 expert-guide.txt (已明确标注为参考手册)
5. ✅ **无缺失文件**: 所有前端定义的类型都有对应的 L3 文件

### 特殊说明

1. **Vega-Lite expert-guide.txt**:
   - 定位: 独立参考手册,供开发者学习和深度查阅
   - 不参与 Prompt 三层组合 (L1 + L2 + L3)
   - 文件头部已明确说明用途和使用场景
   - 结论: 符合规范,无需调整

2. **BPMN 的角色定义在 L2**:
   - 原因: BPMN 只有 1 种图表类型 (process)
   - 将角色定义放在 L2 更合理,避免重复
   - 结论: 符合实际业务需求,无需调整

---

## 🎯 最佳实践总结

### 维护规则

1. **添加新图表类型**:
   - ✅ 先创建 `prompts/{language}/{type}.txt` 文件
   - ✅ 然后在 `LANGUAGE_DIAGRAM_TYPES` 添加对应类型定义
   - ✅ 验证三方对齐: 前端定义 ↔ L3 文件

2. **删除图表类型**:
   - ✅ 先从 `LANGUAGE_DIAGRAM_TYPES` 移除类型定义
   - ✅ 然后删除或重命名 `prompts/{language}/{type}.txt`
   - ⚠️ 保留有价值的 prompt 内容,避免误删

3. **重命名图表类型**:
   - ✅ 同时修改前端定义和 prompt 文件名
   - ✅ 更新 `RENDER_LANGUAGES` 的图表数量描述

### 常见错误预防

- ❌ 前端定义了类型但没有对应 prompt 文件
- ❌ 存在 prompt 文件但前端没有定义 (用户无法选择)
- ❌ 复制粘贴导致把其他语言的类型混进来
- ❌ L2 和 L3 职责混淆,导致内容重复

### 历史教训 (2025-10-12)

- 发现所有 23 种语言的类型定义都存在严重混乱
- 原因: 复制粘贴错误,把其他语言的类型混在一起
- 修复: 完全基于实际 prompt 文件重建类型定义
- 结果: 类型数量从 600+ 个混乱定义减少到 80+ 个正确定义

---

## 📝 审查方法论

### 审查工具

1. **文件结构检查**: `find` + `ls` 命令
2. **内容分析**: Python 脚本 (正则匹配)
3. **类型对齐验证**: 对比前端定义与实际文件

### 审查步骤

1. 列举所有 Prompt 文件
2. 读取前端类型定义 (`diagram-types.ts`)
3. 对比类型定义与实际文件
4. 检查 L1/L2/L3 目录结构
5. 分析层级职责划分
6. 统计文件大小和 Token 预估
7. 生成审查报告

---

## 🔗 相关文档

- **架构指南**: `/root/Diagram/DiagramAI/CLAUDE.md`
- **类型定义 (SSOT)**: `/root/Diagram/DiagramAI/src/lib/constants/diagram-types.ts`
- **Prompt 加载器**: `/root/Diagram/DiagramAI/src/lib/utils/prompt-loader.ts`
- **验证脚本**: `/root/Diagram/DiagramAI/scripts/verify-types.ts` (待创建)

---

**审查员**: Claude Code (AI Assistant)
**审查日期**: 2025-10-13
**报告版本**: 1.0.0
