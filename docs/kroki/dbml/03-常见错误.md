# DBML 常见错误与解决方案

> **验证时间**: 2025-10-13
> **参考来源**: GitHub Issues, Community Forum, Stack Overflow

---

## 🚨 高频错误类型

### 1. 数据类型错误

#### 错误 1.1: 类型包含空格

```dbml
// ❌ 错误
Table users {
  id big int              // 类型不能有空格
  price decimal (10, 2)   // 括号前不能有空格
}

// ✅ 正确
Table users {
  id bigint
  price decimal(10,2)
}
```

**原因**: DBML 要求数据类型必须是单个单词

**解决方案**:

- 移除类型中的所有空格
- 参数括号紧跟类型名: `decimal(10,2)`

#### 错误 1.2: 不支持的类型语法

```dbml
// ❌ 错误
Table users {
  id bigint unsigned      // 多单词类型
}

// ✅ 解决方案 1: 用引号包裹
Table users {
  id "bigint unsigned"
}

// ✅ 解决方案 2: 使用标准类型
Table users {
  id bigint [note: 'unsigned in actual DB']
}
```

### 2. 默认值错误

#### 错误 2.1: 字符串值引号错误

```dbml
// ❌ 错误
Table users {
  status varchar [default: "active"]     // 用了双引号
  source varchar [default: active]       // 没用引号
}

// ✅ 正确
Table users {
  status varchar [default: 'active']     // 单引号
  source varchar [default: 'direct']
}
```

**规则**:

- 字符串值: 必须用**单引号** `'string'`
- 双引号: 仅用于引用变量名 `"column name"`

#### 错误 2.2: 表达式引号错误

```dbml
// ❌ 错误
Table logs {
  created_at timestamp [default: 'now()']      // 单引号错误
  expires_at timestamp [default: "now() + interval '1 day'"]  // 双引号错误
}

// ✅ 正确
Table logs {
  created_at timestamp [default: `now()`]      // 反引号
  expires_at timestamp [default: `now() + interval '1 day'`]
}
```

**规则**:

- 表达式: 必须用**反引号** `` `expression` ``
- 数字: 不用引号 `[default: 123]`
- 布尔: 不用引号 `[default: true]`

#### 错误 2.3: 默认值类型不匹配

```dbml
// ❌ 错误
Table users {
  age integer [default: 'twenty']        // 字符串赋给整数
  is_active boolean [default: 'true']    // 字符串赋给布尔
}

// ✅ 正确
Table users {
  age integer [default: 20]
  is_active boolean [default: true]
}
```

### 3. 关系定义错误

#### 错误 3.1: 关系符号方向错误

```dbml
// ❌ 错误概念
Table posts {
  user_id integer [ref: < users.id]    // 符号反了
}

// ✅ 正确理解
// posts.user_id > users.id  (many-to-one: 多个 post 对应 1 个 user)
Table posts {
  user_id integer [ref: > users.id]
}

// 或者
Ref: posts.user_id > users.id
```

**记忆技巧**:

- `>`: 箭头指向 "一" 的那方 (many → one)
- `<`: 箭头指向 "多" 的那方 (one → many)

#### 错误 3.2: One-to-One 外键位置错误

```dbml
// ❌ 错误: 搞不清哪个是外键
Ref: users.id - profiles.user_id

// 实际上: profiles.user_id 是外键
// 这可能不是你想要的

// ✅ 推荐: 用内联形式明确外键
Table profiles {
  user_id integer [ref: - users.id]    // 明确 profiles.user_id 是外键
}
```

**规则**:

- Long/Short form: **第二列**是外键
- Inline form: **有 ref 的列**是外键

#### 错误 3.3: 复合外键语法错误

```dbml
// ❌ 错误
Ref: order_items.order_id, order_items.product_id > orders.id, orders.store_id

// ✅ 正确
Ref: order_items.(order_id, product_id) > orders.(id, store_id)
```

#### 错误 3.4: 跨 Schema 引用未指定 Schema

```dbml
// ❌ 错误
Table blogging.posts {
  user_id integer [ref: > users.id]     // 找不到 users (默认在 blogging schema)
}

// ✅ 正确
Table blogging.posts {
  user_id integer [ref: > core.users.id]    // 明确指定 core schema
}
```

### 4. 索引定义错误

#### 错误 4.1: 索引括号错误

```dbml
// ❌ 错误
Table users {
  indexes {
    id, email [unique]              // 语法错误
    user_id, created_at [pk]        // 语法错误
  }
}

// ✅ 正确
Table users {
  indexes {
    (id, email) [unique]            // 复合索引用括号
    (user_id, created_at) [pk]      // 复合主键用括号
    id [unique]                     // 单列可以不用括号
  }
}
```

#### 错误 4.2: 主键重复定义

```dbml
// ❌ 错误
Table users {
  id integer [pk]
  email varchar [unique]

  indexes {
    id [pk]        // 重复定义主键
  }
}

// ✅ 正确方案 1: 只在列定义
Table users {
  id integer [pk]
  email varchar [unique]
}

// ✅ 正确方案 2: 只在索引
Table users {
  id integer
  email varchar [unique]

  indexes {
    id [pk]
  }
}

// ✅ 正确方案 3: 复合主键必须在索引
Table orders {
  user_id integer
  order_id integer

  indexes {
    (user_id, order_id) [pk]
  }
}
```

#### 错误 4.3: 表达式索引引号错误

```dbml
// ❌ 错误
Table users {
  indexes {
    (lower(email))              // 没用反引号
    'id * 2'                    // 用了单引号
  }
}

// ✅ 正确
Table users {
  indexes {
    (`lower(email)`)            // 反引号
    (`id * 2`)                  // 反引号
  }
}
```

### 5. 枚举相关错误

#### 错误 5.1: 枚举值包含空格未加引号

```dbml
// ❌ 错误
enum status {
  not set        // 有空格，需要引号
  A+             // 特殊字符，需要引号
}

// ✅ 正确
enum status {
  "not set"
  "A+"
}
```

#### 错误 5.2: 枚举名称冲突

```dbml
// ❌ 错误
enum status {
  active
  inactive
}

enum status {      // 重复定义
  pending
  done
}

// ✅ 正确方案 1: 使用不同名称
enum user_status {
  active
  inactive
}

enum order_status {
  pending
  done
}

// ✅ 正确方案 2: 使用不同 schema
enum public.status {
  active
  inactive
}

enum v2.status {
  pending
  done
}
```

### 6. TablePartial 错误

#### 错误 6.1: 注入语法错误

```dbml
// ❌ 错误
TablePartial base_template {
  id integer [pk]
}

Table users {
  base_template        // 缺少 ~ 前缀
  name varchar
}

// ✅ 正确
Table users {
  ~base_template       // 必须有 ~ 前缀
  name varchar
}
```

#### 错误 6.2: 循环引用

```dbml
// ❌ 错误
TablePartial A {
  ~B
}

TablePartial B {
  ~A
}

// 会导致无限循环
```

### 7. 注释和字符串错误

#### 错误 7.1: 多行字符串引号错误

```dbml
// ❌ 错误
Note: """
  This is wrong
"""

Note: '
  This is also wrong
'

// ✅ 正确
Note: '''
  This is correct
'''
```

#### 错误 7.2: 特殊字符未转义

```dbml
// ❌ 错误
Note: '''
  Path: C:\Users\data   // \ 需要转义
'''

// ✅ 正确
Note: '''
  Path: C:\\Users\\data
'''
```

### 8. SQL 转 DBML 错误

#### 错误 8.1: 不支持的 SQL 语法

```sql
-- ❌ SQL 包含 DBML 不支持的特性
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  data JSON DEFAULT '{}',           -- JSON 默认值
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CHECK (age > 0)                   -- CHECK 约束
);
```

**解决方案**:

```dbml
Table users {
  id integer [pk, increment]
  data json [default: `'{}'`]       // 用表达式包裹 JSON
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  age integer [note: 'CHECK: age > 0']  // 用注释说明约束
}
```

#### 错误 8.2: sql2dbml 解析失败

```bash
# 常见原因
1. SQL 方言特定语法 (Oracle, SQL Server 特有)
2. 存储过程、触发器、视图
3. 分区表、继承表
4. 自定义类型

# 解决方案
1. 清理 SQL: 只保留 CREATE TABLE 语句
2. 移除方言特定语法
3. 手动转换复杂结构
```

---

## 🔍 调试方法

### 1. 使用 dbdiagram.io 在线验证

```
步骤:
1. 打开 https://dbdiagram.io
2. 粘贴 DBML 代码
3. 查看错误提示 (红色下划线)
4. 鼠标悬停查看详细错误信息
```

### 2. 使用 DBML CLI 本地验证

```bash
# 安装
npm install -g @dbml/cli

# 转换为 SQL (验证语法)
dbml2sql schema.dbml --postgres

# 如果有错误会显示:
# Error: Syntax error at line 10, column 15
```

### 3. 使用 VSCode 插件实时检查

```
1. 安装 "dbml-language" 插件
2. 打开 .dbml 文件
3. 错误会实时高亮显示
```

### 4. 逐步排查法

```dbml
// 步骤 1: 测试基本结构
Table test { id integer }

// 步骤 2: 逐步添加列
Table test {
  id integer
  name varchar  // 加一列
}

// 步骤 3: 添加设置
Table test {
  id integer [pk]
  name varchar [not null]
}

// 步骤 4: 添加关系
// ...
```

---

## 📋 错误检查清单

### 语法检查

- [ ] 所有数据类型是单个单词 (无空格)
- [ ] 字符串用单引号 `'string'`
- [ ] 表达式用反引号 `` `expr` ``
- [ ] 变量名引用用双引号 `"name"`
- [ ] 多行字符串用三单引号 `'''...'''`
- [ ] 复合索引用括号 `(col1, col2)`

### 关系检查

- [ ] 关系符号方向正确 (`<`, `>`, `-`, `<>`)
- [ ] One-to-One 外键位置明确
- [ ] 复合外键用括号 `(col1, col2)`
- [ ] 跨 Schema 引用指定 Schema

### 数据完整性

- [ ] 主键未重复定义
- [ ] 枚举名称无冲突
- [ ] 外键引用的列存在
- [ ] 默认值类型匹配

### 模板和组织

- [ ] TablePartial 注入用 `~` 前缀
- [ ] TableGroup 包含的表存在
- [ ] 无循环引用

---

## 🛠️ 工具推荐

### 在线工具

1. **dbdiagram.io** - 实时语法检查和可视化
2. **dbdocs.io** - 文档生成和验证

### 本地工具

1. **@dbml/cli** - 命令行验证工具
2. **VSCode dbml-language** - 语法高亮和错误提示
3. **dbml-language-server** (Rust) - LSP 支持

### 开发工具

1. **PyDBML** (Python) - Python 解析器
2. **dbml-go** (Go) - Go 解析器
3. **dbml-parser** (PHP) - PHP 解析器

---

## 📚 参考资源

- **官方文档**: https://dbml.dbdiagram.io/docs/
- **GitHub Issues**: https://github.com/holistics/dbml/issues
- **社区论坛**: https://community.dbdiagram.io/
- **Stack Overflow**: 搜索 `[dbml]` 标签

---

**文档更新**: 2025-10-13
**来源**: GitHub Issues, Community Forum, 实践经验总结
