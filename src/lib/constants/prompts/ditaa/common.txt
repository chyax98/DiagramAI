# Ditaa 通用语法规范 (L2)

## 渲染引擎特性
- ASCII 艺术字符转专业图形
- 自动识别形状并美化渲染
- 支持颜色和特殊符号标记

---

## 核心语法规则

### 1. 形状闭合原则
所有形状必须完整闭合才能被识别：

**矩形**:
```
+-----+
|     |
+-----+
```

**圆角矩形**:
```
/-----\
|     |
\-----/
```

**不完整形状不会被识别**:
```
+-----+
|     |
+----    ← 缺少闭合,渲染失败
```

### 2. 线条和箭头

**水平箭头**:
- 向右: `--->`
- 向左: `<---`
- 双向: `<--->`

**垂直箭头**:
```
|     ← 线条
v     ← 向下箭头
^     ← 向上箭头
```

### 3. 虚线规则 (扩散性)
一个虚线标记会使整条线变为虚线：

**水平虚线**: 包含 `=`
```
=====     ← 全虚线
--=--     ← 部分虚线,整条线都变虚线
```

**垂直虚线**: 包含 `:`
```
:    ← 虚线
|    ← 实线
:    ← 整条线都变虚线
```

### 4. 形状标签系统
标签必须在闭合形状内,改变渲染样式：

| 标签 | 中文说明 | 用途 |
|------|---------|------|
| `{c}` | 选择/决策 | 菱形决策节点 |
| `{d}` | 文档 | 底部波浪线 |
| `{io}` | 输入/输出 | I/O 操作符号 |
| `{mo}` | 手动操作 | 手动流程步骤 |
| `{o}` | 椭圆 | 椭圆形状 |
| `{s}` | 存储 | 圆柱体(数据库/硬盘) |
| `{tr}` | 梯形 | 梯形符号 |

**示例**:
```
+-----+
| {c} |  ← 渲染为菱形
+-----+

+-----+
| {s} |  ← 渲染为圆柱体
+-----+
```

### 5. 颜色系统

**格式**: `cXXX` (X = 十六进制 0-F)
- 第一位 = 红色 (R)
- 第二位 = 绿色 (G)
- 第三位 = 蓝色 (B)

**颜色必须在形状内**:
```
+----+
|cF00|  ← 纯红色 (Red=15, Green=0, Blue=0)
+----+

+----+
|c0F0|  ← 纯绿色
+----+

+----+
|c00F|  ← 纯蓝色
+----+
```

**预定义颜色常量**:
- `cRED` → `cF00`
- `cGRE` → `c0F0`
- `cBLU` → `c00F`
- `cYEL` → `cFF0`
- `cPNK` → `cF0F`
- `cBLK` → `c000`

### 6. 文本项目符号
格式: `' o XXXXX'` (o 前后必须有空格)

```
/-----------------\
| Things to do    |
| o Cut the grass |  ← o 自动渲染为 •
| o Buy jam       |
\-----------------/
```

**错误用法**:
```
|oItem|       ← 缺少空格,不会渲染
|o Item|      ← 前面缺少空格
```

### 7. 连接和交叉

**T 型连接**:
```
+--+--+
|  |  |
+--+--+
```

**十字连接**:
```
   |
+--+--+
   |
```

**交叉但不连接 (使用空格)**:
```
  |
- + -  ← 空格分离,不连接
  |
```

---

## 严格限制

### 字符使用
- ✅ **必须使用等宽字体**:编辑 Ditaa 代码时必须使用等宽字体 (如 Consolas, Monaco, Courier New)
- ✅ **严格对齐要求**:所有形状边框、线条、连接点必须使用空格精确对齐
- ✅ 使用半角 ASCII 字符
- ❌ 不要混用全角字符
- ❌ 避免制表符 (Tab), 用空格代替
- ❌ 特殊字符 `:` 在文本中会被识别为虚线

**对齐原理**:
```
+-----+          ← 顶部边框必须对齐
|     |          ← 左右边框必须垂直对齐
+-----+          ← 底部边框必须对齐
```

**错误示例** (字符不对齐):
```
+---+
| Text |         ← 右边框超出
+---+
```

**正确示例** (严格对齐):
```
+------+
| Text |
+------+
```

### 形状约束
- ✅ 标签必须在闭合形状内
- ✅ 颜色代码必须在闭合形状内
- ✅ 形状必须完整闭合
- ❌ 不支持嵌套形状

### 编码要求
- 多字节字符(中文/日文)必须使用 UTF-8 编码
- 需要配置 TrueType 字体路径

---

## 输出格式
- 默认: PNG
- Kroki 支持: SVG, PNG
- 推荐 SVG 以获得更好的缩放质量

---

## Kroki 兼容性
- 完全支持 Ditaa 语法
- URL 编码: deflate + base64url
- 支持所有形状标签和颜色系统
- 边缘分离: 默认启用,获得更清晰的视觉效果

---

## 调试技巧
1. 检查形状闭合: 确保所有形状完整
2. 验证标签位置: 标签必须在形状内
3. 确认颜色范围: 颜色代码仅影响当前形状
4. 测试线条连接: 确保箭头和线条正确连接
