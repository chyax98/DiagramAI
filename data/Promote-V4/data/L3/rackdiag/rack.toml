# ============================================
# L3 类型层模板 v1.0.0
# RackDiag Rack (机柜图) 规范
# ============================================

[meta]
level = "L3"
language = "rackdiag"
diagram_type = "rack"
version = "1.0.0"
description = "RackDiag 机柜图规范"
author = "DiagramAI Team"
created_at = "2025-10-19"
updated_at = "2025-10-19"

# 可选: 类型相关的元数据
complexity = "medium"
target_length = 2500
use_cases = ["标准 42U 机柜", "Web 服务器机架", "高密度计算机架", "存储专用机架"]

# ============================================
# Section 1: D 角色定义 (Role Definition)
# ============================================

[D_role]
additional_roles = [
  "机柜布局设计专家",
  "设备安装规划师"
]

# ============================================
# Section 2: E 约束条件 (Constraints)
# ============================================

[E_constraints]
items = [
  """
  **U 位编号从 1 开始**: 标准 42U 机柜的 U 位编号从 1（底部）到 42（顶部）。非标准机柜需在开头定义高度（如 `16U;` 或 `24U;`）。
  """,

  """
  **多 U 设备空间计算**: 多 U 设备的空间计算规则：
  - `[2U]` 占用当前 U 位及上面 1 个 U 位
  - `[3U]` 占用当前 U 位及上面 2 个 U 位
  - `[4U]` 占用当前 U 位及上面 3 个 U 位
  例如：`1: Storage [4U]` 占用 U1, U2, U3, U4，下一设备应从 U5 开始。
  """,

  """
  **设备分层原则**: 遵循数据中心设备布局最佳实践：
  - 底部（U1-U5）：电源设备（UPS, PDU）
  - 中下部（U6-U15）：网络设备（交换机、路由器）
  - 中上部（U16-U38）：计算/存储设备（服务器、存储阵列）
  - 顶部（U39-U42）：管理设备（KVM、Patch Panel）
  """,

  """
  **重量分布要求**: 重型设备必须放置在底部以保持机柜稳定：
  - UPS（80-150kg）：U1-U3
  - 存储阵列（60-120kg）：U10-U30
  - 服务器（20-40kg）：U15-U38
  - 轻型设备（< 10kg）：可放置在任何位置
  """,

  """
  **设备属性标注**: 关键设备应标注以下属性：
  - `description`：设备详细型号或功能说明
  - `[Nkg]`：设备重量（用于承重计算）
  - `[NA]`：设备功耗（用于电源规划）
  - `color`：设备颜色（用于视觉分组）
  """,

  """
  **散热空间预留**: 高密度部署时必须预留散热空间：
  - 每 8-10 台 1U 服务器预留 1-2U 散热空位
  - 使用 `N/A` 标记散热预留空间
  - 高功耗设备（> 500W）分散布局
  """,

  """
  **U 位连续性**: 设备定义的 U 位应尽量连续，避免大量空位。如有空位，应使用注释说明用途（扩展预留、散热空间等）。
  """
]

# ============================================
# Section 3: P 流程规范 (Process)
# ============================================

[P_process]
items = [
  """
  **1. 分析设备清单**:
  - 统计所有设备类型和数量
  - 确定每个设备占用的 U 位数
  - 计算设备总重量和总功耗
  - 识别冗余设备（双电源、双网络）
  """,

  """
  **2. 规划 U 位分配**:
  - 按分层原则分配 U 位（电源 → 网络 → 计算 → 管理）
  - 计算每个设备的起始 U 位
  - 确保多 U 设备无重叠
  - 预留 15-20% 空间用于未来扩展
  """,

  """
  **3. 实现 RackDiag 代码**:
  - 使用 `rackdiag {}` 包裹
  - 可选定义机架高度（如 `16U;`）
  - 按 U 位顺序定义设备
  - 多 U 设备使用 `[2U]`, `[4U]` 等标记
  - 添加分层注释（电源层、网络层、计算层、管理层）
  - 关键设备添加 description 和属性
  """,

  """
  **4. 验证容量规划**:
  - 承重验证：总重量 < 1000kg（标准机柜承重上限）
  - 功耗验证：总功耗 < 32A（单 PDU 上限）或使用双 PDU 分流
  - 散热验证：高密度区域有散热预留空间
  - 扩展验证：有 15-20% 空位用于未来扩展
  """,

  """
  **5. 优化布局**:
  - 重型设备移至底部
  - 高功耗设备分散布局
  - 添加散热空位（N/A 标记）
  - 优化线缆管理和维护空间
  """
]

# ============================================
# Section 4: H 质量标准 (Quality Standards)
# ============================================

[H_quality]
items = [
  """
  **U 位布局准确性**:
  - 所有 U 位编号在 1-42 范围内（或自定义高度范围）
  - 多 U 设备占用空间计算正确
  - 无 U 位重叠或冲突
  - 设备顺序合理，无大量空位
  """,

  """
  **分层规划合理性**:
  - 电源设备在底部（U1-U5）
  - 网络设备在中下部（U6-U15）
  - 计算/存储设备在中上部（U16-U38）
  - 管理设备在顶部（U39-U42）
  - 重量分布合理（重设备在底部）
  """,

  """
  **容量规划准确性**:
  - 总承重 < 1000kg（安全范围）
  - 总功耗 < 32A 或使用双 PDU 分流
  - 预留 15-20% 空间用于扩展
  - 高密度区域有散热预留空间
  """,

  """
  **专业性和实用性**:
  - 设备命名清晰，符合数据中心规范
  - 设备类型和型号准确
  - 关键设备有详细描述
  - 布局符合数据中心最佳实践
  """
]

# ============================================
# Section 5: 使用场景 (Use Cases)
# ============================================

[[use_cases]]
title = "标准 42U Web 服务器机柜"
scenario = """
标准企业 Web 服务器机柜，包含电源冗余、网络设备、Web 服务器、应用服务器、数据库服务器和存储。
需要清晰展示设备分层和 U 位分配。
"""
key_points = [
  "电源层（U1-U6）：UPS [2U] + 双 PDU",
  "网络层（U6-U10）：核心交换机 + 接入交换机",
  "计算层（U10-U28）：Web 服务器 [2U] × 3, App 服务器 [2U] × 2, DB 服务器 [4U]",
  "存储层（U24-U28）：SAN 存储 [4U]",
  "管理层（U40-U42）：KVM + Patch Panel",
  "所有多 U 设备正确标记，无重叠"
]

[[use_cases]]
title = "高密度计算机架（16 台 1U 服务器）"
scenario = """
云服务商高密度计算机柜，包含 16 台 1U 服务器和冗余网络。
需要展示高密度部署和散热规划。
"""
key_points = [
  "电源层（U1-U6）：UPS [3U] + 双 PDU",
  "网络层（U5-U7）：双 ToR 交换机（冗余）",
  "计算层（U7-U22）：16 台 1U 云计算节点连续编号",
  "管理层（U40）：IPMI 控制器（远程管理）",
  "预留 U23-U39 空间用于扩展",
  "考虑散热：每 8-10 台服务器预留 1-2U 空位"
]

[[use_cases]]
title = "存储专用机架"
scenario = """
数据中心存储专用机柜，包含 7 个 4U 存储阵列和双 SAN 交换机。
需要展示存储冗余和高容量部署。
"""
key_points = [
  "电源层（U1-U4）：UPS [2U] + 双 PDU（冗余电源）",
  "网络层（U5-U7）：双 SAN 交换机（冗余网络）",
  "存储层（U8-U35）：7 个 4U 存储阵列，每个 24TB",
  "管理层（U40）：管理控制台",
  "承重验证：7 × 120kg + UPS 80kg = 920kg < 1000kg（安全）",
  "功耗验证：7 × 15A + UPS 3A = 108A，使用双 PDU 分流（每个 54A > 32A，需要高容量 PDU）"
]
