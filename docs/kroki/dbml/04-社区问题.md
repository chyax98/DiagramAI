# DBML ç¤¾åŒºé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

> **éªŒè¯æ—¶é—´**: 2025-10-13
> **æ•°æ®æ¥æº**: GitHub Issues, Community Forum, Stack Overflow

---

## ğŸ”¥ é«˜é¢‘é—®é¢˜æ±‡æ€»

### 1. SQL è½¬ DBML é—®é¢˜

#### é—®é¢˜ 1.1: sql2dbml ç¬¬ä¸€ä¸ªå­—ç¬¦æŠ¥é”™

**Issue**: [#191 - dbml2sql Syntax Error on first character](https://github.com/holistics/dbml/issues/191)

**ç—‡çŠ¶**:

```bash
$ sql2dbml dump.sql --postgres
Error: Syntax error at line 1, column 1
```

**åŸå› **:

- SQL æ–‡ä»¶åŒ…å« BOM (Byte Order Mark)
- SQL æ–‡ä»¶ç¼–ç é—®é¢˜
- åŒ…å« sql2dbml ä¸æ”¯æŒçš„è¯­å¥ (å¦‚ SET, COMMENT, etc.)

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æ–¹æ¡ˆ 1: ç§»é™¤ BOM
sed -i '1s/^\xEF\xBB\xBF//' dump.sql

# æ–¹æ¡ˆ 2: è½¬æ¢ç¼–ç 
iconv -f UTF-8-BOM -t UTF-8 dump.sql > clean.sql

# æ–¹æ¡ˆ 3: åªæå– CREATE TABLE è¯­å¥
grep -A 100 "CREATE TABLE" dump.sql > tables_only.sql

# æ–¹æ¡ˆ 4: ç§»é™¤éè¡¨å®šä¹‰è¯­å¥
sed -i '/^SET /d; /^COMMENT /d; /^ALTER /d' dump.sql
```

**æœ€ä½³å®è·µ**:

```sql
-- âœ… åªåŒ…å«çº¯ç²¹çš„ CREATE TABLE
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(50)
);

CREATE TABLE posts (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id)
);

-- âŒ é¿å…åŒ…å«è¿™äº›
SET client_encoding = 'UTF8';
COMMENT ON TABLE users IS 'User data';
ALTER TABLE users OWNER TO postgres;
```

#### é—®é¢˜ 1.2: PostgreSQL ç‰¹å®šè¯­æ³•ä¸æ”¯æŒ

**Issue**: [#277 - Postgres sql2dbml errors](https://github.com/holistics/dbml/issues/277)

**ä¸æ”¯æŒçš„è¯­æ³•**:

```sql
-- âŒ ä¸æ”¯æŒ
CREATE TABLE users (
  id SERIAL,
  data JSONB DEFAULT '{}'::jsonb,           -- JSONB ç±»å‹è½¬æ¢
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT NOW(),
  CONSTRAINT age_check CHECK (age > 0),     -- CHECK çº¦æŸ
  EXCLUDE USING gist (period WITH &&)       -- EXCLUDE çº¦æŸ
);

-- âœ… è½¬æ¢ä¸º DBML å‹å¥½çš„ SQL
CREATE TABLE users (
  id SERIAL,
  data JSONB,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**æ‰‹åŠ¨è½¬æ¢**:

```dbml
Table users {
  id integer [increment, pk]
  data jsonb [default: `'{}'::jsonb`, note: 'JSONB default']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `NOW()`]
  age integer [note: 'CHECK: age > 0']
  period tsrange [note: 'EXCLUDE USING gist (period WITH &&)']
}
```

### 2. å…³ç³»å’Œå¤–é”®é—®é¢˜

#### é—®é¢˜ 2.1: Many-to-Many å…³ç³»å¦‚ä½•è¡¨ç¤º?

**ç¤¾åŒºæ•™ç¨‹**: [Many-to-many relationships](https://community.dbdiagram.io/t/tutorial-many-to-many-relationships/412)

**æ–¹æ¡ˆ 1: ä½¿ç”¨ `<>` ç¬¦å· (ç®€å•)**

```dbml
Table authors {
  id integer [pk]
  name varchar
}

Table books {
  id integer [pk]
  title varchar
}

// ç›´æ¥å®šä¹‰ M:N
Ref: authors.id <> books.id
```

**é—®é¢˜**: å¯¼å‡º SQL æ—¶ä¸ä¼šç”Ÿæˆä¸­é—´è¡¨

**æ–¹æ¡ˆ 2: æ‰‹åŠ¨åˆ›å»ºä¸­é—´è¡¨ (æ¨è)**

```dbml
Table authors {
  id integer [pk]
  name varchar
}

Table books {
  id integer [pk]
  title varchar
}

Table authors_books {
  author_id integer [ref: > authors.id]
  book_id integer [ref: > books.id]

  indexes {
    (author_id, book_id) [pk]
  }
}
```

**ä¼˜ç‚¹**:

- å¯ä»¥æ·»åŠ é¢å¤–å­—æ®µ (created_at, role, etc.)
- å¯¼å‡º SQL æ—¶ç”ŸæˆçœŸå®è¡¨ç»“æ„

#### é—®é¢˜ 2.2: è‡ªå¼•ç”¨å…³ç³»

**åœºæ™¯**: å‘˜å·¥ â†’ ç»ç† (åŒä¸€å¼ è¡¨)

```dbml
Table employees {
  id integer [pk]
  name varchar
  manager_id integer [ref: > employees.id, null]  // è‡ªå¼•ç”¨
}

// æˆ–è€…
Ref: employees.manager_id > employees.id
```

#### é—®é¢˜ 2.3: å¾ªç¯ä¾èµ–

**é—®é¢˜**:

```dbml
// âŒ å¾ªç¯ä¾èµ–
Table A {
  b_id integer [ref: > B.id]
}

Table B {
  a_id integer [ref: > A.id]
}
```

**è§£å†³æ–¹æ¡ˆ**:

```dbml
// âœ… æ˜ç¡®ä¸»ä»å…³ç³»
Table departments {
  id integer [pk]
  name varchar
}

Table employees {
  id integer [pk]
  department_id integer [ref: > departments.id]
}

// departments çš„è´Ÿè´£äººæ˜¯ employee
Table departments {
  id integer [pk]
  name varchar
  manager_id integer [ref: > employees.id, null]
}
```

### 3. æ–°è§£æå™¨è¿ç§»é—®é¢˜

#### é—®é¢˜ 3.1: æ–°è§£æå™¨è¯­æ³•å˜æ›´

**å…¬å‘Š**: [Improvement: New DBML Parser](https://community.dbdiagram.io/t/improvement-new-dbml-parser/2798)

**ä¸»è¦å˜æ›´**:

1. **æ›´ä¸¥æ ¼çš„å¼•å·è§„åˆ™**

```dbml
// æ—§è§£æå™¨: å¯èƒ½æ¥å—
Table users {
  status varchar [default: active]
}

// æ–°è§£æå™¨: å¿…é¡»åŠ å¼•å·
Table users {
  status varchar [default: 'active']
}
```

2. **æ›´ç²¾ç¡®çš„é”™è¯¯æŠ¥å‘Š**

```
æ—§: åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªé”™è¯¯
æ–°: æ˜¾ç¤ºæ‰€æœ‰è¯­æ³•é”™è¯¯
```

3. **ç´¢å¼•è¯­æ³•æ›´ä¸¥æ ¼**

```dbml
// æ—§è§£æå™¨: å¯èƒ½æ¥å—
indexes {
  id, email [unique]
}

// æ–°è§£æå™¨: å¿…é¡»ç”¨æ‹¬å·
indexes {
  (id, email) [unique]
}
```

**è¿ç§»å»ºè®®**:

1. ä½¿ç”¨ dbdiagram.io é‡æ–°éªŒè¯æ‰€æœ‰ DBML æ–‡ä»¶
2. ä¿®å¤æ‰€æœ‰è¯­æ³•è­¦å‘Š
3. æµ‹è¯•å¯¼å‡ºçš„ SQL

### 4. æ•°æ®ç±»å‹é—®é¢˜

#### é—®é¢˜ 4.1: æ•°ç»„ç±»å‹

```dbml
// PostgreSQL æ•°ç»„
Table posts {
  tags text[]              // âŒ ä¸æ”¯æŒ
  tags "text[]"            // âœ… ç”¨å¼•å·åŒ…è£¹
  tags text [note: 'PostgreSQL array type: text[]']  // âœ… ç”¨æ³¨é‡Šè¯´æ˜
}
```

#### é—®é¢˜ 4.2: è‡ªå®šä¹‰ç±»å‹

```sql
-- PostgreSQL
CREATE TYPE mood AS ENUM ('happy', 'sad', 'neutral');

CREATE TABLE person (
  current_mood mood
);
```

**è½¬æ¢ä¸º DBML**:

```dbml
enum mood {
  happy
  sad
  neutral
}

Table person {
  current_mood mood
}
```

#### é—®é¢˜ 4.3: JSONB vs JSON

```dbml
Table analytics {
  // PostgreSQL æœ‰ JSON å’Œ JSONB
  metadata json             // JSON ç±»å‹
  settings jsonb            // JSONB ç±»å‹ (æ›´é«˜æ•ˆ)

  // MySQL åªæœ‰ JSON
  data json
}
```

### 5. ç‰ˆæœ¬æ§åˆ¶é—®é¢˜

#### é—®é¢˜ 5.1: DBML æ–‡ä»¶å¦‚ä½•ç‰ˆæœ¬æ§åˆ¶?

**æ¨èåšæ³•**:

```bash
# 1. é¡¹ç›®æ ¹ç›®å½•
project/
â”œâ”€â”€ database.dbml          # ä¸» Schema æ–‡ä»¶
â”œâ”€â”€ migrations/            # è¿ç§»å†å²
â”‚   â”œâ”€â”€ 001_init.dbml
â”‚   â”œâ”€â”€ 002_add_users.dbml
â”‚   â””â”€â”€ 003_add_posts.dbml
â””â”€â”€ README.md

# 2. ä½¿ç”¨ Git
git add database.dbml
git commit -m "feat: add user authentication tables"

# 3. é…åˆ dbdocs è‡ªåŠ¨éƒ¨ç½²
# .github/workflows/dbdocs.yml
name: Deploy DB Docs
on:
  push:
    paths:
      - 'database.dbml'
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - run: npm install -g dbdocs
      - run: dbdocs build database.dbml
```

#### é—®é¢˜ 5.2: Schema æ¼”è¿›ç®¡ç†

```dbml
// v1.0.0
Table users {
  id integer [pk]
  username varchar
}

// v2.0.0 - æ·»åŠ  email
Table users {
  id integer [pk]
  username varchar
  email varchar [note: 'Added in v2.0.0']
}

// v3.0.0 - åºŸå¼ƒ usernameï¼Œä½¿ç”¨ email
Table users {
  id integer [pk]
  username varchar [note: 'Deprecated in v3.0.0, use email']
  email varchar [not null, unique]
}
```

### 6. æ€§èƒ½å’Œé™åˆ¶

#### é—®é¢˜ 6.1: å¤§å‹ Schema æ€§èƒ½

**é—®é¢˜**: 100+ è¡¨çš„ DBML æ–‡ä»¶åœ¨ dbdiagram.io åŠ è½½ç¼“æ…¢

**è§£å†³æ–¹æ¡ˆ**:

```dbml
// æ–¹æ¡ˆ 1: æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ (é€»è¾‘åˆ†ç»„)
// core.dbml
Table users { ... }
Table roles { ... }

// ecommerce.dbml
Table products { ... }
Table orders { ... }

// analytics.dbml
Table events { ... }
Table metrics { ... }

// æ–¹æ¡ˆ 2: ä½¿ç”¨ TableGroup æŠ˜å 
TableGroup core {
  users
  roles
  permissions
}

TableGroup ecommerce {
  products
  orders
  payments
}
```

#### é—®é¢˜ 6.2: å¤æ‚å…³ç³»å›¾å¯è¯»æ€§

```dbml
// ä½¿ç”¨é¢œè‰²åŒºåˆ†
Ref: posts.user_id > users.id [color: #3498DB]
Ref: comments.post_id > posts.id [color: #E74C3C]
Ref: likes.user_id > users.id [color: #2ECC71]

// ä½¿ç”¨ TableGroup ç»„ç»‡
TableGroup content [color: #3498DB] {
  posts
  comments
  media
}

TableGroup user_engagement [color: #E74C3C] {
  likes
  shares
  bookmarks
}
```

### 7. å·¥å…·é›†æˆé—®é¢˜

#### é—®é¢˜ 7.1: ORM æ¨¡å‹è½¬ DBML

**Django**:

```bash
# ä½¿ç”¨ DbmlForDjango
pip install dbml-for-django
python manage.py dbml > schema.dbml
```

**Laravel**:

```bash
# ä½¿ç”¨ Kacher
composer require aphisitworachorch/kacher
php artisan kacher:generate
```

**Prisma**:

```bash
# ä½¿ç”¨ prisma-dbml-generator
npm install -D prisma-dbml-generator
# prisma/schema.prisma
generator dbml {
  provider = "prisma-dbml-generator"
}
```

**Rails**:

```bash
# ä½¿ç”¨ SchemaToDbml
gem install schema_to_dbml
schema_to_dbml
```

#### é—®é¢˜ 7.2: CI/CD é›†æˆ

```yaml
# .github/workflows/validate-schema.yml
name: Validate Database Schema

on:
  pull_request:
    paths:
      - "database.dbml"

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "18"

      - name: Install DBML CLI
        run: npm install -g @dbml/cli

      - name: Validate DBML Syntax
        run: dbml2sql database.dbml --postgres

      - name: Generate SQL
        run: dbml2sql database.dbml --postgres -o schema.sql

      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: generated-sql
          path: schema.sql
```

---

## ğŸ“Š å¸¸è§é—®é¢˜ç»Ÿè®¡

åŸºäº GitHub Issues åˆ†æ (2024-2025):

| é—®é¢˜ç±»å‹     | å æ¯” | ä¸»è¦åŸå›                |
| ------------ | ---- | ---------------------- |
| SQL è½¬æ¢é”™è¯¯ | 35%  | æ–¹è¨€ç‰¹å®šè¯­æ³•ã€ç¼–ç é—®é¢˜ |
| å…³ç³»å®šä¹‰é—®é¢˜ | 25%  | ç¬¦å·æ–¹å‘ã€å¤åˆå¤–é”®     |
| æ•°æ®ç±»å‹é—®é¢˜ | 20%  | è‡ªå®šä¹‰ç±»å‹ã€æ•°ç»„       |
| æ–°è§£æå™¨è¿ç§» | 10%  | è¯­æ³•æ›´ä¸¥æ ¼             |
| å·¥å…·é›†æˆ     | 10%  | ORM é›†æˆã€CI/CD        |

---

## ğŸ› ï¸ è°ƒè¯•å·¥å…·

### 1. DBML Language Server (æ¨è)

```bash
# Rust å®ç°ï¼Œæ€§èƒ½æœ€å¥½
cargo install dbml-language-server

# æ”¯æŒ:
# - å®æ—¶è¯­æ³•æ£€æŸ¥
# - è¯­ä¹‰é«˜äº®
# - è‡ªåŠ¨è¡¥å…¨
```

### 2. åœ¨çº¿è°ƒè¯•

- **dbdiagram.io**: å®æ—¶å¯è§†åŒ– + é”™è¯¯æç¤º
- **dbdocs.io**: æ–‡æ¡£ç”Ÿæˆ + éªŒè¯

### 3. æœ¬åœ°éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# validate-dbml.sh

echo "Validating DBML files..."

for file in *.dbml; do
  echo "Checking $file..."
  dbml2sql "$file" --postgres > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "âœ… $file is valid"
  else
    echo "âŒ $file has errors:"
    dbml2sql "$file" --postgres 2>&1
  fi
done
```

---

## ğŸ“š æ¨èèµ„æº

### å®˜æ–¹èµ„æº

- **å®˜æ–¹æ–‡æ¡£**: https://dbml.dbdiagram.io/docs/
- **GitHub**: https://github.com/holistics/dbml
- **ç¤¾åŒºè®ºå›**: https://community.dbdiagram.io/
- **Discord**: å®˜æ–¹ Discord é¢‘é“

### å­¦ä¹ èµ„æº

- **å®˜æ–¹ç¤ºä¾‹**: https://dbdiagram.io/d/
- **ç¤¾åŒºæ•™ç¨‹**: https://community.dbdiagram.io/c/tutorials
- **YouTube**: æœç´¢ "DBML tutorial"

### å·¥å…·ç”Ÿæ€

- **Awesome DBML**: https://github.com/topics/dbml
- **NPM Package**: https://www.npmjs.com/package/@dbml/core
- **VSCode Extension**: "dbml-language"

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

1. **ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶**: å°† DBML æ–‡ä»¶çº³å…¥ Git
2. **æ–‡æ¡£åŒ–**: å……åˆ†ä½¿ç”¨ Note åŠŸèƒ½
3. **æ¨¡å—åŒ–**: å¤§å‹é¡¹ç›®æ‹†åˆ†å¤šä¸ª DBML æ–‡ä»¶
4. **è‡ªåŠ¨åŒ–**: CI/CD é›†æˆ DBML éªŒè¯
5. **å¯è§†åŒ–**: å®šæœŸç”Ÿæˆ ER å›¾å’Œæ–‡æ¡£
6. **æµ‹è¯•**: å¯¼å‡º SQL ååœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯

---

**æ–‡æ¡£æ›´æ–°**: 2025-10-13
**æ•°æ®æ¥æº**: GitHub Issues, Community Forum, å®è·µç»éªŒæ€»ç»“
