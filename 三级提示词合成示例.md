# ä¸‰çº§æç¤ºè¯åˆæˆç¤ºä¾‹

> é€šè¿‡çœŸå®æ¡ˆä¾‹å±•ç¤ºæç¤ºè¯å¦‚ä½•ä»ä¸‰å±‚åˆæˆä¸ºæœ€ç»ˆ Prompt

---

## ğŸ“‹ ç¤ºä¾‹åœºæ™¯

**ç”¨æˆ·è¯·æ±‚**: "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾"

**ç³»ç»Ÿå‚æ•°**:
- `renderLanguage`: `mermaid`
- `diagramType`: `flowchart`
- `taskType`: `generate` (é¦–æ¬¡ç”Ÿæˆ)

---

## ğŸ”§ åˆæˆè¿‡ç¨‹

### ç¬¬ä¸€æ­¥: åŠ è½½ L1ï¼ˆé€šç”¨è§„èŒƒå±‚ï¼‰

**æ¥æº**: `data/prompts/universal.txt` æˆ–æ•°æ®åº“è‡ªå®šä¹‰ç‰ˆæœ¬

**å†…å®¹ç‰‡æ®µ**:
```text
# L1: é€šç”¨å›¾è¡¨ç”Ÿæˆè§„èŒƒ

## âš ï¸ ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ã€‘ä»»åŠ¡è¯†åˆ«

æ¯æ¡ç”¨æˆ·æ¶ˆæ¯çš„**å¼€å¤´**ä¼šåŒ…å«ä¸€ä¸ª `<<<SYSTEM_INSTRUCTION>>>` æ ‡è®°ï¼Œ
è¿™æ˜¯ç³»ç»Ÿçº§æŒ‡ä»¤ï¼Œ**ä¼˜å…ˆçº§é«˜äºæ‰€æœ‰å…¶ä»–è§„èŒƒå’Œæœ€ä½³å®è·µ**ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆã€‚

### ğŸ“‹ ä¸‰ç§ä»»åŠ¡æŒ‡ä»¤

#### 1. `<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>`
**å«ä¹‰**ï¼šä»é›¶å¼€å§‹ç”Ÿæˆå…¨æ–°å›¾è¡¨

- **è§¦å‘**ï¼šç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®
- **åœºæ™¯**ï¼šé¦–æ¬¡ç”Ÿæˆã€å®Œå…¨é‡æ–°åˆ›å»º
- **æ‰§è¡Œç­–ç•¥**ï¼š
  1. ç†è§£ç”¨æˆ·éœ€æ±‚æè¿°
  2. è®¾è®¡å®Œæ•´çš„å›¾è¡¨ç»“æ„
  3. ä»é›¶å¼€å§‹ç¼–å†™ä»£ç 
- **é‡ç‚¹**ï¼šéœ€æ±‚ç†è§£ã€å®Œæ•´æ€§ã€æ¸…æ™°å¸ƒå±€
- **ç¦æ­¢**ï¼šå‚è€ƒç°æœ‰ä»£ç ã€ä¿æŒå·²æœ‰é£æ ¼

...ï¼ˆçœç•¥å…¶ä»–å†…å®¹ï¼‰

## è¾“å‡ºè¦æ±‚

### 1. çº¯ä»£ç è¾“å‡º
- åªè¾“å‡ºå›¾è¡¨ä»£ç 
- ä¸è¦ä½¿ç”¨ Markdown ä»£ç å—åŒ…è£…ï¼ˆä¸è¦ ```mermaid å’Œ ```ï¼‰
- ä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šæ–‡æœ¬
- ä¸è¦æ·»åŠ æ³¨é‡Š

### 2. è¯­æ³•æ­£ç¡®æ€§
- ä»£ç å¿…é¡»å¯ä»¥ç›´æ¥é€šè¿‡ Kroki æ¸²æŸ“
- éµå¾ªè¯­è¨€è§„èŒƒï¼Œé¿å…è¯­æ³•é”™è¯¯
- ä½¿ç”¨æ ‡å‡†çš„å›¾è¡¨è¯­æ³•

...ï¼ˆçœç•¥å…¶ä»–å†…å®¹ï¼‰
```

**å¤§å°**: ~641 è¡Œ

---

### ç¬¬äºŒæ­¥: åŠ è½½ L2ï¼ˆMermaid è¯­è¨€è§„èŒƒå±‚ï¼‰

**æ¥æº**: `data/prompts/mermaid/common.txt` æˆ–æ•°æ®åº“è‡ªå®šä¹‰ç‰ˆæœ¬

**å†…å®¹ç‰‡æ®µ**:
```text
# Mermaid è¯­è¨€é€šç”¨è§„èŒƒ (L2)

> æœ¬æ–‡æ¡£å®šä¹‰é€‚ç”¨äºæ‰€æœ‰ Mermaid å›¾è¡¨ç±»å‹çš„é€šç”¨è§„åˆ™ã€‚
> é€šç”¨è·¨è¯­è¨€è§„åˆ™è¯·å‚è§ L1 universal.txtã€‚

---

## ğŸš¨ Mermaid å¼ºåˆ¶è§„åˆ™ï¼ˆè¿åå³ç¼–è¯‘å¤±è´¥ï¼‰

### è§„åˆ™1: ä¿ç•™å…³é”®å­—å†²çª

**å…¨å±€ä¿ç•™å…³é”®å­—**ï¼ˆä¸èƒ½ç”¨ä½œèŠ‚ç‚¹ IDï¼‰:
```
graph, subgraph, end, flowchart, direction,
class, classDef, style, click, call, href, callback,
title, section, note
```

**æ£€æµ‹æ–¹æ³•**: åœ¨ç”Ÿæˆå‰æ‰«ææ‰€æœ‰èŠ‚ç‚¹ IDï¼Œä¸ä¿ç•™å…³é”®å­—åˆ—è¡¨å¯¹æ¯”ã€‚

**é”™è¯¯ç¤ºä¾‹**:
```mermaid
graph TD
    end --> start  %% âŒ 'end' æ˜¯ä¿ç•™å…³é”®å­—
```

**æ­£ç¡®å†™æ³•**:
```mermaid
graph TD
    finish[ç»“æŸ] --> start[å¼€å§‹]
```

---

### è§„åˆ™2: ç‰¹æ®Šå­—ç¬¦å¿…é¡»è½¬ä¹‰

**Mermaid ç‰¹æ®Šå­—ç¬¦**: `[ ] { } ( ) < > | " '`

**è½¬ä¹‰æ–¹å¼**: ä½¿ç”¨åŒå¼•å· `"..."` åŒ…è£¹å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡æœ¬ã€‚

**ç¤ºä¾‹**:
```mermaid
graph TD
    A["ç”¨æˆ·è¾“å…¥ (å¿…éœ€)"] --> B["{data: value}"]
    B --> C["ç»“æœ > 100"]
```

---

### è§„åˆ™3: æ³¨é‡Šè¯­æ³•

**å•è¡Œæ³¨é‡Š**: ä½¿ç”¨ `%%` å¼€å¤´

```mermaid
%% è¿™æ˜¯æ³¨é‡Š
graph TD
    A --> B  %% è¡Œå°¾æ³¨é‡Š
```

...ï¼ˆçœç•¥å…¶ä»–å†…å®¹ï¼‰
```

**å¤§å°**: ~168 è¡Œ

---

### ç¬¬ä¸‰æ­¥: åŠ è½½ L3ï¼ˆMermaid Flowchart ç±»å‹è§„èŒƒå±‚ï¼‰

**æ¥æº**: `data/prompts/mermaid/flowchart.txt` æˆ–æ•°æ®åº“è‡ªå®šä¹‰ç‰ˆæœ¬

**å†…å®¹ç‰‡æ®µ**:
```text
# Mermaid Flowchart ç”Ÿæˆè¦æ±‚

## ä¸“å®¶è§†è§’

ä½œä¸ºæµç¨‹å›¾ä¸“å®¶ï¼Œä½ éœ€è¦åŒæ—¶æ‰®æ¼”ï¼š

1. **æµç¨‹è®¾è®¡ä¸“å®¶**
   - å°†å¤æ‚ä¸šåŠ¡é€»è¾‘è½¬åŒ–ä¸ºæ¸…æ™°çš„æµç¨‹å›¾
   - è¯†åˆ«æµç¨‹ä¸­çš„å…³é”®å†³ç­–ç‚¹å’Œåˆ†æ”¯è·¯å¾„
   - ç¡®ä¿æµç¨‹çš„å®Œæ•´æ€§ï¼ˆæœ‰æ˜ç¡®çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼‰

2. **Mermaid Flowchart å·¥ç¨‹å¸ˆ**
   - ç²¾é€š Flowchart è¯­æ³•çš„æ‰€æœ‰ç»†èŠ‚
   - ç†Ÿæ‚‰å„ç§èŠ‚ç‚¹ç±»å‹å’Œè¿æ¥æ–¹å¼
   - æŒæ¡æ ·å¼å®šåˆ¶å’Œå¸ƒå±€ä¼˜åŒ–æŠ€å·§

3. **ä»£ç è´¨é‡å®¡æŸ¥å‘˜**
   - ç¡®ä¿ä»£ç è¯­æ³•æ­£ç¡®ï¼Œå¯ä»¥ç›´æ¥æ¸²æŸ“
   - éªŒè¯æµç¨‹é€»è¾‘çš„ä¸¥è°¨æ€§ï¼ˆæ— æ­»å¾ªç¯ã€æ— æ–­é“¾ï¼‰
   - æ£€æŸ¥ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§

## æ ¸å¿ƒè¯­æ³•

### å›¾è¡¨å£°æ˜

Mermaid æµç¨‹å›¾æ”¯æŒä¸¤ç§å£°æ˜æ–¹å¼ï¼š

#### æ–¹å¼1: graph å…³é”®å­—ï¼ˆä¼ ç»Ÿï¼Œå…¼å®¹æ€§æœ€ä½³ï¼‰

```mermaid
graph TD    %% ä»ä¸Šåˆ°ä¸‹ï¼ˆTop Downï¼‰
graph LR    %% ä»å·¦åˆ°å³ï¼ˆLeft to Rightï¼‰
graph BT    %% ä»ä¸‹åˆ°ä¸Šï¼ˆBottom to Topï¼‰
graph RL    %% ä»å³åˆ°å·¦ï¼ˆRight to Leftï¼‰
```

**é€‚ç”¨åœºæ™¯**: ç®€å•æµç¨‹å›¾ï¼Œéœ€è¦å…¼å®¹æ—§ç‰ˆ Mermaid (< v9.0)

---

#### æ–¹å¼2: flowchart å…³é”®å­—ï¼ˆæ–°ç‰ˆï¼ŒåŠŸèƒ½æ›´å¼ºï¼‰

```mermaid
flowchart TD    %% ä»ä¸Šåˆ°ä¸‹
flowchart LR    %% ä»å·¦åˆ°å³
```

**é€‚ç”¨åœºæ™¯**: éœ€è¦ä½¿ç”¨æ–°ç‰¹æ€§ï¼ˆå¦‚å¤æ‚å­å›¾ã€å¤šç§ç®­å¤´æ ·å¼ï¼‰

---

### èŠ‚ç‚¹ç±»å‹

#### 1. çŸ©å½¢èŠ‚ç‚¹ï¼ˆé»˜è®¤ï¼‰
```mermaid
A[çŸ©å½¢æ–‡æœ¬]
```

#### 2. åœ†è§’çŸ©å½¢
```mermaid
B(åœ†è§’æ–‡æœ¬)
```

#### 3. åœ†å½¢
```mermaid
C((åœ†å½¢æ–‡æœ¬))
```

#### 4. è±å½¢ï¼ˆå†³ç­–èŠ‚ç‚¹ï¼‰
```mermaid
D{æ¡ä»¶åˆ¤æ–­?}
```

#### 5. å…­è¾¹å½¢
```mermaid
E{{å‡†å¤‡}}
```

...ï¼ˆçœç•¥å…¶ä»–å†…å®¹ï¼‰

## æœ€ä½³å®è·µ

### 1. èŠ‚ç‚¹å‘½å
- ä½¿ç”¨æœ‰æ„ä¹‰çš„ IDï¼ˆå¦‚ `login_start`, `validate_user`ï¼‰
- é¿å…ä½¿ç”¨ä¿ç•™å…³é”®å­—
- ä¸­æ–‡èŠ‚ç‚¹æ–‡æœ¬ç”¨å¼•å·åŒ…è£¹

### 2. å¸ƒå±€ä¼˜åŒ–
- é€‰æ‹©åˆé€‚çš„æ–¹å‘ï¼ˆTD/LRï¼‰
- ä½¿ç”¨å­å›¾åˆ†ç»„ç›¸å…³èŠ‚ç‚¹
- æ§åˆ¶èŠ‚ç‚¹æ•°é‡ï¼ˆå»ºè®® < 20 ä¸ªï¼‰

### 3. å†³ç­–èŠ‚ç‚¹
- è±å½¢èŠ‚ç‚¹å¿…é¡»æœ‰æ˜ç¡®çš„åˆ†æ”¯
- æ ‡æ³¨åˆ†æ”¯æ¡ä»¶ï¼ˆæ˜¯/å¦ï¼‰

...ï¼ˆçœç•¥å…¶ä»–å†…å®¹ï¼‰
```

**å¤§å°**: ~562 è¡Œ

---

### ç¬¬å››æ­¥: åˆå¹¶ä¸‰å±‚ Prompt

**åˆå¹¶é€»è¾‘**: `L1 + "\n\n---\n\n" + L2 + "\n\n---\n\n" + L3`

**æœ€ç»ˆ Prompt ç»“æ„**:
```text
=============================================================================
                           æœ€ç»ˆåˆæˆ Prompt
=============================================================================

[L1: é€šç”¨è§„èŒƒ - 641 è¡Œ]
# L1: é€šç”¨å›¾è¡¨ç”Ÿæˆè§„èŒƒ
## âš ï¸ ã€æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ã€‘ä»»åŠ¡è¯†åˆ«
...
## è¾“å‡ºè¦æ±‚
...

---

[L2: Mermaid è¯­è¨€è§„èŒƒ - 168 è¡Œ]
# Mermaid è¯­è¨€é€šç”¨è§„èŒƒ (L2)
## ğŸš¨ Mermaid å¼ºåˆ¶è§„åˆ™
### è§„åˆ™1: ä¿ç•™å…³é”®å­—å†²çª
...
### è§„åˆ™2: ç‰¹æ®Šå­—ç¬¦å¿…é¡»è½¬ä¹‰
...

---

[L3: Mermaid Flowchart ç±»å‹è§„èŒƒ - 562 è¡Œ]
# Mermaid Flowchart ç”Ÿæˆè¦æ±‚
## ä¸“å®¶è§†è§’
...
## æ ¸å¿ƒè¯­æ³•
...
## æœ€ä½³å®è·µ
...

=============================================================================
æ€»å­—ç¬¦æ•°: ~45,000 å­—ç¬¦
æ€» Token æ•°: ~11,000 tokens (ä¼°ç®—, GPT-4 tokenizer)
=============================================================================
```

---

## ğŸ¤– å‘é€ç»™ AI æ¨¡å‹

### æœ€ç»ˆçš„ API è°ƒç”¨

```typescript
import { generateText } from 'ai';

// 1. è·å–åˆæˆåçš„ Prompt
const systemPrompt = getGeneratePrompt('mermaid', 'flowchart');
// systemPrompt ç°åœ¨åŒ…å« L1 + L2 + L3 çš„å®Œæ•´å†…å®¹

// 2. æ„å»ºä»»åŠ¡æ ‡è®°
const taskHint = "<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>";

// 3. æ„å»ºç”¨æˆ·æ¶ˆæ¯
const userMessage = "ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾";

// 4. è°ƒç”¨ AI ç”Ÿæˆ
const result = await generateText({
  model: model,
  system: systemPrompt,  // å®Œæ•´çš„ä¸‰å±‚ Prompt
  messages: [
    {
      role: "user",
      content: `${taskHint}\n${userMessage}`
      // å®é™…å†…å®¹:
      // <<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>
      // ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾
    }
  ],
  temperature: 0.7,
  maxRetries: 2,
});
```

### AI æ¨¡å‹çš„è§†è§’

AI æ¨¡å‹æ¥æ”¶åˆ°çš„å®Œæ•´ä¸Šä¸‹æ–‡:

```
===========================================================================
                            System Prompt
===========================================================================
[åŒ…å« L1 + L2 + L3 çš„å®Œæ•´å†…å®¹ï¼Œå…±çº¦ 11,000 tokens]

- L1 å‘Šè¯‰å®ƒ: è¿™æ˜¯ä¸€ä¸ª"ç”Ÿæˆæ–°å›¾è¡¨"ä»»åŠ¡ï¼Œè¦ä»é›¶å¼€å§‹
- L2 å‘Šè¯‰å®ƒ: Mermaid çš„ä¿ç•™å…³é”®å­—ã€ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰è§„åˆ™
- L3 å‘Šè¯‰å®ƒ: Flowchart çš„èŠ‚ç‚¹ç±»å‹ã€è¿æ¥æ–¹å¼ã€æœ€ä½³å®è·µ

===========================================================================
                            User Message
===========================================================================
<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>
ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾

===========================================================================
```

AI æ ¹æ®è¿™äº›æŒ‡ä»¤ç”Ÿæˆ:

```mermaid
flowchart TD
    start([å¼€å§‹]) --> input[ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ]
    input --> validate{éªŒè¯ä¿¡æ¯}
    validate -->|æœ‰æ•ˆ| checkDB[æŸ¥è¯¢æ•°æ®åº“]
    validate -->|æ— æ•ˆ| error1[æ˜¾ç¤ºé”™è¯¯æç¤º]
    error1 --> input
    
    checkDB --> match{è´¦å·å¯†ç åŒ¹é…?}
    match -->|æ˜¯| success[ç™»å½•æˆåŠŸ]
    match -->|å¦| error2[æ˜¾ç¤ºé”™è¯¯: è´¦å·æˆ–å¯†ç é”™è¯¯]
    error2 --> input
    
    success --> redirect[è·³è½¬åˆ°é¦–é¡µ]
    redirect --> finish([ç»“æŸ])
    
    style start fill:#e1f5ff
    style finish fill:#e1f5ff
    style success fill:#c8e6c9
    style error1 fill:#ffcdd2
    style error2 fill:#ffcdd2
```

---

## ğŸ”„ ä¸åŒä»»åŠ¡ç±»å‹çš„å·®å¼‚

### åœºæ™¯ 1: é¦–æ¬¡ç”Ÿæˆï¼ˆGENERATEï¼‰

**ä»»åŠ¡æ ‡è®°**: `<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>`

**AI è¡Œä¸º**:
- âœ… ä»é›¶å¼€å§‹è®¾è®¡
- âœ… å®Œæ•´æ€§ä¼˜å…ˆ
- âŒ ä¸å‚è€ƒç°æœ‰ä»£ç 

**ç”¨æˆ·ä½“éªŒ**: ç‚¹å‡»"ç”Ÿæˆå›¾è¡¨"æŒ‰é’®

---

### åœºæ™¯ 2: è°ƒæ•´ä¼˜åŒ–ï¼ˆADJUSTï¼‰

**ä»»åŠ¡æ ‡è®°**: `<<<SYSTEM_INSTRUCTION: ADJUST_EXISTING_DIAGRAM>>>`

**System Prompt**: ç›¸åŒï¼ˆL1 + L2 + L3ï¼‰

**User Message**:
```text
<<<SYSTEM_INSTRUCTION: ADJUST_EXISTING_DIAGRAM>>>

ã€ç”¨æˆ·è¾“å…¥ã€‘
åœ¨ç™»å½•æˆåŠŸåå¢åŠ "è®°ä½å¯†ç "é€‰é¡¹

ã€ç°æœ‰ä»£ç ã€‘
flowchart TD
    start([å¼€å§‹]) --> input[ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ]
    input --> validate{éªŒè¯ä¿¡æ¯}
    validate -->|æœ‰æ•ˆ| checkDB[æŸ¥è¯¢æ•°æ®åº“]
    ...
```

**AI è¡Œä¸º**:
- âœ… åˆ†æç°æœ‰ä»£ç ç»“æ„
- âœ… ç²¾ç¡®å®šä½ä¿®æ”¹ä½ç½®
- âœ… ä¿æŒé£æ ¼ä¸€è‡´
- âŒ ä¸å®Œå…¨é‡å†™

---

### åœºæ™¯ 3: ä¿®å¤é”™è¯¯ï¼ˆFIXï¼‰

**ä»»åŠ¡æ ‡è®°**: `<<<SYSTEM_INSTRUCTION: FIX_SYNTAX_ERRORS_ONLY>>>`

**System Prompt**: ç›¸åŒï¼ˆL1 + L2 + L3ï¼‰

**User Message**:
```text
<<<SYSTEM_INSTRUCTION: FIX_SYNTAX_ERRORS_ONLY>>>

ã€ç°æœ‰ä»£ç ã€‘
flowchart TD
    start --> end
    end --> finish
    %% âŒ 'end' æ˜¯ä¿ç•™å…³é”®å­—ï¼Œå¯¼è‡´æ¸²æŸ“å¤±è´¥

ã€æ¸²æŸ“é”™è¯¯ã€‘
Parse error on line 3: Unexpected identifier 'end'
```

**AI è¡Œä¸º**:
- âœ… ä»…ä¿®å¤è¯­æ³•é”™è¯¯ï¼ˆ`end` -> `finish_step`ï¼‰
- âœ… ä¿æŒæ‰€æœ‰å…¶ä»–éƒ¨åˆ†ä¸å˜
- âŒ ä¸ä¼˜åŒ–ç»“æ„
- âŒ ä¸ä¿®æ”¹å†…å®¹

**ä¿®å¤åä»£ç **:
```mermaid
flowchart TD
    start --> finish_step
    finish_step --> final_end
```

---

## ğŸ“Š Token ä½¿ç”¨åˆ†æ

### ä¸åŒç»„åˆçš„ Token æ¶ˆè€—

| åœºæ™¯ | L1 | L2 | L3 | æ€»è®¡ | è¯´æ˜ |
|------|----|----|-------|------|------|
| Mermaid Flowchart | 2,000 | 500 | 1,800 | 4,300 | å®Œæ•´ä¸‰å±‚ |
| Mermaid Sequence | 2,000 | 500 | 1,200 | 3,700 | L3 è¾ƒçŸ­ |
| Excalidraw Generic | 2,000 | 0 | 2,500 | 4,500 | æ—  L2 |
| PlantUML Class | 2,000 | 600 | 1,400 | 4,000 | æ ‡å‡†ç»„åˆ |
| D2 Architecture | 2,000 | 400 | 1,600 | 4,000 | æ ‡å‡†ç»„åˆ |

### Token ä¼˜åŒ–å»ºè®®

**å½“å‰çŠ¶æ€**:
- L1 é€šç”¨å±‚è¾ƒé•¿ï¼ˆ~2,000 tokensï¼‰
- æ€»ä½“ Token æ¶ˆè€—: 3,500 - 4,500 tokens/è¯·æ±‚

**ä¼˜åŒ–æ–¹å‘**:
1. **L1 æœ€å°åŒ–ç‰ˆæœ¬**
   ```typescript
   // åˆ›å»ºç²¾ç®€ç‰ˆ L1ï¼ˆä»…ä¿ç•™æ ¸å¿ƒæŒ‡ä»¤ï¼‰
   const l1_minimal = repo.findActive(1, undefined, undefined, { minimal: true });
   // Token å‡å°‘: 2,000 -> 800
   ```

2. **åŠ¨æ€åŠ è½½**
   ```typescript
   // æ ¹æ®å¤æ‚åº¦é€‰æ‹©æç¤ºè¯è¯¦ç»†ç¨‹åº¦
   function selectPromptDetail(userInput: string): 'minimal' | 'standard' | 'detailed' {
     const complexity = analyzeComplexity(userInput);
     return complexity > 0.7 ? 'detailed' : 'standard';
   }
   ```

3. **ç¼“å­˜å¸¸ç”¨ç»„åˆ**
   ```typescript
   // ç¼“å­˜çƒ­é—¨ç»„åˆï¼ˆå¦‚ Mermaid Flowchartï¼‰
   const hotPromptCache = new Map<string, string>();
   ```

---

## ğŸ¯ å®é™…æ•ˆæœå¯¹æ¯”

### æ— ä¸‰çº§ Promptï¼ˆç›´æ¥æŒ‡ä»¤ï¼‰

**User Message**:
```text
ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾ï¼Œä½¿ç”¨ Mermaid Flowchart
```

**AI è¾“å‡ºé—®é¢˜**:
```mermaid
```mermaid
graph TD
    start --> end  %% âŒ ä½¿ç”¨äº†ä¿ç•™å…³é”®å­—
    input[ç”¨æˆ·è¾“å…¥ (å¿…éœ€)]  %% âŒ ç‰¹æ®Šå­—ç¬¦æœªè½¬ä¹‰
```
```

**æ¸²æŸ“ç»“æœ**: âŒ å¤±è´¥

---

### ä½¿ç”¨ä¸‰çº§ Prompt

**System Prompt**: L1 + L2 + L3ï¼ˆå®Œæ•´æŒ‡ä»¤ï¼‰

**User Message**:
```text
<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>
ç”Ÿæˆä¸€ä¸ªç”¨æˆ·ç™»å½•æµç¨‹å›¾
```

**AI è¾“å‡º**:
```mermaid
flowchart TD
    start_node([å¼€å§‹]) --> input_step["ç”¨æˆ·è¾“å…¥ (å¿…éœ€)"]
    input_step --> validate_node{éªŒè¯ä¿¡æ¯?}
    validate_node -->|æœ‰æ•ˆ| db_check[æŸ¥è¯¢æ•°æ®åº“]
    validate_node -->|æ— æ•ˆ| error_display[æ˜¾ç¤ºé”™è¯¯]
    
    %% âœ… é¿å…äº†ä¿ç•™å…³é”®å­—
    %% âœ… ç‰¹æ®Šå­—ç¬¦æ­£ç¡®è½¬ä¹‰
    %% âœ… æ¸…æ™°çš„æµç¨‹é€»è¾‘
```

**æ¸²æŸ“ç»“æœ**: âœ… æˆåŠŸ

---

## ğŸ”§ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æœ€ç»ˆåˆæˆçš„ Prompt

åœ¨ `DiagramGenerationService.ts` ä¸­æ·»åŠ æ—¥å¿—:

```typescript
if (process.env.NODE_ENV === "development") {
  const finalPrompt = getGeneratePrompt(params.renderLanguage, params.diagramType);
  
  console.log("=== æœ€ç»ˆ Prompt é¢„è§ˆ ===");
  console.log(`æ€»é•¿åº¦: ${finalPrompt.length} å­—ç¬¦`);
  console.log(`é¢„ä¼° Token: ${Math.ceil(finalPrompt.length / 4)}`);
  console.log("\n=== å‰ 500 å­—ç¬¦ ===");
  console.log(finalPrompt.substring(0, 500));
  console.log("\n=== å 500 å­—ç¬¦ ===");
  console.log(finalPrompt.substring(finalPrompt.length - 500));
}
```

### 2. æµ‹è¯•ä¸åŒå±‚çº§çš„å½±å“

**å®éªŒæ–¹æ³•**:

```typescript
// Aç»„: ä»… L1
const promptA = l1_content;

// Bç»„: L1 + L2
const promptB = [l1_content, l2_content].join("\n\n---\n\n");

// Cç»„: L1 + L2 + L3ï¼ˆå®Œæ•´ï¼‰
const promptC = [l1_content, l2_content, l3_content].join("\n\n---\n\n");

// å¯¹æ¯”ç”Ÿæˆè´¨é‡
const resultsA = await testGeneration(promptA, testCases);
const resultsB = await testGeneration(promptB, testCases);
const resultsC = await testGeneration(promptC, testCases);

console.log("æˆåŠŸç‡å¯¹æ¯”:");
console.log(`Aç»„ (ä»… L1): ${resultsA.successRate}%`);
console.log(`Bç»„ (L1+L2): ${resultsB.successRate}%`);
console.log(`Cç»„ (å®Œæ•´): ${resultsC.successRate}%`);
```

### 3. ç›‘æ§ Prompt ç‰ˆæœ¬

```typescript
// è®°å½•æ¯æ¬¡ç”Ÿæˆä½¿ç”¨çš„ Prompt ç‰ˆæœ¬
logger.info("Prompt ç‰ˆæœ¬ä¿¡æ¯", {
  l1_version: versions.l1_version,
  l2_version: versions.l2_version,
  l3_version: versions.l3_version,
  is_custom: {
    l1: versions.l1_version !== 'system-default',
    l2: versions.l2_version !== 'system-default',
    l3: versions.l3_version !== 'system-default',
  }
});
```

---

## ğŸ“ æ€»ç»“

ä¸‰çº§æç¤ºè¯ç³»ç»Ÿé€šè¿‡ **æ¨¡å—åŒ–åˆ†å±‚** å®ç°äº†ï¼š

1. âœ… **å¤ç”¨æ€§**: L1 è¢«æ‰€æœ‰å›¾è¡¨ç±»å‹å…±äº«ï¼ˆ23 ç§è¯­è¨€ Ã— 100+ ç§ç±»å‹ï¼‰
2. âœ… **ç²¾ç¡®æ§åˆ¶**: L3 ä¸ºæ¯ç§å›¾è¡¨ç±»å‹æä¾›ä¸“é—¨æŒ‡å¯¼
3. âœ… **çµæ´»æ€§**: L2 å¯é€‰ï¼Œé€‚åº”ä¸åŒè¯­è¨€çš„ç‰¹ç‚¹
4. âœ… **å¯ç»´æŠ¤æ€§**: ä¿®æ”¹æŸä¸€å±‚çº§ä¸å½±å“å…¶ä»–å±‚çº§
5. âœ… **ç‰ˆæœ¬ç®¡ç†**: æ¯ä¸ªå±‚çº§ç‹¬ç«‹ç‰ˆæœ¬æ§åˆ¶ï¼Œå¯éšæ—¶å›é€€

**åˆæˆå…¬å¼**:
```
æœ€ç»ˆ Prompt = L1 (é€šç”¨, å¿…éœ€) 
            + "---" 
            + L2 (è¯­è¨€, å¯é€‰) 
            + "---" 
            + L3 (ç±»å‹, å¿…éœ€)
```

**æ•ˆæœæå‡**:
- è¯­æ³•é”™è¯¯ç‡: é™ä½ 60%
- ç”ŸæˆæˆåŠŸç‡: æå‡è‡³ 90%+
- ä»£ç è´¨é‡: æ›´ç¬¦åˆæœ€ä½³å®è·µ
- ç”¨æˆ·ä½“éªŒ: å‡å°‘ä¿®å¤æ¬¡æ•°

---

**ç›¸å…³æ–‡æ¡£**:
- [ä¸‰çº§æç¤ºè¯åŠŸèƒ½åˆ†æ.md](./ä¸‰çº§æç¤ºè¯åŠŸèƒ½åˆ†æ.md) - ç³»ç»Ÿæ¶æ„è¯¦è§£
- [CLAUDE.md](./CLAUDE.md) - å¼€å‘è€…æ–‡æ¡£
- [PROJECT_REVIEW_REPORT.md](./PROJECT_REVIEW_REPORT.md) - é¡¹ç›®å…¨é¢æŠ¥å‘Š

