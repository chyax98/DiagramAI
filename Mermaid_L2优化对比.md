# Mermaid L2 层优化对比

## 📊 优化效果

| 项目         | 原版   | 优化版 | 改进    |
| ------------ | ------ | ------ | ------- |
| **字符数**   | 3,915  | 1,795  | ↓ 54.2% |
| **Token 数** | 980    | 448    | ↓ 54.3% |
| **行数**     | 168    | 62     | ↓ 63.1% |
| **成本/次**  | $0.029 | $0.013 | ↓ 54.5% |

### 成本节省计算（仅 L2 部分）

```
单次请求节省:
  原版: 980 tokens × $0.03/1K = $0.029
  优化: 448 tokens × $0.03/1K = $0.013
  节省: $0.016 (54.5%)

月度节省 (30,000 次):
  $0.016 × 30,000 = $480/月

年度节省:
  $480 × 12 = $5,760/年 💰
```

---

## 🎯 优化策略

### 1. 保留关键字列表压缩

**变更前** (180 字):

```
**全局保留关键字**（不能用作节点 ID）:
```

graph, subgraph, end, flowchart, direction,
class, classDef, style, click, call, href, callback,
title, section, note

````

**检测方法**: 在生成前扫描所有节点 ID，与保留关键字列表对比。

**错误示例**:
```mermaid
graph TD
    end --> start  %% ❌ 'end' 是保留关键字
````

**正确写法**:

```mermaid
graph TD
    finish[结束] --> start[开始]
```

```

**变更后** (90 字):
```

### 1. 保留关键字禁用

**不可作为节点 ID**: graph, subgraph, end, flowchart, direction, class, classDef, style, click, call, href, callback, title, section, note

❌ `end --> start`  
✅ `finish[结束] --> start[开始]`

````

压缩率: 50% ✅

---

### 2. 删除详细示例代码块

**变更前** (每个规则都有完整的代码块示例):
```mermaid
graph TD
    A["用户输入 (必需)"] --> B["{data: value}"]
    B --> C["结果 > 100"]
````

**变更后** (只保留一行对比):

```
❌ `A[用户输入 (必需)]`
✅ `A["用户输入 (必需)"]`
```

压缩率: 75% ✅

---

### 3. 删除低优先级内容

**删除的章节**:

- ❌ **子图 (Subgraph)** - 应该在需要子图的 L3 中详细说明
- ❌ **样式定义** - 应该在 L3 中根据图表类型说明
- ❌ 详细的语法教程 - L2 只保留强制规则

**原因**:

- 子图不是所有 Mermaid 图表都支持
- 样式定义因图表类型而异
- L2 应该只关注跨所有 Mermaid 图表的共同规则

---

### 4. 压缩检查清单

**变更前** (150 字):

```
## 🔍 生成时检查清单（Mermaid 通用）

生成 Mermaid 图表代码后，执行以下通用检查：

1. ✅ **保留关键字检查**: 节点 ID 不在保留关键字列表中
2. ✅ **特殊字符检查**: 所有含特殊字符的文本已用 `"..."` 包裹
3. ✅ **注释格式**: 所有注释以 `%%` 开头
4. ✅ **箭头语法**: 使用了该图表类型的正确箭头
5. ✅ **代码完整性**: 无占位符、无省略（见 L1）

**图表特定检查**: 见各 L3 文件末尾的详细清单。
```

**变更后** (80 字):

```
## ✅ Mermaid 通用检查

生成后快速检查：
1. 节点 ID 不在保留关键字列表中
2. 特殊字符已用 `"..."` 包裹
3. 注释以 `%%` 开头
4. 箭头语法匹配图表类型
5. 大小写一致

**图表特定检查**: 见各 L3 文件
```

压缩率: 47% ✅

---

## 📋 内容对比

### 保留的核心内容

| 内容           | 原版      | 优化版      | 说明     |
| -------------- | --------- | ----------- | -------- |
| 保留关键字列表 | ✅ 详细   | ✅ 一行列出 | 必须内容 |
| 特殊字符转义   | ✅ 多示例 | ✅ 精简版   | 必须内容 |
| 注释语法       | ✅ 详细   | ✅ 精简     | 必须内容 |
| 箭头语法       | ✅ 详细   | ✅ 精简列表 | 必须内容 |
| 大小写敏感     | ✅ 详细   | ✅ 一句话   | 重要规则 |
| Kroki 限制     | ✅ 简述   | ✅ 保留     | 实际问题 |
| 检查清单       | ✅ 详细   | ✅ 5 要点   | 核心检查 |

### 删除的内容

| 内容            | 原因                                 |
| --------------- | ------------------------------------ |
| 子图 (Subgraph) | 应该在支持子图的 L3 中详细说明       |
| 样式定义        | 不同图表类型样式不同，应该在 L3 说明 |
| 详细示例代码块  | 占用空间大，保留简单对比即可         |
| 检测方法说明    | 过于详细，AI 模型能理解规则          |

---

## 📐 优化后的结构

```
L2: Mermaid 通用规范 (1,795 字符)

├── 强制规则 (800 字符) - 45%
│   ├── 保留关键字禁用
│   ├── 特殊字符转义
│   ├── 注释语法
│   └── 箭头语法匹配
│
├── 语法共性 (400 字符) - 22%
│   ├── 分隔符和字符串
│   └── 大小写敏感
│
├── Kroki 限制 (200 字符) - 11%
│
└── 通用检查 (395 字符) - 22%
```

---

## ✅ 优化亮点

### 1. 保留关键字列表一行化

```
原版 (多行):
```

graph, subgraph, end, flowchart, direction,
class, classDef, style, click, call, href, callback,
title, section, note

```

优化 (一行):
graph, subgraph, end, flowchart, direction, class, classDef, style, click, call, href, callback, title, section, note
```

**效果**:

- 更紧凑，易于扫描
- 不损失任何信息
- 节省 50% 空间

---

### 2. 错误示例最小化

````
原版 (完整代码块):
```mermaid
graph TD
    end --> start  %% ❌ 'end' 是保留关键字
````

优化 (一行对比):
❌ `end --> start`  
✅ `finish[结束] --> start[开始]`

```

**效果**:
- 清晰对比错误和正确写法
- 节省 75% 空间
- 更容易理解

---

### 3. 删除冗余章节

**删除子图和样式章节的理由**:

```

原版包含:
├── 子图 (Subgraph) - 250 字
└── 样式定义 - 300 字

问题:

1. 不是所有 Mermaid 图表都支持子图
   - Flowchart: ✅ 支持
   - Sequence: ❌ 不支持
   - Pie: ❌ 不支持
2. 样式定义因图表类型而异
   - 应该在各 L3 中详细说明

解决方案:
└── 移到 L3，在需要的图表类型中详细说明

```

**效果**: 节省 550 字符

---

## 🧪 质量保证

### 核心规则完整性检查

优化后是否保留了所有必需内容？

| 规则 | 保留 | 说明 |
|------|------|------|
| 保留关键字列表 | ✅ | 完整列出所有关键字 |
| 特殊字符列表 | ✅ | 完整列出所有特殊字符 |
| 转义方法 | ✅ | 用双引号包裹 |
| 注释语法 | ✅ | `%%` 单行注释 |
| 箭头语法 | ✅ | 列出主要图表类型的箭头 |
| 大小写敏感 | ✅ | 明确说明 |
| Kroki 限制 | ✅ | 提醒 Sequence 限制 |

**结论**: ✅ 所有核心规则都保留了

---

## 📊 与 L1 和 L3 的配合

### L1 + L2 + L3 的分工

```

L1 (通用层):
├── 任务识别 (GENERATE/ADJUST/FIX)
├── 专家视角定义
├── 核心原则 (准确、简洁、中文、完整)
├── 通用命名规范 (ID 英文、标签中文)
└── 通用特殊字符处理原则

L2 (Mermaid 层): ← 本次优化
├── Mermaid 保留关键字列表 (具体)
├── Mermaid 特殊字符列表 (具体)
├── Mermaid 注释语法 (具体: %%)
├── Mermaid 箭头语法 (具体: 不同图表类型)
├── Mermaid 大小写敏感 (具体规则)
└── Kroki 引擎限制 (实际环境)

L3 (Flowchart/Sequence/... 层):
├── 该图表类型的核心语法
├── 节点类型和形状
├── 连接线详细语法
├── 子图使用 (如支持)
├── 样式定制 (该类型特有)
└── 最佳实践

````

**分工明确**: ✅ 没有重复，各司其职

---

## 🚀 使用建议

### 1. 查看优化版本

```bash
# 查看优化版本
cat data/prompts/mermaid/common_optimized.txt

# 对比原版和优化版
diff data/prompts/mermaid/common.txt data/prompts/mermaid/common_optimized.txt
````

### 2. 测试场景

优先测试以下 Mermaid 图表类型：

```bash
测试 1: Flowchart - 验证保留关键字和特殊字符
测试 2: Sequence - 验证箭头语法和大小写
测试 3: Class - 验证大小写敏感
测试 4: State - 验证基本规则
测试 5: 混合场景 - 验证所有规则
```

### 3. 回滚准备

```bash
# 如有问题，快速回滚
cp data/prompts/mermaid/common.txt data/prompts/mermaid/common_backup.txt
cp data/prompts/mermaid/common_optimized.txt data/prompts/mermaid/common.txt

# 回滚
mv data/prompts/mermaid/common_backup.txt data/prompts/mermaid/common.txt
```

---

## 💡 后续优化建议

### 1. 其他语言的 L2

如果 Mermaid L2 效果好，可以优化其他语言：

```
优先级排序（按使用频率）:
1. PlantUML (8,202 字符) - 压缩到 1,600
2. D2 (待测量) - 压缩到 1,600
3. Excalidraw (待测量) - 压缩到 1,600
4. Graphviz (待测量) - 压缩到 1,600
...
```

### 2. 动态加载策略

```typescript
// 根据图表复杂度选择 L2 版本
function selectL2Version(diagramType: string, complexity: number): string {
  // 简单图表 (< 10 节点) → 使用最小化 L2
  if (complexity < 0.3) {
    return loadL2Minimal(diagramType);
  }

  // 复杂图表 (> 30 节点) → 使用完整 L2
  if (complexity > 0.7) {
    return loadL2Full(diagramType);
  }

  // 中等复杂度 → 使用优化版 L2
  return loadL2Optimized(diagramType);
}
```

---

## 📈 累计优化效果

### 已完成优化

| 层级       | 原版               | 优化版            | 压缩率    | 节省             |
| ---------- | ------------------ | ----------------- | --------- | ---------------- |
| L1 通用    | 18,318 (4,500)     | 3,143 (785)       | 82.8%     | 3,715 tokens     |
| L2 Mermaid | 3,915 (980)        | 1,795 (448)       | 54.2%     | 532 tokens       |
| **小计**   | **22,233 (5,480)** | **4,938 (1,233)** | **77.5%** | **4,247 tokens** |

### 预计整体效果 (L1+L2+L3)

```
原版合计: 9,100 tokens
优化后 (目标): 2,000 tokens

已完成:
├── L1: 4,500 → 785 tokens (✅ 完成)
├── L2: 980 → 448 tokens (✅ 完成，本次)
└── L3: 3,600 → 767 tokens (待完成，目标 800)

进度: 2/3 完成 (67%)
已节省: 4,247 tokens (46.6%)
剩余目标: 再节省 2,853 tokens (L3 优化)
```

---

## ✅ 总结

### 核心成果

```
1. ✅ 将 Mermaid L2 从 980 tokens 压缩到 448 tokens
2. ✅ 压缩率 54.2%，节省成本 54.5%
3. ✅ 保留了所有核心强制规则
4. ✅ 删除了应该在 L3 的内容（子图、样式）
5. ✅ 与 L1 和 L3 分工更明确
```

### 关键改进

- 保留关键字列表一行化
- 删除详细代码块示例
- 删除子图和样式章节（移到 L3）
- 压缩检查清单为 5 要点

### 质量保证

- 所有核心规则都保留
- 与 L1 和 L3 无重复
- 分工明确，职责清晰

---

**创建时间**: 2025-10-18  
**优化版本**: v2.0-optimized  
**压缩率**: 54.2%  
**状态**: ✅ 已完成，待测试
