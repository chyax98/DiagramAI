# Nomnoml Prompt System Deep Review Report

> **审查日期**: 2025-10-13
> **审查语言**: Nomnoml (Simplified UML)
> **Prompt 文件位置**: `/root/Diagram/DiagramAI/src/lib/constants/prompts/nomnoml/`
> **知识库位置**: `/root/Diagram/DiagramAI/docs/kroki/nomnoml/`

---

## 执行摘要

本次审查对 Nomnoml 简化 UML 语言的 Prompt 系统进行了全面的技术审计,覆盖 **1 个 L2 通用规范文件** 和 **4 个 L3 图表类型文件**(class, component, architecture, flowchart)。

### 总体评分: 88/100 (优秀)

| 维度 | 得分 | 满分 | 评级 |
|------|------|------|------|
| **A. 语法规则准确性** | 28/30 | 30 | ⭐⭐⭐⭐⭐ 优秀 |
| **B. 常见错误覆盖度** | 23/25 | 25 | ⭐⭐⭐⭐⭐ 优秀 |
| **C. 示例代码质量** | 22/25 | 25 | ⭐⭐⭐⭐☆ 良好 |
| **D. AI 可理解性** | 12/15 | 15 | ⭐⭐⭐⭐☆ 良好 |
| **E. L2/L3 协调性** | 3/5 | 5 | ⭐⭐⭐☆☆ 中等 |
| **总分** | **88/100** | 100 | ⭐⭐⭐⭐☆ |

### 关键发现

**✅ 优势** (Strengths):
1. **L2 通用规范极其完善** - `common.txt` 包含 5 条强制规则,详细覆盖 Nomnoml 的核心语法陷阱
2. **错误处理系统完善** - 每条强制规则都配有 Kroki 编译错误信息示例,极大提升 AI 修复能力
3. **分类器类型完整** - 覆盖所有 10+ 种内置类型(class, abstract, start, end, choice, actor, database 等)
4. **关系符号全面** - 准确定义 9 种关系类型及其 UML 含义
5. **Flowchart 专精度高** - flowchart.txt 对流程图场景进行了深度优化,包含判断节点、循环结构、分组语法的完整指导

**⚠️ 改进点** (Improvements Needed):
1. **L3 文件缺少符号对照表** - 所有 L3 文件都未提供关系符号的快速参考表格(应从 L2 继承)
2. **检查清单与强制规则不一致** - class.txt 检查清单遗漏"指令位置规则"检查项
3. **Flowchart 样式配置重复** - flowchart.txt 底部样式推荐配置与 L2 重复,应删除并引用 L2
4. **Architecture 技术栈示例不够丰富** - architecture.txt 仅展示 Node.js 栈,应补充 Java/Python/Go 等主流技术栈示例

---

## 评分细节

### A. 语法规则准确性 (28/30 分)

#### ✅ 完全准确的规则 (26/30)

**1. 分类器类型定义 (10/10 分)**

L2 `common.txt` 准确定义了所有 10+ 种分类器类型:

| 类型 | 定义位置 | 视觉效果 | 使用场景 |
|------|----------|----------|----------|
| `[NormalClass]` | L159-160 | 矩形 | 普通类 |
| `[<abstract>]` | L161 | 斜体 | 抽象类 |
| `[<instance>]` | L162 | 下划线 | 实例对象 |
| `[<package>]` | L163 | 文件夹形 | 包/模块 |
| `[<frame>]` | L164 | 框架 | 系统边界 |
| `[<database>]` | L165 | 圆柱形 | 数据库 |
| `[<note>]` | L166 | 便签形 | 注释 |
| `[<socket>]` | L169 | 插座形 | 需要接口 |
| `[<lollipop>]` | L170 | 棒棒糖 | 提供接口 |
| `[<start>]` | L173 | 圆形 | 流程起点 |
| `[<end>]` | L174 | 圆形 | 流程终点 |
| `[<state>]` | L175 | 圆角矩形 | 状态 |
| `[<choice>]` | L176 | 菱形 | 判断节点 |
| `[<actor>]` | L179 | 人形 | 参与者 |
| `[<usecase>]` | L180 | 椭圆形 | 用例 |

**验证**: 与官方文档 `official-docs.md` (L46-101) 完全一致 ✅

**2. 关系符号完整性 (8/10 分)**

L2 定义了 9 种关系类型 (L147-158):

| 符号 | 类型 | UML 含义 | 准确性 |
|------|------|----------|--------|
| `->` | 关联 | A 认识 B | ✅ |
| `-->` | 依赖 | A 依赖 B | ✅ |
| `-:>` | 泛化 | B 继承 A | ✅ |
| `<:-` | 泛化(反向) | A 继承 B | ✅ |
| `--:>` | 实现 | B 实现 A | ✅ |
| `+->` | 组合 | 强拥有 | ✅ |
| `o->` | 聚合 | 弱拥有 | ✅ |
| `--` | 注释连接 | 关联注释 | ✅ |
| `-/-` | 隐藏连接 | 布局用 | ✅ |

**扣分原因 (-2 分)**:
- 未提供 **双向箭头** `<->` 的定义(官方文档 L27 明确支持)
- 未提供 **球窝关系** `-o)`, `o<-)`, `->o` 的说明(官方文档 L38-40)

**3. 指令语法准确性 (8/10 分)**

L2 定义了 10 个常用指令 (L187-201):

| 指令 | 默认值 | 准确性 | 备注 |
|------|--------|--------|------|
| `#direction` | down | ✅ | 支持 down/right |
| `#stroke` | #333333 | ✅ | 线条颜色 |
| `#fill` | #ffffff | ✅ | 填充颜色 |
| `#background` | #f5f5f5 | ⚠️ | 官方默认 transparent |
| `#fontSize` | 12 | ✅ | 字体大小 |
| `#spacing` | 40 | ✅ | 节点间距 |
| `#padding` | 8 | ✅ | 节点内边距 |
| `#lineWidth` | 2 | ⚠️ | 官方默认 1 |
| `#visual` | visualizer | ✅ | visualizer/handDrawn |

**扣分原因 (-2 分)**:
- `#background` 默认值错误(官方为 `transparent`)
- `#lineWidth` 默认值错误(官方为 `1`)

#### ⚠️ 需要改进的规则 (2 分扣分)

**问题 1: 缺少箭头修饰符说明**

官方文档支持的箭头修饰符:
- `#arrowSize: 1` (箭头大小)
- `#fillArrows: false` (是否填充箭头)

L2 未提及,应补充到指令章节。

---

### B. 常见错误覆盖度 (23/25 分)

#### ✅ 完整覆盖的错误类型 (21/25)

**L2 `common.txt` 的 5 条强制规则**:

| 规则编号 | 错误类型 | 错误示例位置 | Kroki 错误信息 | 覆盖度 |
|---------|---------|-------------|---------------|--------|
| ⚠️ 规则 1 | 分隔符错误 | L10-11 | L19-24 | ✅ 完整 |
| ⚠️ 规则 2 | 继承方向错误 | L32-33 | L42-46 | ✅ 完整 |
| ⚠️ 规则 3 | 类区域顺序错误 | L54-59 | L71-76 | ✅ 完整 |
| ⚠️ 规则 4 | 分类器标签位置错误 | L85 | L93-98 | ✅ 完整 |
| ⚠️ 规则 5 | 指令位置错误 | L107-108 | L118-121 | ✅ 完整 |

**强制规则系统的优势**:
1. **错误预防性强** - 每条规则都以 `⚠️` 开头,明确标识为编译错误级别
2. **Kroki 错误信息完整** - 每条规则都提供了 Kroki 实际返回的错误信息,AI 可以精确匹配修复
3. **错误后果清晰** - 区分"编译失败"和"语义错误",优先级明确

**L3 文件的错误覆盖**:

| 文件 | 错误章节 | 错误数量 | 覆盖场景 |
|------|---------|---------|---------|
| `class.txt` | L359-471 | 6 个 | 属性分隔、继承方向、组合聚合混淆、类区域顺序、抽象类标签、多重性标注 |
| `component.txt` | L211-341 | 6 个 | 组件/类混淆、接口表示、依赖方向、嵌套过深、数据库标签、package/frame 混用 |
| `architecture.txt` | L372-522 | 6 个 | 层次不清、技术栈缺失、数据流不明、外部系统未标识、嵌套过深、缺少说明 |
| `flowchart.txt` | L289-449 | 7 个 | 方向指令位置、判断节点缺标签、分组语法、特殊字符、样式位置、嵌套过深、连接方向混乱 |

**总计**: **25 个常见错误类型**,覆盖语法、语义、布局、样式四大类。

#### ⚠️ 遗漏的错误类型 (-2 分)

**1. 注释语法错误 (已在 L2 提及,但未标记为强制规则)**

L2 `common.txt` L203-219 提到注释语法,但未列入"强制规则"章节,导致 AI 可能忽略:

```nomnoml
// ❌ 错误:行中注释不支持
[ClassA] -> [ClassB]  // 这样会报错
```

**建议**: 将注释语法提升为 **⚠️ 规则 6**,并补充 Kroki 错误信息。

**2. 嵌套结构缺少缩进导致语法混乱**

L2 L347-366 提到缩进规范,但未明确指出**缺少缩进不会报错,但极易导致逻辑错误**:

```nomnoml
// ❌ 可读性差
[Engine|
[Cylinder] -> [Piston]
]

// ✅ 正确
[Engine|
  [Cylinder] -> [Piston]
]
```

**建议**: 补充为 **警告级别规则**,强调"虽然不报错,但必须缩进"。

---

### C. 示例代码质量 (22/25 分)

#### ✅ 优秀的示例设计 (20/25)

**示例复杂度层次分析**:

| 文件 | 简单示例 | 中等示例 | 高级示例 | 层次完整性 |
|------|---------|---------|---------|-----------|
| `class.txt` | ✅ 示例 1 (L112-150) | ✅ 示例 2 (L157-217) | ✅ 示例 3 (L224-283) + 示例 4 (L290-351) | ⭐⭐⭐⭐⭐ |
| `component.txt` | ✅ 示例 1 (L78-105) | ✅ 示例 2 (L112-157) | ✅ 示例 3 (L164-203) | ⭐⭐⭐⭐⭐ |
| `architecture.txt` | ✅ 示例 1 (L85-136) | ✅ 示例 2 (L143-239) | ✅ 示例 3 (L248-362) | ⭐⭐⭐⭐⭐ |
| `flowchart.txt` | ✅ 示例 1 (L157-171) | ✅ 示例 2 (L178-214) | ✅ 示例 3 (L221-278) | ⭐⭐⭐⭐⭐ |

**示例代码的技术亮点**:

**1. 完整的样式配置展示**

Flowchart 示例 3 (L221-278) 展示了完整的样式系统:
```nomnoml
#direction: down
#fill: #FEFECE
#stroke: #A80036
#visual: visualizer
#fontSize: 12
#spacing: 40
#padding: 8
```

**2. 实际业务场景丰富**

| 场景类型 | 示例位置 | 业务价值 |
|---------|---------|---------|
| 图书管理系统 | class.txt L112-150 | 典型的实体关系建模 |
| 电商订单系统 | class.txt L157-217 | 继承+组合+聚合综合运用 |
| 策略模式 | class.txt L224-283 | 设计模式标准实现 |
| 集合类库 | class.txt L290-351 | 泛型和接口设计 |
| Web 三层架构 | component.txt L78-105 | 经典架构模式 |
| 微服务架构 | component.txt L112-157 | 现代分布式系统 |
| 插件化架构 | component.txt L164-203 | 接口解耦设计 |
| 云原生架构 | architecture.txt L248-362 | K8s + Docker 完整栈 |
| 审批流程 | flowchart.txt L221-278 | 复杂业务流程 |

**3. 注释系统完善**

所有示例都包含 **关键点** 章节,清晰解释:
- 使用的语法特性
- 设计决策的原因
- 与 UML 标准的对应关系

例如 class.txt L217-222:
```
**关键点**:
- 使用 `<abstract>` 标签表示抽象类
- `-:>` 表示继承关系(子类指向父类)
- `+->` 表示组合关系(Order 拥有 OrderItem)
```

#### ⚠️ 需要改进的示例 (-5 分)

**1. 缺少"失败示例" (-2 分)**

所有 L3 文件的示例都是正确的,但缺少 **刻意设计的失败案例**,AI 无法学习"什么样的代码会导致渲染失败"。

**建议**: 在每个示例章节补充 **反面教材**:

```nomnoml
// ❌ 失败示例:会导致 Kroki 400 错误
[Person| name: String, age: int]  // 逗号分隔

// ✅ 正确示例
[Person| name: String; age: int]  // 分号分隔
```

**2. 高级示例缺少渲染验证说明 (-1 分)**

Architecture 示例 3 (云原生架构) 包含 **60+ 个节点**,接近 Kroki 的复杂度上限,但未提供:
- 预期渲染时间(是否会超时)
- 简化建议(如何拆分)
- 节点数量限制警告

**建议**: 补充渲染性能警告:

```
**渲染性能说明**:
- 节点数量: 62 个
- 预期渲染时间: 3-5 秒
- 复杂度评级: ⚠️ 高(接近上限)
- 简化建议: 可拆分为前端/后端/基础设施三个独立图表
```

**3. 缺少"边缘场景"示例 (-2 分)**

所有示例都是标准场景,缺少边缘情况:
- **空节点**: `[EmptyNode]` (合法但无意义)
- **超长名称**: 如何处理 50+ 字符的类名?
- **特殊字符**: 中文、Emoji、数学符号的兼容性
- **循环引用**: `[A] -> [B]`, `[B] -> [A]` 的布局效果

**建议**: 在 L2 补充"边缘场景处理指南"。

---

### D. AI 可理解性 (12/15 分)

#### ✅ 优秀的结构化设计 (10/15)

**1. 强制规则系统 ⭐⭐⭐⭐⭐**

L2 的 5 条强制规则采用 **警告图标 + 规则编号 + 错误后果** 的三段式结构:

```
⚠️ 规则 1: 分隔符使用规则
❌ 错误示例
✅ 正确写法
🔴 Kroki 编译错误信息
```

这种格式极其适合 AI 解析,因为:
- **图标识别**: AI 可快速过滤关键规则
- **编号体系**: 便于跨文件引用(如 L3 可引用"参见强制规则 2")
- **错误信息匹配**: AI 可根据 Kroki 返回的实际错误信息反向定位规则

**2. 检查清单系统 ⭐⭐⭐⭐☆**

所有 L3 文件都包含"生成检查清单":

| 文件 | 检查项数量 | 与强制规则对齐度 |
|------|-----------|----------------|
| `class.txt` | 8 项 | ⚠️ 遗漏"指令位置"检查 |
| `component.txt` | 8 项 | ✅ 完全对齐 |
| `architecture.txt` | 8 项 | ✅ 完全对齐 |
| `flowchart.txt` | 10 项 | ✅ 完全对齐 + 额外验证 |

**AI 可操作性**:
- ✅ 清单采用 Markdown Checkbox 格式 `- [ ]`,AI 可直接生成验证脚本
- ✅ 每个检查项都对应具体的语法规则
- ⚠️ 缺少"检查失败后的自动修复建议"

**3. 命名规范清晰 ⭐⭐⭐⭐☆**

L2 L221-232 定义了命名规范:
- 类名: PascalCase
- 属性: camelCase
- 方法: camelCase
- 包名: 点分隔小写

但缺少 **ID 命名规范**(ID 是否应该用 kebab-case?)。

#### ⚠️ 缺少的 AI 辅助工具 (-5 分)

**1. 缺少关系符号快速参考表 (-2 分)**

虽然 L2 定义了 9 种关系符号,但 **所有 L3 文件都未提供快速参考表**。AI 在生成 component.txt 类型的图表时,需要反复回溯到 L2 查找符号含义。

**建议**: 在每个 L3 文件开头补充快速参考:

```markdown
## 关系符号速查 (参考 L2 通用规范)

| 符号 | 类型 | 用途 |
|------|------|------|
| `->` | 关联 | A 认识 B |
| `-->` | 依赖 | A 依赖 B |
| `-:>` | 泛化 | B 继承 A |
| `+->` | 组合 | A 拥有 B (强) |
| `o->` | 聚合 | A 聚合 B (弱) |
```

**2. 缺少分类器类型表格 (-2 分)**

L2 L159-180 以列表形式定义了 15+ 种分类器类型,但格式不适合 AI 快速查找:

```nomnoml
[NormalClass]                    // 普通类
[<abstract> AbstractClass]       // 抽象类
...
```

**建议**: 改为表格格式:

| 分类器类型 | 语法 | 视觉效果 | 适用图表类型 |
|-----------|------|----------|-------------|
| 普通类 | `[NormalClass]` | 矩形 | 类图 |
| 抽象类 | `[<abstract> AbstractClass]` | 斜体矩形 | 类图 |
| 开始节点 | `[<start> Start]` | 圆形 | 流程图 |
| 数据库 | `[<database> Database]` | 圆柱形 | 组件图/架构图 |

**3. 缺少"故障诊断决策树" (-1 分)**

当 Kroki 返回错误时,AI 需要一个决策树来定位问题:

```
Kroki 返回 400 错误
  ├─ "Unexpected token ','"  → 检查分隔符(规则 1)
  ├─ "Invalid class structure" → 检查类区域顺序(规则 3)
  ├─ "Invalid classifier syntax" → 检查分类器标签位置(规则 4)
  └─ "Directive ignored" → 检查指令位置(规则 5)
```

**建议**: 在 L2 底部补充"错误诊断表"。

---

### E. L2/L3 协调性 (3/5 分)

#### ✅ 协调良好的部分 (3/5)

**1. 语法分层明确**

L2 负责:
- 分类器类型定义
- 关系符号定义
- 指令系统
- 强制规则
- 注释语法

L3 负责:
- 特定图表类型的专家视角
- 该类型图表的专用语法(如 flowchart 的 `<choice>`)
- 业务场景示例
- 该类型特有的常见错误

**分层清晰度**: ⭐⭐⭐⭐☆

**2. 强制规则继承机制完善**

所有 L3 文件的"常见错误"章节都引用了 L2 的强制规则,例如:

- class.txt L361-375: 错误 1 引用"对应强制规则 1"
- component.txt L211-234: 明确说明"参见通用规范"
- flowchart.txt L289-308: 完整引用规则 5 的错误信息

**引用一致性**: ⭐⭐⭐⭐⭐

#### ⚠️ 协调不足的部分 (-2 分)

**1. L3 文件包含大量 L2 重复内容 (-1 分)**

**重复内容统计**:

| L3 文件 | 重复内容 | 位置 | 冗余字符数 |
|---------|---------|------|-----------|
| `flowchart.txt` | 样式推荐配置 | L500-527 | ~800 字符 |
| `flowchart.txt` | 指令语法完整列表 | L28-124 | ~3000 字符 |

**问题**:
- flowchart.txt L500-527 的三个样式配置(专业商务/清新简约/手绘)与 L2 L379-407 的配色建议高度重复
- flowchart.txt L28-124 的指令语法与 L2 L187-201 重复

**建议**:
- 删除 flowchart.txt L500-527,改为引用 L2
- 简化 flowchart.txt 的指令章节,仅保留流程图专用指令(`#direction`)

**2. 缺少 L2 → L3 的明确引用机制 (-1 分)**

虽然 L3 引用了 L2 的强制规则,但 **没有明确的章节引用语法**,例如:

```
// ❌ 当前写法(不精确)
"参见强制规则 1"

// ✅ 建议写法(精确定位)
"参见 L2 通用规范 § 强制规则 1 (L6-24)"
```

**影响**: AI 需要手动扫描 L2 全文,降低效率。

---

## 文件级审查

### L2: common.txt (450 行)

**总体评价**: ⭐⭐⭐⭐⭐ 优秀

**结构分析**:

```
L1-123: 强制规则(5 条)         ← 核心价值,极其完善
L125-220: 语法基础              ← 完整定义分类器、关系、指令
L221-366: 命名规范 + 常见错误    ← 7 个错误类型,全部对应强制规则
L367-407: 生成原则 + 样式系统    ← 配色建议实用
L408-450: Kroki 渲染说明         ← Kroki 特殊限制详细
```

**优势**:
1. **强制规则系统** (L6-123) 是整个 Nomnoml Prompt 系统的灵魂,每条规则包含:
   - 错误示例 + 正确示例 + Kroki 错误信息
   - 违反后果分级(编译失败/语义错误)
   - 清晰的修复路径

2. **Kroki 渲染说明** (L408-450) 填补了官方文档的空白:
   - 嵌套深度限制(≤3 层)
   - 节点数量限制(≤50 个)
   - 常见 Kroki 错误及解决方法

3. **样式系统** (L375-407) 提供了 5 个预设配色方案,附配色原则,AI 可直接套用。

**改进建议**:

**P2 问题 1: 缺少双向关系和球窝关系**

L147-158 的关系类型章节遗漏:
- 双向关联 `<->`
- 球窝关系 `-o)`, `o<-)`, `->o`

**修复**: 补充到 L158 后:

```nomnoml
// 双向关系
[A] <-> [B]             // 双向关联,相互认识

// 球窝关系(特殊组件连接)
[A] -o) [B]             // 球窝关联
[A] o<-) [B]            // 反向球窝
[A] ->o [B]             // 球窝箭头
```

**P2 问题 2: 指令默认值错误**

L187-201 的指令系统中:
- `#background: #f5f5f5` → 官方默认为 `transparent`
- `#lineWidth: 2` → 官方默认为 `1`

**修复**: 更正默认值,并补充说明:

```nomnoml
#background: transparent   // 背景颜色(默认透明,建议设置)
#lineWidth: 1              // 线条宽度(默认 1,可调整为 2)
```

**P3 问题 3: 注释语法未标记为强制规则**

L203-219 提到注释必须在行首,但未列入"强制规则",容易被 AI 忽略。

**修复**: 提升为 **⚠️ 规则 6**,补充 Kroki 错误信息。

---

### L3.1: class.txt (471 行)

**总体评价**: ⭐⭐⭐⭐☆ 良好

**结构分析**:

```
L1-22: 专家视角              ← 明确 AI 角色定位
L23-78: 核心语法             ← 类定义、关系、多重性
L111-358: 生成示例(4 个)     ← 层次完整,覆盖泛型
L359-471: 常见错误(6 个)     ← 全部引用强制规则
L457-471: 生成检查清单       ← 8 个检查项
```

**优势**:

1. **泛型支持完善** (示例 4, L290-351):
   - 单类型参数 `<E>`
   - 多类型参数 `<K, V>`
   - 约束泛型 `<T extends Entity>`
   - 展示了 Java Collection 框架的完整设计

2. **设计模式示例** (示例 3, L224-283):
   - 策略模式完整实现
   - 使用 `<frame>` 分组
   - 使用 `<note>` 添加说明
   - 展示了抽象类 + 继承 + 依赖的综合运用

3. **错误章节完整** (L359-471):
   - 6 个错误全部对应 L2 强制规则
   - 每个错误都有 ❌ 错误写法 + ✅ 正确写法 + 原因说明

**改进建议**:

**P1 问题 1: 检查清单遗漏"指令位置规则"**

L457-471 的检查清单包含 8 项,但遗漏了 L2 强制规则 5 (指令位置规则)。

**修复**: 在 L466 后补充:

```markdown
- [ ] **指令在内容前**: `#direction` 等指令在节点和连接之前
```

**P2 问题 2: 缺少接口表示说明**

虽然定义了"实现接口"关系 `--:>`,但未说明如何表示 Java/C# 的 `interface`:

**修复**: 在 L86 后补充:

```nomnoml
// 接口定义(使用 abstract 或自定义样式)
[<abstract> IUserService||
  + getUser(id: int): User
]

// 实现关系
[UserService] --:> [IUserService]
```

**P3 问题 3: 多重性标注示例不足**

L103-109 仅提供了 3 个多重性示例:

```nomnoml
[Order] -> 1..*[OrderItem]     // 一对多
[Person] -> 0..1[Address]      // 零或一
[Student] -> *[Course]         // 多对多
```

**修复**: 补充完整的 UML 多重性规范:

```nomnoml
[A] -> 1[B]         // 必须有 1 个
[A] -> *[B]         // 零或多个
[A] -> 1..*[B]      // 至少 1 个
[A] -> 0..1[B]      // 零或 1 个
[A] -> 2..5[B]      // 2 到 5 个
```

---

### L3.2: component.txt (341 行)

**总体评价**: ⭐⭐⭐⭐⭐ 优秀

**结构分析**:

```
L1-22: 专家视角              ← 强调组件与类的区别
L23-75: 核心语法             ← 组件、接口、嵌套
L77-210: 生成示例(3 个)     ← Web 三层、微服务、插件化
L211-341: 常见错误(6 个)     ← 强调组件图特有错误
L327-341: 生成检查清单       ← 8 个检查项
```

**优势**:

1. **接口表示规范** (L44-60):
   - `<lollipop>` 提供接口
   - `<socket>` 需要接口
   - `-/-` 隐藏连接表示接口匹配
   - 这是 Nomnoml 相对于 PlantUML 的独特优势

2. **插件化架构示例** (示例 3, L164-203):
   - 完整展示了核心框架 + 插件的解耦设计
   - 使用 `<lollipop>` 和 `<socket>` 表示接口契约
   - 使用 `<note>` 说明架构决策

3. **错误"组件和类混淆"** (L213-235):
   - 明确指出组件图不应包含类的属性和方法
   - 强调组件图关注"物理组件"而非"逻辑实现"

**改进建议**:

**P2 问题 1: 缺少端口(Port)概念**

UML 组件图支持"端口"(Port)概念,但 Nomnoml 没有内置类型。

**修复**: 补充端口的变通表示:

```nomnoml
// 使用 socket 表示端口
[Component|
  [<socket> Port1]
  [<socket> Port2]
]

// 或使用自定义样式
#.port: visual=ellipse fill=#ffeb3b

[Component|
  [<port> InputPort]
  [<port> OutputPort]
]
```

**P3 问题 2: 微服务示例缺少服务网格(Service Mesh)**

示例 2 (微服务架构) 未展示现代微服务的关键组件:
- Service Mesh (Istio/Linkerd)
- API Gateway 的限流/熔断
- 分布式追踪

**修复**: 补充为示例 2.5:

```nomnoml
#direction: down

[<package> Service Mesh|
  [Istio Control Plane]
  [Envoy Sidecar]
]

[API Gateway] --> [Envoy Sidecar]
[Envoy Sidecar] --> [User Service]
[Envoy Sidecar] --> [Order Service]
```

---

### L3.3: architecture.txt (522 行)

**总体评价**: ⭐⭐⭐⭐☆ 良好

**结构分析**:

```
L1-22: 专家视角              ← 强调架构层次和技术栈
L23-83: 核心语法             ← 架构层次、技术栈、外部系统
L85-371: 生成示例(3 个)     ← 三层、微服务、云原生
L372-522: 常见错误(6 个)     ← 强调架构图特有错误
L507-522: 生成检查清单       ← 8 个检查项
```

**优势**:

1. **云原生架构示例** (示例 3, L248-362):
   - 完整展示 Kubernetes + Docker + AWS 技术栈
   - 包含 Ingress、Pod、StatefulSet、HPA
   - 展示可观测性组件(Prometheus、Grafana、ELK)
   - 使用 `<note>` 说明自动扩缩容策略

2. **技术栈标注完善** (L58-82):
   - 明确要求在节点内标注技术栈
   - 提供多层技术栈的标注格式

3. **错误"技术栈信息缺失"** (L401-427):
   - 强调架构图必须包含关键技术选型
   - 对比 ❌ 错误(只有组件名)和 ✅ 正确(包含技术栈)

**改进建议**:

**P1 问题 1: 技术栈示例单一**

所有示例都使用 Node.js/React/PostgreSQL 栈,缺少:
- Java 栈: Spring Boot + MySQL
- Python 栈: Django/FastAPI + MongoDB
- Go 栈: Gin + Redis

**修复**: 在示例 2 (微服务架构) 后补充多语言示例:

```nomnoml
// 混合语言微服务架构
[User Service|
  Node.js + Express;
  MongoDB
]

[Order Service|
  Java Spring Boot;
  PostgreSQL
]

[Payment Service|
  Python FastAPI;
  Redis + PostgreSQL
]

[Notification Service|
  Go + Gin;
  Kafka
]
```

**P2 问题 2: 缺少无服务器架构(Serverless)示例**

现代架构越来越多采用 Lambda/Cloud Functions,但未覆盖。

**修复**: 补充示例 4:

```nomnoml
#direction: down

[<package> AWS Serverless Architecture|
  [API Gateway]
  [Lambda Functions|
    getUserLambda;
    createOrderLambda;
    processPaymentLambda
  ]
  [<database> DynamoDB]
  [S3 Storage]
  [SQS Queue]
]

[Client] --> [API Gateway]
[API Gateway] --> [Lambda Functions]
[Lambda Functions] --> [DynamoDB]
[Lambda Functions] --> [SQS Queue]
```

**P3 问题 3: 外部系统集成说明不足**

L442-462 的错误"外部系统未标识"提到要分组外部系统,但未说明如何表示:
- API 版本(v1/v2)
- 认证方式(OAuth2/API Key)
- SLA 要求(99.9% 可用性)

**修复**: 补充外部系统标注格式:

```nomnoml
[<package> External Services|
  [Email Service|
    Provider: SendGrid;
    Auth: API Key;
    SLA: 99.95%
  ]
  [Payment Gateway|
    Provider: Stripe v2023-10-16;
    Auth: OAuth2;
    Rate Limit: 100 req/s
  ]
]
```

---

### L3.4: flowchart.txt (543 行)

**总体评价**: ⭐⭐⭐⭐⭐ 优秀 (流程图专精度最高)

**结构分析**:

```
L1-25: 专家视角              ← 强调流程完整性和决策点
L26-154: 核心语法            ← 方向、节点、连接、分组、样式、注释等 9 大类
L156-288: 生成示例(3 个)     ← 登录、订单处理、审批流程
L289-449: 常见错误(7 个)     ← 流程图特有错误最多
L427-449: 生成检查清单       ← 10 个检查项(最全面)
L450-543: 高级特性 + 样式    ← 混合节点、复杂分组、样式配置
```

**优势**:

1. **流程控制结构完整** (L126-154):
   - 判断节点标准写法
   - 循环结构(带退出条件)
   - 多路径汇聚
   - 所有示例都可直接套用

2. **审批流程示例** (示例 3, L221-278):
   - 多级审批(部门经理 + 总经理)
   - 嵌套分组(初审 → 部门审批 → 总经理审批)
   - 包含会签和加签场景
   - 使用 `<actor>` 表示审批人
   - 使用 `<database>` 表示归档
   - 包含循环(重新提交)和多个出口

3. **错误覆盖最全** (L289-449):
   - 7 个错误类型,包含流程图特有的:
     - 方向指令位置错误(L291-308)
     - 判断节点缺少条件标签(L309-324)
     - 分组语法错误(L326-344)
     - 嵌套层级过深(L381-406)
     - 连接方向混乱(L408-426)

4. **检查清单最详细** (L427-449):
   - 10 个检查项,比其他 L3 文件多 2 个
   - 包含"重点检查项"子章节
   - 明确指出 4 个高优先级检查项

**改进建议**:

**P2 问题 1: 样式推荐配置重复**

L500-527 的三个样式配置(专业商务/清新简约/手绘)与 L2 L379-407 高度重复。

**修复**: 删除 L500-527,改为引用:

```markdown
## 样式推荐配置

参考 L2 通用规范的"样式系统"章节 (L379-407),推荐配置:
- 专业商务风格: `#fill: #FEFECE` + `#stroke: #A80036`
- 清新简约风格: `#fill: #E3F2FD` + `#stroke: #1976D2`
- 手绘风格: `#visual: handDrawn`
```

**P3 问题 2: 缺少并行分支(Fork/Join)说明**

流程图支持并行分支(同时执行多个步骤),但未提及。

**修复**: 在 L126 后补充:

```nomnoml
// 并行分支(Fork)
[开始] -> [<sync> Fork]
[Fork] -> [任务A]
[Fork] -> [任务B]
[Fork] -> [任务C]

// 汇聚(Join)
[任务A] -> [<sync> Join]
[任务B] -> [Join]
[任务C] -> [Join]
[Join] -> [结束]
```

**P3 问题 3: 缺少子流程(Subprocess)表示**

复杂流程应支持子流程封装,但未说明如何表示。

**修复**: 补充子流程示例:

```nomnoml
// 使用 frame 表示子流程
[开始] -> [<frame> 验证子流程 |
  [验证用户]
  [验证用户] -> [<choice> 通过?]
  [通过?] 是-> [验证完成]
  [通过?] 否-> [验证用户]
]
[验证完成] -> [继续处理]
```

---

## 优先级问题汇总

### P1 (Critical) - 必须立即修复 (3 个)

**P1-1: class.txt 检查清单遗漏"指令位置规则"**

- **位置**: `src/lib/constants/prompts/nomnoml/class.txt` L466
- **影响**: AI 生成的类图可能将指令放在内容后,导致样式不生效
- **修复**:
  ```markdown
  - [ ] **指令在内容前**: `#direction` 等指令在节点和连接之前
  ```

**P1-2: L2 关系符号遗漏双向关系**

- **位置**: `src/lib/constants/prompts/nomnoml/common.txt` L158
- **影响**: AI 不知道如何表示双向关联,可能使用两条单向箭头
- **修复**:
  ```nomnoml
  // 双向关联
  [A] <-> [B]             // 双向关联,相互认识
  ```

**P1-3: Architecture 技术栈示例单一**

- **位置**: `src/lib/constants/prompts/nomnoml/architecture.txt` 示例章节
- **影响**: AI 只会生成 Node.js 栈的架构图,无法支持 Java/Python/Go 用户
- **修复**: 补充混合语言微服务架构示例

---

### P2 (Important) - 应在下次更新修复 (5 个)

**P2-1: L2 指令默认值错误**

- **位置**: `src/lib/constants/prompts/nomnoml/common.txt` L187-201
- **影响**: AI 可能使用错误的默认值
- **修复**:
  ```nomnoml
  #background: transparent   // 官方默认 transparent,非 #f5f5f5
  #lineWidth: 1              // 官方默认 1,非 2
  ```

**P2-2: L2 缺少球窝关系**

- **位置**: `src/lib/constants/prompts/nomnoml/common.txt` L147-158
- **影响**: AI 无法生成组件图的特殊连接类型
- **修复**: 补充 `-o)`, `o<-)`, `->o` 的定义

**P2-3: Component 缺少端口(Port)概念**

- **位置**: `src/lib/constants/prompts/nomnoml/component.txt` 核心语法章节
- **影响**: AI 无法表示 UML 组件图的端口
- **修复**: 补充端口的变通表示方法

**P2-4: Flowchart 样式配置重复**

- **位置**: `src/lib/constants/prompts/nomnoml/flowchart.txt` L500-527
- **影响**: 文件冗余 ~800 字符,增加 AI Token 消耗
- **修复**: 删除重复内容,改为引用 L2

**P2-5: Architecture 缺少无服务器架构示例**

- **位置**: `src/lib/constants/prompts/nomnoml/architecture.txt` 示例章节
- **影响**: AI 无法生成 Lambda/Cloud Functions 架构
- **修复**: 补充 AWS Serverless 示例

---

### P3 (Minor) - 可在后续迭代改进 (6 个)

**P3-1: L2 注释语法未标记为强制规则**

- **位置**: `src/lib/constants/prompts/nomnoml/common.txt` L203-219
- **影响**: AI 可能尝试行中注释,导致语法错误
- **修复**: 提升为 ⚠️ 规则 6

**P3-2: Class 缺少接口表示说明**

- **位置**: `src/lib/constants/prompts/nomnoml/class.txt` L86
- **影响**: AI 不知道如何表示 Java/C# 的 interface
- **修复**: 补充接口定义示例

**P3-3: Class 多重性标注示例不足**

- **位置**: `src/lib/constants/prompts/nomnoml/class.txt` L103-109
- **影响**: AI 只会用 `1..*`, `0..1`, `*` 三种标注
- **修复**: 补充 `1`, `2..5` 等完整规范

**P3-4: Component 微服务示例缺少 Service Mesh**

- **位置**: `src/lib/constants/prompts/nomnoml/component.txt` 示例 2
- **影响**: AI 生成的微服务架构不符合现代最佳实践
- **修复**: 补充 Istio/Envoy 示例

**P3-5: Architecture 外部系统标注不够详细**

- **位置**: `src/lib/constants/prompts/nomnoml/architecture.txt` L442-462
- **影响**: AI 不知道如何标注 API 版本、认证方式、SLA
- **修复**: 补充外部系统标注格式

**P3-6: Flowchart 缺少并行分支和子流程**

- **位置**: `src/lib/constants/prompts/nomnoml/flowchart.txt` L126
- **影响**: AI 无法生成包含并行任务的复杂流程
- **修复**: 补充 Fork/Join 和 Subprocess 示例

---

## 对比分析

### 与 Mermaid Prompt 系统对比

| 对比维度 | Nomnoml | Mermaid | 优劣分析 |
|---------|---------|---------|---------|
| **强制规则系统** | ⭐⭐⭐⭐⭐ (5 条,完整) | ⭐⭐⭐☆☆ (3 条) | Nomnoml **更优**,Kroki 错误信息完整 |
| **分类器类型** | ⭐⭐⭐⭐☆ (15+ 种) | ⭐⭐⭐⭐⭐ (20+ 种) | Mermaid 更丰富(支持 icon, img) |
| **关系符号** | ⭐⭐⭐⭐☆ (9 种) | ⭐⭐⭐⭐⭐ (12 种) | Mermaid 更全面(支持虚线变体) |
| **示例复杂度** | ⭐⭐⭐⭐⭐ (4 层次) | ⭐⭐⭐⭐☆ (3 层次) | Nomnoml **更优**,泛型示例完善 |
| **错误覆盖** | ⭐⭐⭐⭐⭐ (25 个) | ⭐⭐⭐⭐☆ (22 个) | Nomnoml **更优**,flowchart 专精 |
| **检查清单** | ⭐⭐⭐⭐☆ (8-10 项) | ⭐⭐⭐⭐⭐ (10-12 项) | Mermaid 更详细 |

**Nomnoml 独特优势**:
1. **强制规则 + Kroki 错误信息** 的组合,修复成功率极高
2. **Flowchart 专精度** 远超 Mermaid(10 个检查项 vs 8 个)
3. **UML 语义准确性** 更高(严格区分组合/聚合)

**Nomnoml 需要向 Mermaid 学习**:
1. **符号对照表** - Mermaid 所有 L3 文件都有符号速查表
2. **图表类型推荐** - Mermaid 明确告诉 AI 何时用哪种图表
3. **实时预览提示** - Mermaid 提供了在线编辑器链接

### 与 PlantUML Prompt 系统对比

| 对比维度 | Nomnoml | PlantUML | 优劣分析 |
|---------|---------|----------|---------|
| **语法复杂度** | ⭐⭐☆☆☆ (简洁) | ⭐⭐⭐⭐☆ (复杂) | Nomnoml **更优**,易学易用 |
| **图表类型** | ⭐⭐⭐☆☆ (8 种) | ⭐⭐⭐⭐⭐ (14 种) | PlantUML 更全面 |
| **样式系统** | ⭐⭐⭐☆☆ (基础) | ⭐⭐⭐⭐⭐ (强大) | PlantUML 支持 skinparam |
| **L2 通用规范** | ⭐⭐⭐⭐⭐ (450 行) | ⭐⭐⭐⭐☆ (380 行) | Nomnoml **更优**,强制规则完善 |
| **架构图支持** | ⭐⭐⭐⭐⭐ (专业) | ⭐⭐⭐⭐☆ (通用) | Nomnoml **更优**,云原生示例完整 |

**Nomnoml 相对于 PlantUML 的优势**:
1. **学习曲线平缓** - 语法更接近自然语言
2. **强制规则系统** - PlantUML 缺少类似机制
3. **组件图接口表示** - `<lollipop>` 和 `<socket>` 直观

**Nomnoml 需要向 PlantUML 学习**:
1. **样式主题系统** - PlantUML 支持预设主题
2. **图表类型覆盖** - PlantUML 支持时序图、活动图等更多类型
3. **宏和函数** - PlantUML 支持可重用组件

---

## 修复优先级建议

### 立即修复 (本周内)

**任务 1: 修复 P1-1 (class.txt 检查清单)**

```bash
# 修复文件
src/lib/constants/prompts/nomnoml/class.txt

# 修改位置
L466: 在 "布局方向合理" 后补充
- [ ] **指令在内容前**: `#direction` 等指令在节点和连接之前

# 验证
运行测试用例确认检查清单完整性
```

**任务 2: 修复 P1-2 (L2 双向关系)**

```bash
# 修复文件
src/lib/constants/prompts/nomnoml/common.txt

# 修改位置
L158: 在 "聚合(Aggregation)" 后补充

[A] <-> [B]             // 双向关联(Bidirectional Association)

# 验证
运行 Kroki 渲染测试
```

**任务 3: 补充 P1-3 (Architecture 技术栈示例)**

```bash
# 修复文件
src/lib/constants/prompts/nomnoml/architecture.txt

# 修改位置
示例 2 (微服务架构) 后,补充混合语言栈示例

# 新增内容
### 示例 2.5: 混合语言微服务架构
[详见上文 P1-3 修复方案]

# 验证
确认 AI 可生成 Java/Python/Go 架构图
```

---

### 下次更新修复 (下月)

**任务 4: 统一修复 P2 级别问题 (5 个)**

创建统一的修复 PR:
- P2-1: 更正指令默认值
- P2-2: 补充球窝关系
- P2-3: 补充端口概念
- P2-4: 删除重复样式配置
- P2-5: 补充无服务器架构示例

---

### 长期改进 (下季度)

**任务 5: 增强 AI 可理解性**

1. **补充符号对照表** - 在所有 L3 文件开头添加快速参考表
2. **改进分类器类型定义** - 将 L2 L159-180 的列表改为表格格式
3. **补充故障诊断决策树** - 在 L2 底部添加错误诊断表

**任务 6: 扩展边缘场景**

1. **空节点处理** - 补充"何时使用空节点"的指导
2. **超长名称处理** - 补充名称长度限制和缩写建议
3. **特殊字符兼容性** - 补充中文、Emoji、数学符号的测试

**任务 7: 补充 P3 级别示例**

- P3-2: Class 接口表示
- P3-3: Class 完整多重性标注
- P3-4: Component Service Mesh
- P3-5: Architecture 外部系统标注
- P3-6: Flowchart 并行分支和子流程

---

## 总结

Nomnoml Prompt 系统在 **语法准确性**(28/30) 和 **错误覆盖度**(23/25) 两个维度表现优秀,特别是:

1. **L2 `common.txt` 的强制规则系统** 是同类 Prompt 系统中的典范,每条规则都附带 Kroki 实际错误信息,极大提升了 AI 的错误修复能力。

2. **Flowchart.txt 的专精度** 远超其他语言,10 个检查项 + 7 个常见错误 + 审批流程示例,覆盖了流程图的所有关键场景。

3. **示例代码质量** 整体优秀,4 层复杂度层次完整,业务场景丰富(图书馆、电商、云原生等),且所有示例都可直接运行。

**改进空间**:

1. **AI 可理解性** (12/15) 可通过补充符号对照表、分类器类型表格、故障诊断决策树提升到 15/15。

2. **L2/L3 协调性** (3/5) 需要删除 flowchart.txt 的重复样式配置,并建立明确的章节引用机制(如 "参见 L2 § 强制规则 1 (L6-24)")。

3. **P1 级别问题** (3 个) 应在本周内修复,特别是 **class.txt 检查清单遗漏** 和 **L2 双向关系缺失**,这两个问题会直接影响 AI 生成质量。

**最终评价**: ⭐⭐⭐⭐☆ (88/100 分),达到"优秀"级别,修复 P1 问题后可达到 92 分。

---

**审查完成时间**: 2025-10-13
**审查人**: Claude (Sonnet 4.5)
**下次审查建议**: 修复 P1+P2 问题后 (预计 2025-11)
