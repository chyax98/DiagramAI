# RackDiag 语法规则详解

## 语法结构

### 基本格式

```
rackdiag {
  // 全局配置
  机架高度;
  属性配置;

  // 设备定义
  位置: 设备名 [属性]
}
```

## 核心语法规则

### 1. 机架高度定义

#### 语法格式
```
NU;    // N 为机架高度（U 为单位）
```

#### 有效值
```
6U;     // 小型机架
12U;    // 中型机架
16U;    // 常见机架
24U;    // 中大型机架
42U;    // 标准数据中心机架
48U;    // 大型机架
```

#### 规则
- 必须是正整数
- 必须以 `U` 结尾
- 必须以分号 `;` 结束
- 建议使用标准尺寸（6/12/16/24/42/48）

### 2. 设备定义语法

#### 基本格式
```
位置编号: 设备名称
```

#### 完整格式
```
位置编号: 设备名称 [属性1] [属性2] ...
```

#### 位置编号规则

**单个位置**:
```
1: Server          // 位置 1，占 1U
5: Switch          // 位置 5，占 1U
```

**多个设备同一位置**:
```
4: Web Server 1    // 位置 4 的第一个设备
4: Web Server 2    // 位置 4 的第二个设备
```

**位置编号范围**:
- 必须是正整数
- 不能超过机架高度
- 可以不连续（允许跳过）
- 默认从顶部开始（1 在顶部）

### 3. 设备属性

#### 高度属性 ([NU])

**语法**:
```
位置: 设备名 [NU];    // N 为设备高度
```

**示例**:
```
1: UPS [2U];          // 占 2U 高度（位置 1-2）
3: Server [4U];       // 占 4U 高度（位置 3-6）
```

**规则**:
- N 必须是正整数
- 设备占用: 位置 + (N-1) 个单元
- 不能超出机架高度

#### 重量属性 ([Nkg])

**语法**:
```
位置: 设备名 [Nkg];   // N 为重量（千克）
```

**示例**:
```
1: Storage [25kg];    // 重量 25kg
3: Server [10kg];     // 重量 10kg
```

**规则**:
- N 可以是整数或小数
- 仅用于文档说明，不影响布局

#### 功耗属性 ([NA])

**语法**:
```
位置: 设备名 [NA];    // N 为功耗（安培）
```

**示例**:
```
1: UPS [3.5A];        // 功耗 3.5A
5: Switch [0.8A];     // 功耗 0.8A
```

**规则**:
- N 可以是整数或小数
- 仅用于文档说明

### 4. 机架全局属性

#### ascending（编号顺序）

**默认**: 从上到下（1 在顶部）
```
rackdiag {
  16U;
  1: Top Server       // 顶部
  16: Bottom Server   // 底部
}
```

**ascending**: 从下到上（1 在底部）
```
rackdiag {
  ascending;
  16U;
  1: Bottom Server    // 底部
  16: Top Server      // 顶部
}
```

#### description（机架描述）

**语法**:
```
description = "描述文本";
```

**示例**:
```
rackdiag {
  description = "Tokyo DC - Rack A1";
  42U;
  // ...
}
```

**规则**:
- 必须使用双引号
- 可包含任意文本
- 显示在图表顶部或底部

### 5. 多机架语法

#### 语法格式
```
rackdiag {
  rack {
    机架1配置
    设备定义
  }

  rack {
    机架2配置
    设备定义
  }
}
```

#### 示例
```
rackdiag {
  rack {
    16U;
    description = "Rack A";
    1: Server A1
    2: Server A2
  }

  rack {
    12U;
    description = "Rack B";
    1: Server B1
    2: Server B2
  }
}
```

### 6. 不可用单元标记

#### 语法
```
位置: N/A [NU];      // 标记 N 个单元不可用
```

#### 示例
```
rackdiag {
  12U;

  1: Server 1
  2: Server 2
  3: Server 3
  4: Server 4
  5: N/A [8U];        // 5-12U 不可用
}
```

**用途**:
- 预留空间
- 维护区域
- 冷却空间
- 已损坏单元

## 高级语法特性

### 1. 组合属性

**多个属性同时使用**:
```
rackdiag {
  12U;
  1: Heavy Server [2U] [15kg] [2.5A];    // 高度 + 重量 + 功耗
}
```

**注意**: 属性顺序不影响结果

### 2. 设备命名规范

**推荐格式**:
```
位置: 设备类型-编号
```

**示例**:
```
1: WEB-01          // Web 服务器 01
2: WEB-02          // Web 服务器 02
3: DB-01           // 数据库服务器 01
5: SW-CORE-01      // 核心交换机 01
```

**允许的字符**:
- 字母（A-Z, a-z）
- 数字（0-9）
- 连字符（-）
- 下划线（_）
- 空格（但不推荐）

**避免的字符**:
- 冒号（:）- 用于分隔符
- 方括号（[]）- 用于属性
- 大括号（{}）- 用于块定义
- 分号（;）- 用于语句结束

### 3. 注释语法

**单行注释**:
```
// 这是注释
rackdiag {
  12U;  // 机架高度
}
```

**多行注释**:
```
/*
 * 这是多行注释
 * 可以跨多行
 */
rackdiag {
  12U;
}
```

**行尾注释**:
```
1: Server  // Web 服务器
2: Switch  // 核心交换机
```

## 语法约束

### 必须遵守的规则

1. **唯一机架高度**: 单机架配置中仅能有一个高度定义
2. **位置不重叠**: 设备占用的位置不能重叠
3. **括号配对**: 所有 `{` 必须有对应的 `}`
4. **分号结束**: 高度定义和设备属性必须以 `;` 结束
5. **有效范围**: 设备位置 + 高度 ≤ 机架高度

### 推荐但非强制的规则

1. **位置升序**: 按位置编号从小到大定义
2. **标准高度**: 使用标准机架高度（12U, 16U, 42U）
3. **命名一致**: 使用统一的设备命名规范
4. **添加描述**: 为机架添加 description 说明
5. **预留空间**: 预留 10-20% 空间用于扩展

## 错误语法示例

### ❌ 位置重叠
```
rackdiag {
  12U;
  1: Server [2U];    // 占用 1-2
  2: Switch          // ❌ 位置 2 已被占用
}
```

### ❌ 超出机架高度
```
rackdiag {
  12U;
  11: Server [3U];   // ❌ 11+3-1=13 > 12
}
```

### ❌ 高度格式错误
```
rackdiag {
  12;                // ❌ 缺少 U
  12U                // ❌ 缺少分号
}
```

### ❌ 设备名包含特殊字符
```
rackdiag {
  12U;
  1: Server:01       // ❌ 包含冒号
  2: Server[2]       // ❌ 方括号应在属性中
}
```

## 正确语法示例

### ✅ 标准机架配置
```
rackdiag {
  ascending;
  description = "Production Rack A1";
  42U;

  1: PDU [2U];
  3: UPS [3U];
  6: Network Switch [2U];
  8: App Server 1 [2U];
  10: App Server 2 [2U];
  12: DB Server [4U];
  20: Storage [8U];
  30: Reserved [13U];
}
```

### ✅ 多设备同位置
```
rackdiag {
  16U;

  4: Web Server 1
  4: Web Server 2      // 同一层两个设备
  5: App Server 1
  5: App Server 2
  5: App Server 3      // 同一层三个设备
}
```

### ✅ 完整属性标注
```
rackdiag {
  description = "High-Density Compute Rack";
  42U;

  1: UPS [3U] [50kg] [5A];
  5: Blade Chassis [10U] [100kg] [15A];
  20: Storage Array [8U] [80kg] [8A];
}
```

## 语法检查清单

### 编写前检查
- [ ] 确定机架高度（标准尺寸）
- [ ] 规划设备位置和高度
- [ ] 确认设备总高度 ≤ 机架高度
- [ ] 确定编号顺序（默认或 ascending）

### 编写时检查
- [ ] 机架高度以 `U;` 结尾
- [ ] 每个设备有位置编号和冒号
- [ ] 属性在方括号 `[]` 中
- [ ] 大括号 `{}` 配对
- [ ] 设备名不含特殊字符

### 编写后检查
- [ ] 位置无重叠
- [ ] 位置不超出机架高度
- [ ] 多机架使用 `rack {}` 块
- [ ] 添加必要的注释
- [ ] 测试渲染结果

## 语法参考速查

| 元素 | 语法 | 示例 |
|------|------|------|
| 配置块 | `rackdiag { }` | `rackdiag { ... }` |
| 机架高度 | `NU;` | `42U;` |
| 设备定义 | `位置: 名称` | `1: Server` |
| 设备高度 | `[NU]` | `[2U]` |
| 设备重量 | `[Nkg]` | `[15kg]` |
| 设备功耗 | `[NA]` | `[2.5A]` |
| 编号顺序 | `ascending;` | `ascending;` |
| 机架描述 | `description = "..."` | `description = "Rack A1"` |
| 多机架 | `rack { }` | `rack { 12U; ... }` |
| 不可用 | `N/A [NU]` | `N/A [8U]` |
| 注释 | `// ...` | `// Comment` |

## 常见模式

### 模式 1: 电源冗余配置
```
rackdiag {
  ascending;
  42U;

  1: PDU A [1U];
  2: PDU B [1U];      // 冗余 PDU
  3: UPS [3U];
}
```

### 模式 2: 网络分层
```
rackdiag {
  42U;

  1: Core Switch [2U];
  3: Distribution Switch 1
  4: Distribution Switch 2
  5: Access Switch 1
  6: Access Switch 2
}
```

### 模式 3: 计算存储分离
```
rackdiag {
  42U;

  // 计算层
  1: Compute 1 [2U];
  3: Compute 2 [2U];
  5: Compute 3 [2U];

  // 存储层
  10: Storage 1 [4U];
  14: Storage 2 [4U];
}
```

## 参考资源

- [BlockDiag 语法文档](http://blockdiag.com/en/nwdiag/)
- [RackDiag 示例](http://blockdiag.com/en/nwdiag/rackdiag-examples.html)
- [数据中心标准](https://www.tia-942.org/)
