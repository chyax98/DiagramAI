# Promote-V4 测试指南

**分支**: `feature/promote-v4-integration`
**状态**: ✅ 代码集成完成，准备测试

---

## 📋 快速开始

### 1. 环境变量配置

在 `.env.local` 中添加：

```bash
# 启用 Promote-V4 TOML Prompt 系统
USE_PROMOTE_V4=true
```

### 2. 重启开发服务器

```bash
npm run dev
```

### 3. 观察日志

当生成图表时，应该看到：

```
[Promote-V4] 使用 TOML Prompt 系统
```

如果看到以下日志，说明未启用：

```
[V3] 使用 TXT Prompt 系统
```

---

## 🧪 测试场景

### 测试 1: Mermaid Flowchart (⭐⭐⭐⭐⭐ 最高优先级)

**输入**:
```
请生成一个用户登录流程图，包含：
1. 用户输入用户名密码
2. 验证输入合法性
3. 调用后端 API 验证
4. 成功则跳转首页，失败则提示错误
```

**预期**:
- 生成完整的 Mermaid flowchart 代码
- 包含所有节点和逻辑分支
- 无语法错误

### 测试 2: PlantUML Sequence (⭐⭐⭐⭐ 高优先级)

**输入**:
```
生成一个 HTTP 请求的时序图：
- 浏览器发送请求到 Nginx
- Nginx 转发到应用服务器
- 应用服务器查询数据库
- 返回响应
```

**预期**:
- 正确的 PlantUML sequence 语法
- 清晰的时序关系
- 箭头和标签正确

### 测试 3: DBML ER Diagram (⭐⭐⭐ 中优先级)

**输入**:
```
设计一个博客系统的数据库：
- users 表：id, username, email
- posts 表：id, title, content, user_id
- comments 表：id, content, post_id, user_id
```

**预期**:
- 完整的 DBML 语法
- 正确的外键关系
- 表结构清晰

### 测试 4: Excalidraw Sketch (⭐⭐⭐ 中优先级)

**输入**:
```
画一个简单的系统架构草图：
- 前端 (React)
- 后端 (Node.js)
- 数据库 (PostgreSQL)
```

**预期**:
- 手绘风格的组件
- 合理的布局
- 连接关系清晰

### 测试 5: GraphViz State (⭐⭐⭐ 中优先级)

**输入**:
```
订单状态机：
- 待支付 → 已支付
- 已支付 → 已发货
- 已发货 → 已完成
- 任何状态 → 已取消
```

**预期**:
- 正确的 Graphviz dot 语法
- 状态转换逻辑清晰
- 布局合理

---

## 📊 对比测试 (V3 vs V4)

### 准备工作

1. **保存当前配置**:
   ```bash
   cp .env.local .env.v4
   ```

2. **切换到 V3**:
   ```bash
   # 在 .env.local 中设置
   USE_PROMOTE_V4=false
   # 重启服务器
   ```

3. **执行相同测试用例**:
   - 使用相同的用户输入
   - 记录生成的代码
   - 记录是否有语法错误

4. **切换到 V4**:
   ```bash
   # 在 .env.local 中设置
   USE_PROMOTE_V4=true
   # 重启服务器
   ```

5. **对比结果**:
   - 代码质量
   - 语法正确性
   - 完整性
   - 可读性

---

## ✅ 验收标准

### 功能正确性

- ✅ **加载正确**: 日志显示使用 Promote-V4
- ✅ **语法正确**: 所有生成的代码能被 Kroki 渲染
- ✅ **完整性**: 包含所有用户要求的元素
- ✅ **可读性**: 代码结构清晰，命名合理

### 性能指标

- ✅ **响应时间**: < 10 秒 (简单图表)
- ✅ **成功率**: > 85% (V3 基准)
- ✅ **Token 使用**: 合理范围 (V3 ± 20%)

### 质量指标

- ✅ **语法错误率**: < 15% (目标 < 10%)
- ✅ **逻辑错误率**: < 10% (目标 < 5%)
- ✅ **用户满意度**: 主观评价

---

## 🐛 问题反馈

### 反馈格式

```markdown
**测试场景**: Mermaid Flowchart
**USE_PROMOTE_V4**: true
**用户输入**: [用户输入文本]
**生成代码**: [生成的代码]
**渲染结果**: ✅ 成功 / ❌ 失败
**错误信息**: [如果有]
**预期 vs 实际**: [描述差异]
```

### 常见问题

**问题 1**: 日志显示仍使用 V3
- **原因**: 环境变量未生效
- **解决**: 重启开发服务器，检查 `.env.local`

**问题 2**: TOML 文件加载失败
- **原因**: 文件路径不正确
- **解决**: 确认 `Promote-V4/data/` 目录存在

**问题 3**: 生成代码有语法错误
- **原因**: Prompt 需要优化
- **解决**: 记录具体案例，后续优化 TOML 文件

---

## 📈 成功指标

### Week 1 目标 (本周)

- ✅ **集成完成**: 代码集成，功能开关可用
- ⏳ **基础测试**: Top 5 语言至少各测试 3 个案例
- ⏳ **问题收集**: 记录所有语法/逻辑错误案例
- ⏳ **成功率评估**: 对比 V3 vs V4 的成功率

### Week 2 目标 (下周)

- Prompt 优化 (基于 Week 1 反馈)
- 扩展测试用例
- A/B 测试准备
- 文档完善

---

## 🔧 调试工具

### 查看实际使用的 Prompt

```bash
npx tsx scripts/preview-prompt.ts mermaid flowchart
```

### 测试 TOML 加载器

```bash
npx tsx scripts/test-toml-loader.ts
```

### 查看日志

开发环境下，Service 会输出详细的任务标记和 Prompt 选择日志。

---

## 📝 测试记录模板

创建 `Promote-V4/test-results.md` 记录测试结果：

```markdown
# Promote-V4 测试结果

## 测试环境
- 分支: feature/promote-v4-integration
- USE_PROMOTE_V4: true
- 测试日期: 2025-10-19

## Mermaid Flowchart

### 案例 1: 用户登录流程
- **输入**: [...]
- **生成代码**: [...]
- **渲染结果**: ✅ 成功
- **问题**: 无

### 案例 2: [...]

## PlantUML Sequence

[...]

## 总结

- 成功率: X%
- 主要问题: [...]
- 建议优化: [...]
```

---

**准备好开始测试了吗？** 🚀

1. 设置 `USE_PROMOTE_V4=true`
2. 重启服务器
3. 开始测试 Top 5 语言
4. 记录结果并反馈
