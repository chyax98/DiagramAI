# Ditaa 语法规则详解

## 核心语法元素

### 1. 基本形状

#### 矩形/方框
```
+-----+
|     |
+-----+
```

- 使用 `+` 表示角落
- 使用 `-` 表示水平边
- 使用 `|` 表示垂直边

#### 圆角矩形
```
/-----\
|     |
\-----/
```

- 使用 `/` 和 `\` 连接角落
- 自动渲染为圆角

### 2. 线条和箭头

#### 直线
```
// 水平线
-----

// 垂直线
|
|
|
```

#### 箭头
```
// 向右箭头
--->

// 向左箭头
<---

// 向下箭头
|
v

// 向上箭头
^
|
```

#### 双向箭头
```
<--->
```

### 3. 虚线规则

#### 水平虚线
- **规则**: 包含至少一个 `=` 的线条
- **扩散性**: 一个 `=` 可使整条线变为虚线

```
// 全虚线
=====

// 部分虚线(整条线都会变虚线)
--=--
```

#### 垂直虚线
- **规则**: 包含至少一个 `:` 的线条
- **扩散性**: 一个 `:` 可使整条线变为虚线

```
// 垂直虚线
:
:
:

// 部分虚线(整条线都会变虚线)
|
:
|
```

#### 虚线形状
```
// 虚线矩形
+----+
:    :
:    :
+-=--+

// 虚线存储符号
+----+
:{s} :
:    :
\-=--/
```

### 4. 形状标签系统

#### 标签语法
- **格式**: `{tag}`
- **位置**: 必须在闭合形状内
- **作用**: 改变形状的渲染样式

#### 完整标签列表

| 标签 | 英文名称 | 中文说明 | 用途 |
|------|---------|---------|------|
| `{c}` | Choice | 选择/决策 | 决策节点(菱形) |
| `{d}` | Document | 文档 | 文档符号 |
| `{io}` | Input/Output | 输入/输出 | I/O 操作符号 |
| `{mo}` | Manual Operation | 手动操作 | 手动流程步骤 |
| `{o}` | Ellipse/Oval | 椭圆 | 椭圆形状 |
| `{s}` | Storage | 存储 | 数据库/硬盘符号 |
| `{tr}` | Trapezoid | 梯形 | 梯形符号 |

#### 标签示例
```
// 决策节点
+-----+
| {c} |
+-----+
→ 渲染为菱形

// 文档符号
+-----+
| {d} |
+-----+
→ 底部波浪线

// 存储符号
+-----+
| {s} |
+-----+
→ 圆柱体形状
```

### 5. 颜色系统

#### 颜色码语法
- **格式**: `cXXX`
- **X 值**: 十六进制数字 (0-F)
- **顺序**: RGB (红-绿-蓝)
- **范围**: 仅在闭合形状内有效

#### 十六进制颜色
```
// 第一位 = 红色分量
// 第二位 = 绿色分量
// 第三位 = 蓝色分量

+----+
|cF00|  // 纯红色 (Red=15, Green=0, Blue=0)
+----+

+----+
|c0F0|  // 纯绿色 (Red=0, Green=15, Blue=0)
+----+

+----+
|c00F|  // 纯蓝色 (Red=0, Green=0, Blue=15)
+----+

+----+
|cFFF|  // 白色
+----+

+----+
|c888|  // 灰色
+----+
```

#### 预定义颜色常量

| 代码 | 颜色 | 十六进制等效 |
|------|------|-------------|
| `cRED` | 红色 | `cF00` |
| `cGRE` | 绿色 | `c0F0` |
| `cBLU` | 蓝色 | `c00F` |
| `cYEL` | 黄色 | `cFF0` |
| `cPNK` | 粉色 | `cF0F` |
| `cBLK` | 黑色 | `c000` |

#### 颜色使用示例
```
/-------------+-------------\
|cRED RED     |cBLU BLU     |
+-------------+-------------+
|cGRE GRE     |cPNK PNK     |
+-------------+-------------+
|cBLK BLK     |cYEL YEL     |
\-------------+-------------/
```

#### 文本颜色自动调整
- **深色背景**: 文本自动变为白色
- **浅色背景**: 文本保持黑色(默认)

### 6. 点标记 (实验性)

#### 语法规则
- **符号**: `*`
- **位置**: 线条中间(非末尾)
- **作用**: 标记特殊点

#### 示例
```
*----*
|    |      /--*
*    *      |
|    |  -*--+
*----*
```

**注意**: 此功能仍在实验阶段,行为可能变化。

### 7. 文本处理

#### 项目符号
- **模式**: `' o XXXXX'`
- **规则**:
  - `o` 前后必须有空格
  - `o` 会被渲染为 •
  - XXXXX 为项目文本

```
/-----------------\
| Things to do    |
| cGRE            |
| o Cut the grass |
| o Buy jam       |
| o Fix car       |
\-----------------/
```

#### 文本对齐
```
+----------+
|  Center  |  // 自动居中
+----------+

+----------+
|Left      |  // 左对齐
+----------+
```

### 8. 连接规则

#### 角落连接
```
// 标准直角
+--+
|  |
+--+

// 圆角
/--\
|  |
\--/

// T 型连接
+--+--+
|  |  |
+--+--+

// 十字连接
   |
+--+--+
   |
```

#### 线条交叉
```
// 交叉但不连接(使用空格分离)
  |
--+--
  |

// 避免意外连接
  |
- + -  // 使用空格
  |
```

### 9. 边缘分离

#### 默认行为(启用分离)
```
+---------+
| cBLU    |
|         |
|    +----+
|    |cPNK|
|    |    |
+----+----+
```
→ 共享边缘会分离渲染

#### 禁用分离 (-E 选项)
```
+---------+
| cBLU    |
|         |
|    +----+
|    |cPNK|
|    |    |
+----+----+
```
→ 共享边缘合并渲染

**推荐**: 保持默认(启用分离)以获得更清晰的视觉效果。

## 高级语法技巧

### 1. 组合形状
```
// 文档 + 颜色
+-----+
|cBLU |
| {d} |
+-----+

// 存储 + 虚线 + 颜色
+-----+
:cGRE :
: {s} :
\-=--=/
```

### 2. 复杂流程图
```
    +----------+
    |  Start   |
    +----+-----+
         |
         v
    +----+-----+
    | Process  |
    |   cBLU   |
    +----+-----+
         |
         v
    +----+-----+
    | Decision |
    |   {c}    |
    +----+-----+
       /   \
      /     \
   Yes       No
    /         \
   v           v
+-----+     +-----+
|Path1|     |Path2|
+-----+     +-----+
```

### 3. 系统架构图
```
/----------\     +---------+     /--------\
| Frontend |---->| Backend |---->|Database|
|   cBLU   |     |  cGRE   |     | cYEL   |
|          |     |         |     |  {s}   |
\----------/     +---------/     \--------/
     ^                                 |
     |                                 |
     +------------ Cache ---------------+
                   cPNK
```

### 4. 网络拓扑图
```
        Internet
            |
            v
        +-------+
        |Router |
        | cRED  |
        +---+---+
            |
     +------+------+
     |             |
     v             v
+--------+    +--------+
|Switch 1|    |Switch 2|
| cBLU   |    | cGRE   |
+--------+    +--------+
```

## 语法限制和注意事项

### 1. 字符使用限制
- ❌ 不要混用全角和半角字符
- ❌ 避免使用制表符(Tab),用空格代替
- ❌ 特殊字符(`:` 在文本中)需要注意位置

### 2. 形状约束
- ✅ 标签必须在闭合形状内
- ✅ 颜色代码必须在闭合形状内
- ✅ 形状必须完整闭合才能被识别

### 3. 线条规则
- 线条必须连续,不能有断点
- 虚线特性会"扩散"到整条线
- 交叉线条需要明确连接点

### 4. 空格敏感度
```
// 正确: o 前后有空格
 o Item text

// 错误: 缺少空格
oItem text
o Item text
```

### 5. UTF-8 编码
- 多字节字符必须使用 UTF-8 编码
- 需要配置 TrueType 字体路径
- 中文、日文等需要专门字体支持

## 调试技巧

### 1. 使用调试网格
```bash
java -jar ditaa.jar -d diagram.ditaa
```
→ 在输出图像上显示调试网格

### 2. 分步检查
1. **检查形状闭合**: 确保所有形状完整
2. **验证标签位置**: 标签必须在形状内
3. **确认颜色范围**: 颜色代码仅影响当前形状
4. **测试线条连接**: 确保箭头和线条正确连接

### 3. 常见修复方法
```
// 问题: 形状未闭合
+-----+
|     |
+----    // ❌ 缺少右上角

// 修复
+-----+
|     |
+-----+  // ✅ 完整闭合

// 问题: 颜色不生效
+-----+
cRED    // ❌ 在形状外
+-----+

// 修复
+-----+
|cRED |  // ✅ 在形状内
+-----+
```

## 性能优化建议

1. **简化复杂图表**: 将大图拆分为多个小图
2. **减少颜色数量**: 过多颜色会增加渲染时间
3. **避免过深嵌套**: 保持图表结构扁平
4. **使用缓存**: 对不变的图表使用预渲染结果

## 兼容性说明

### PlantUML 集成
- 使用 `@startditaa` / `@endditaa` 包裹
- 支持 PlantUML 的颜色和样式选项
- **注意**: PlantUML 仅支持 PNG 输出

### Kroki 支持
- 完全支持 Ditaa 语法
- 支持 SVG 和 PNG 输出
- URL 编码:使用 deflate + base64url

### 在线工具差异
- 不同工具可能有细微渲染差异
- 建议以官方 ditaa.jar 为准
- 测试时使用相同版本保证一致性
