# TOML 模板编写完整指南

## 📚 目录

- [TOML 基础](#toml-基础)
- [三层架构详解](#三层架构详解)
- [字段规范](#字段规范)
- [编写最佳实践](#编写最佳实践)
- [常见错误](#常见错误)
- [完整示例](#完整示例)

---

## TOML 基础

### 什么是 TOML?

TOML (Tom's Obvious, Minimal Language) 是一种配置文件格式,具有以下特点:

- ✅ 人类可读性强
- ✅ 明确的数据结构
- ✅ 支持注释
- ✅ 不依赖缩进 (比 YAML 更健壮)
- ✅ 大模型原生支持

### TOML 语法速查

#### 1. Section (表)

```toml
[section_name]
key = "value"

[another_section]
key = "value"
```

#### 2. 字符串

```toml
# 单行字符串
string1 = "一行文本"

# 多行字符串 (三引号)
string2 = """
第一行
第二行
第三行
"""
```

#### 3. 数组

```toml
# 简单数组
array1 = ["item1", "item2", "item3"]

# 多行数组
array2 = [
  "item1",
  "item2",
  "item3"
]

# 包含多行字符串的数组
array3 = [
  """
  第一个条目
  可以有多行
  """,
  """
  第二个条目
  也可以有多行
  """
]
```

#### 4. 数字和布尔值

```toml
integer = 42
float = 3.14
boolean = true
```

#### 5. 注释

```toml
# 这是注释
key = "value"  # 行尾注释
```

---

## 三层架构详解

### 架构理念

```
┌─────────────────────────────────────┐
│ L1: Universal (通用层)               │
│ - 定义所有图表共享的基础规范          │
│ - 角色、约束、流程、质量标准          │
└─────────────────────────────────────┘
              ↓ 继承
┌─────────────────────────────────────┐
│ L2: Language (语言层)                │
│ - 定义特定语言的通用规范              │
│ - 语法、特性、最佳实践                │
└─────────────────────────────────────┘
              ↓ 继承
┌─────────────────────────────────────┐
│ L3: Type (类型层)                    │
│ - 定义特定图表类型的规范              │
│ - 类型特定的约束和流程                │
└─────────────────────────────────────┘
```

### 拼接规则

```typescript
// 最终 AI 收到的内容
final_prompt = L1_TOML + L2_TOML + L3_TOML + Context

// 例如:
[L1_meta]...
[L1_D_role]...
[L1_E_constraints]...

[L2_meta]...
[L2_D_role]...
[L2_E_constraints]...

[L3_meta]...
[L3_D_role]...
[L3_E_constraints]...

[context]
language = "mermaid"
diagram_type = "flowchart"
```

### 为什么不包含任务指令?

**设计决策**: 任务指令 (GENERATE/ADJUST/FIX) 由前端在用户消息中动态注入,而不是写在 System Prompt (TOML) 中。

**原因**:
1. **System Prompt 精简**: 只包含通用规范,不包含任务特定指令
2. **灵活性**: 前端可以根据按钮类型动态构建指令
3. **职责分离**: System = 能力定义, Messages = 具体任务

**前端实现**:
```typescript
const userMessage = {
  generate: `
<<<SYSTEM_INSTRUCTION: GENERATE_NEW_DIAGRAM>>>
任务: 从零生成完整图表代码...
---
用户需求: ${userInput}
`,
  adjust: `
<<<SYSTEM_INSTRUCTION: ADJUST_EXISTING_DIAGRAM>>>
任务: 基于现有代码调整优化...
---
调整需求: ${userInput}
`,
  fix: `
<<<SYSTEM_INSTRUCTION: FIX_SYNTAX_ERRORS_ONLY>>>
任务: 仅修复语法错误...
---
错误信息: ${userInput}
`
};
```

---

## 字段规范

### L1 字段规范

#### [meta] - 元数据

| 字段 | 类型 | 必需 | 说明 | 示例 |
|------|------|------|------|------|
| `level` | 字符串 | ✅ | 层级标识 | "L1" |
| `version` | 字符串 | ✅ | 语义化版本 | "1.0.0" |
| `description` | 字符串 | ✅ | 简短描述 | "所有图表通用的基础规范" |
| `author` | 字符串 | ❌ | 作者 | "DiagramAI Team" |
| `created_at` | 字符串 | ❌ | 创建日期 | "2025-10-19" |
| `updated_at` | 字符串 | ❌ | 更新日期 | "2025-10-19" |

#### [D_role] - 角色定义

| 字段 | 类型 | 必需 | 最小数量 | 说明 |
|------|------|------|----------|------|
| `target_task` | 字符串 | ✅ | - | 总体目标描述 |
| `base_roles` | 数组 | ✅ | 3 个 | 基础角色列表 |

**示例**:
```toml
[D_role]
target_task = "为用户生成高质量的图表代码"
base_roles = [
  "需求分析专家",
  "图表架构师",
  "代码实现工程师"
]
```

#### [E_constraints] - 约束条件

| 字段 | 类型 | 必需 | 最小数量 | 说明 |
|------|------|------|----------|------|
| `items` | 数组 | ✅ | 5 条 | 约束条目列表 |

**编写要点**:
- 每条约束应该是明确的、可验证的
- 使用 `"""` 三引号包裹多行内容
- 可以使用 Markdown 格式 (加粗、列表等)

**示例**:
```toml
[E_constraints]
items = [
  """
  **输出格式**: 必须输出完整可执行的代码,不得包含占位符或注释说明。
  """,

  """
  **语法正确性**: 代码必须严格符合目标语言的语法规范。
  """,
]
```

#### [P_process] - 流程规范

| 字段 | 类型 | 必需 | 最小数量 | 说明 |
|------|------|------|----------|------|
| `items` | 数组 | ✅ | 3 条 | 流程步骤列表 |

**编写要点**:
- 按照时间顺序编号 (1, 2, 3...)
- 每个步骤描述清楚要做什么
- 可以包含子步骤 (使用缩进或嵌套列表)

**示例**:
```toml
[P_process]
items = [
  """
  **1. 任务识别**: 从用户消息中识别任务类型。
  """,

  """
  **2. 需求分析**:
  - GENERATE: 理解用户需求
  - ADJUST: 分析现有代码
  - FIX: 定位语法问题
  """,
]
```

#### [H_quality] - 质量标准

| 字段 | 类型 | 必需 | 最小数量 | 说明 |
|------|------|------|----------|------|
| `items` | 数组 | ✅ | 3 条 | 质量标准列表 |

**编写要点**:
- 应该是可验证的标准
- 明确检查什么,如何判断合格
- 可以针对不同任务类型 (GENERATE/ADJUST/FIX)

**示例**:
```toml
[H_quality]
items = [
  """
  **代码完整性**: 包含所有必需元素,无省略或占位符。
  """,

  """
  **任务符合度**:
  - GENERATE: 完整表达用户需求
  - ADJUST: 精准响应调整需求
  - FIX: 仅修复语法问题
  """,
]
```

### L2 字段规范

#### [meta] - 元数据

在 L1 基础上增加:

| 字段 | 类型 | 必需 | 说明 | 示例 |
|------|------|------|------|------|
| `language` | 字符串 | ✅ | 语言名称 (必须在 RENDER_LANGUAGES 中) | "mermaid" |
| `language_version` | 字符串 | ❌ | 语言版本 | "10.0.0" |
| `kroki_support` | 布尔 | ❌ | 是否支持 Kroki | true |
| `official_docs` | 字符串 | ❌ | 官方文档链接 | "https://mermaid.js.org/" |

#### [D_role] - 角色定义

| 字段 | 类型 | 必需 | 最小数量 | 说明 |
|------|------|------|----------|------|
| `additional_roles` | 数组 | ✅ | 2 个 | 语言特定角色 |

**示例**:
```toml
[D_role]
additional_roles = [
  "Mermaid 语法专家",
  "流程图设计师"
]
```

#### [E_constraints], [P_process], [H_quality]

与 L1 类似,但内容应该是**语言特定**的:

| Section | 最小数量 | 内容重点 |
|---------|----------|----------|
| `E_constraints` | 3 条 | 语言语法规范、特性限制 |
| `P_process` | 2 条 | 语言特定的代码生成流程 |
| `H_quality` | 2 条 | 语言特定的质量标准 |

### L3 字段规范

#### [meta] - 元数据

在 L2 基础上增加:

| 字段 | 类型 | 必需 | 说明 | 示例 |
|------|------|------|------|------|
| `diagram_type` | 字符串 | ✅ | 图表类型 (必须在 LANGUAGE_DIAGRAM_TYPES 中) | "flowchart" |
| `complexity` | 字符串 | ❌ | 复杂度 (low/medium/high) | "medium" |
| `target_length` | 整数 | ❌ | 目标字数 | 2800 |
| `use_cases` | 数组 | ❌ | 适用场景 | ["业务流程", "算法流程"] |

#### [D_role] - 角色定义

| 字段 | 类型 | 必需 | 最小数量 | 说明 |
|------|------|------|----------|------|
| `additional_roles` | 数组 | ✅ | 1 个 | 类型特定角色 |

#### [E_constraints], [P_process], [H_quality]

与 L1/L2 类似,但内容应该是**类型特定**的:

| Section | 最小数量 | 内容重点 |
|---------|----------|----------|
| `E_constraints` | 5 条 | 类型特定的语法规范和约束 |
| `P_process` | 3 条 | 类型特定的设计和实现流程 |
| `H_quality` | 2 条 | 类型特定的质量标准 |

---

## 编写最佳实践

### 1. 约束条件 (E_constraints)

#### ✅ 好的约束

```toml
[E_constraints]
items = [
  """
  **流程图语法**: 必须使用 `flowchart TD` (上下布局) 或 `flowchart LR` (左右布局) 语法,不得使用已废弃的 `graph` 语法。
  """,

  """
  **节点形状规范**: 根据节点类型选择合适的形状:
  - 圆角矩形 `[操作]`: 普通操作步骤
  - 菱形 `{判断?}`: 决策节点
  - 平行四边形 `[/输入/]`: 输入输出
  - 圆形 `((开始/结束))`: 起止节点
  """,
]
```

**特点**:
- ✅ 明确具体,可验证
- ✅ 提供示例和说明
- ✅ 使用 Markdown 格式增强可读性
- ✅ 区分"必须"和"建议"

#### ❌ 不好的约束

```toml
[E_constraints]
items = [
  "代码要好",  # 太笼统,无法验证
  "flowchart",  # 不完整,缺少上下文
  "节点要清楚",  # 太主观,标准不明确
]
```

### 2. 流程规范 (P_process)

#### ✅ 好的流程

```toml
[P_process]
items = [
  """
  **1. 识别流程要素**:
  - 起点: 流程的触发条件或开始动作
  - 终点: 流程的结束状态 (成功、失败、取消等)
  - 关键步骤: 核心操作节点
  - 决策点: 需要判断和分支的地方
  - 异常处理: 错误情况的处理路径
  """,

  """
  **2. 提取流程逻辑**:
  - 主流程: 正常情况下的标准流程路径
  - 分支流程: 基于条件判断的不同路径
  - 异常流程: 错误、失败、超时等异常情况的处理
  - 循环流程: 需要重复执行的步骤
  """,
]
```

**特点**:
- ✅ 有明确的步骤编号
- ✅ 每个步骤有清晰的子任务
- ✅ 使用嵌套列表组织内容
- ✅ 覆盖关键的处理场景

#### ❌ 不好的流程

```toml
[P_process]
items = [
  "先分析",  # 太简单,缺少细节
  "然后写代码",  # 不具体,没有指导性
  "最后检查",  # 没说检查什么
]
```

### 3. 质量标准 (H_quality)

#### ✅ 好的标准

```toml
[H_quality]
items = [
  """
  **流程逻辑完整性**:
  - 所有流程路径都有明确的终点 (结束节点)
  - 决策节点的所有分支都有处理
  - 无悬空节点或断裂路径
  - 循环逻辑合理,有明确的退出条件
  """,

  """
  **决策节点清晰度**:
  - 决策节点使用菱形表示
  - 判断条件清晰明确
  - 每个分支都有标签说明 (是/否, 成功/失败等)
  - 覆盖所有可能的情况
  """,
]
```

**特点**:
- ✅ 可验证,有明确的检查项
- ✅ 使用嵌套列表详细说明
- ✅ 覆盖多个质量维度
- ✅ 给出具体的判断标准

#### ❌ 不好的标准

```toml
[H_quality]
items = [
  "代码质量好",  # 不可验证
  "流程清晰",  # 太主观
  "没有错误",  # 标准不明确
]
```

### 4. 多行文本格式

#### ✅ 推荐格式

```toml
items = [
  """
  **标题**: 简短描述

  详细内容:
  - 要点 1
  - 要点 2
  - 要点 3
  """,
]
```

**特点**:
- ✅ 使用 `"""` 三引号
- ✅ 支持 Markdown 格式
- ✅ 保持缩进一致
- ✅ 内容结构清晰

#### ❌ 不推荐格式

```toml
items = ["单行文本,但是很长很长很长很长很长很长很长很长很长很长很长很长"]  # 难以阅读

items = [
  "多行文本
  没有三引号"  # 语法错误!
]
```

---

## 常见错误

### 错误 1: 忘记三引号

❌ **错误**:
```toml
items = [
  "第一行
  第二行"  # 语法错误!
]
```

✅ **正确**:
```toml
items = [
  """
  第一行
  第二行
  """
]
```

### 错误 2: 字段名拼写错误

❌ **错误**:
```toml
[D_role]
roles = [...]  # 错误! 应该是 base_roles 或 additional_roles
```

✅ **正确**:
```toml
[D_role]
base_roles = [...]  # L1
# 或
additional_roles = [...]  # L2/L3
```

### 错误 3: 数组逗号错误

❌ **错误**:
```toml
items = [
  "item1"
  "item2",  # 缺少逗号!
]
```

✅ **正确**:
```toml
items = [
  "item1",
  "item2",
  "item3"
]
```

### 错误 4: Section 名称错误

❌ **错误**:
```toml
[D-role]  # 错误! 应该用下划线
[E.constraints]  # 错误! 应该用下划线
```

✅ **正确**:
```toml
[D_role]
[E_constraints]
```

### 错误 5: 语言/类型不对齐

❌ **错误**:
```toml
[meta]
language = "mermaid"
diagram_type = "custom_flowchart"  # 错误! 前端没有这个类型
```

✅ **正确**: 查看 `src/lib/constants/diagram-types.ts`
```typescript
// 确保 diagram_type 在这里定义
LANGUAGE_DIAGRAM_TYPES = {
  mermaid: [
    { value: "flowchart", ... },  // ✅ 使用这个
    { value: "sequence", ... },
  ]
}
```

---

## 完整示例

### L1 完整示例

```toml
[meta]
level = "L1"
version = "1.0.0"
description = "所有图表通用的基础规范"

[D_role]
target_task = "为用户生成高质量的图表代码"
base_roles = [
  "需求分析专家",
  "图表架构师",
  "代码实现工程师"
]

[E_constraints]
items = [
  """
  **输出格式**: 必须输出完整可执行的代码。
  """,

  """
  **语法正确性**: 代码必须符合语法规范。
  """,

  """
  **完整性**: 包含所有必需元素。
  """,

  """
  **唯一性**: 标识符必须唯一。
  """,

  """
  **任务遵从**: 严格遵守任务指令。
  """,
]

[P_process]
items = [
  """
  **1. 任务识别**: 识别任务类型。
  """,

  """
  **2. 需求分析**: 理解用户需求。
  """,

  """
  **3. 结构设计**: 设计图表结构。
  """,
]

[H_quality]
items = [
  """
  **代码完整性**: 无省略或占位符。
  """,

  """
  **语法正确性**: 符合语言规范。
  """,

  """
  **逻辑清晰度**: 结构合理清晰。
  """,
]
```

### L2 完整示例

```toml
[meta]
level = "L2"
language = "mermaid"
version = "1.0.0"

[D_role]
additional_roles = [
  "Mermaid 语法专家",
  "流程图设计师"
]

[E_constraints]
items = [
  """
  **Mermaid 语法**: 使用官方语法规范。
  """,

  """
  **节点 ID**: 必须唯一且语义化。
  """,

  """
  **Kroki 兼容**: 能被 Kroki 渲染。
  """,
]

[P_process]
items = [
  """
  **1. 选择图表类型**: flowchart/sequence/class 等。
  """,

  """
  **2. 设计节点结构**: 清晰的命名和层次。
  """,
]

[H_quality]
items = [
  """
  **Mermaid 语法验证**: 符合官方规范。
  """,

  """
  **Kroki 渲染测试**: 成功渲染为 SVG。
  """,
]
```

### L3 完整示例

```toml
[meta]
level = "L3"
language = "mermaid"
diagram_type = "flowchart"
version = "1.0.0"

[D_role]
additional_roles = [
  "流程图逻辑专家"
]

[E_constraints]
items = [
  """
  **流程图语法**: 使用 flowchart TD/LR。
  """,

  """
  **开始结束节点**: 明确标注。
  """,

  """
  **决策节点**: 使用菱形表示。
  """,

  """
  **节点形状**: 根据类型选择。
  """,

  """
  **流程完整性**: 所有路径有终点。
  """,
]

[P_process]
items = [
  """
  **1. 识别流程要素**: 起点、终点、决策点。
  """,

  """
  **2. 提取流程逻辑**: 主流程、分支、异常。
  """,

  """
  **3. 设计节点关系**: 先后顺序和依赖。
  """,
]

[H_quality]
items = [
  """
  **流程逻辑完整性**: 所有路径有终点。
  """,

  """
  **决策节点清晰度**: 判断条件明确。
  """,
]
```

---

## 验证清单

在提交 TOML 文件之前,请检查:

### 语法检查
- [ ] TOML 语法正确 (使用在线工具验证)
- [ ] 所有字符串正确使用引号
- [ ] 数组元素之间有逗号
- [ ] Section 名称使用下划线

### 内容检查
- [ ] 所有必需字段都存在
- [ ] `items` 数组满足最小数量要求
- [ ] 语言/类型与前端定义对齐
- [ ] 使用三引号包裹多行内容

### 质量检查
- [ ] 约束条件明确可验证
- [ ] 流程步骤清晰有序
- [ ] 质量标准可衡量
- [ ] 内容与层级定位一致 (通用/语言/类型)

### 格式检查
- [ ] 使用 Markdown 格式增强可读性
- [ ] 适当使用加粗、列表、代码块
- [ ] 保持缩进一致
- [ ] 添加必要的注释

---

## 参考资源

- TOML 官方规范: https://toml.io/
- TOML 在线验证: https://www.toml-lint.com/
- Markdown 语法: https://www.markdownguide.org/basic-syntax/
- 项目类型定义: `src/lib/constants/diagram-types.ts`

---

**编写愉快!** 🚀

如有问题,请参考 `templates/README.md` 或提交 Issue。
