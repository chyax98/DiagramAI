# BPMN 官方文档

> **验证时间**: 2025-10-13
> **信息来源**: OMG BPMN Specification, Kroki Documentation

---

## 📋 概述

**BPMN (Business Process Model and Notation)** 是由 OMG (Object Management Group) 制定的业务流程建模标准，用于以图形化方式描述业务流程。

- **官方网站**: https://www.omg.org/bpmn/
- **当前版本**: BPMN 2.0
- **ISO 标准**: ISO/IEC 19510
- **Kroki 支持**: 通过 bpmn-js 引擎渲染

---

## 🎯 设计目标

### 核心理念

1. **业务用户友好** - 非技术人员也能理解流程图
2. **技术精确性** - 能够表达复杂的流程语义
3. **标准化** - 统一的符号和语义定义
4. **可执行性** - 可转换为可执行的流程定义 (BPEL)

### 三种图表类型

| 图表类型 | 英文 | 用途 | 适用场景 |
|---------|------|------|---------|
| **协作图** | Collaboration Diagram | 多个参与者之间的交互 | 跨部门流程、B2B 流程 |
| **流程图** | Process Diagram | 单个流程的详细步骤 | 内部业务流程、SOP |
| **编排图** | Choreography Diagram | 消息交换序列 | 服务编排、事件驱动架构 |

---

## 🏗️ 核心元素分类

### 1. Flow Objects (流对象)

#### 1.1 Events (事件)

**Start Events (开始事件)**:

| 符号 | 类型 | 描述 | 示例 |
|------|------|------|------|
| ⭕ | None Start | 默认启动 | 流程开始 |
| 📧 | Message Start | 收到消息触发 | 客户发送询价 |
| ⏰ | Timer Start | 定时触发 | 每日凌晨执行 |
| 📡 | Signal Start | 收到广播信号 | 系统告警触发 |
| 🔀 | Conditional Start | 条件满足触发 | 库存低于阈值 |
| ➕ | Multiple Start | 多种触发方式 | 消息或定时器 |
| ⊕ | Parallel Multiple | 需同时满足多个条件 | 消息且定时器 |

**Intermediate Events (中间事件)**:

| 符号 | 类型 | 描述 | 位置 |
|------|------|------|------|
| ⭕ | None Intermediate | 流程节点 | 流程中 |
| 📧 | Message Catch/Throw | 接收/发送消息 | 流程中或边界 |
| ⏰ | Timer | 等待时间 | 流程中或边界 |
| ❌ | Error | 捕获错误 | 仅边界 |
| 🚫 | Cancel | 取消交易 | 仅边界 (交易子流程) |
| 🔗 | Link | 页面跳转 | 流程中 |
| 📡 | Signal Catch/Throw | 接收/发送信号 | 流程中或边界 |

**End Events (结束事件)**:

| 符号 | 类型 | 描述 | 结果 |
|------|------|------|------|
| ⚫ | None End | 默认结束 | 流程终止 |
| 📧 | Message End | 发送消息并结束 | 发送响应 |
| ❌ | Error End | 抛出错误并结束 | 触发错误处理 |
| 🚫 | Cancel End | 取消交易并结束 | 回滚交易 |
| 💥 | Terminate End | 立即终止所有流程 | 强制停止 |

#### 1.2 Activities (活动)

**Task Types (任务类型)**:

```
┌─────────────┐
│   Task      │  - 普通任务
└─────────────┘

┌─────────────┐
│ 👤 User Task│  - 人工任务
└─────────────┘

┌─────────────┐
│ ⚙️ Service  │  - 服务任务 (API 调用)
└─────────────┘

┌─────────────┐
│ ✉️ Send Msg │  - 发送消息任务
└─────────────┘

┌─────────────┐
│ 📥 Receive  │  - 接收消息任务
└─────────────┘

┌─────────────┐
│ 📜 Script   │  - 脚本任务
└─────────────┘

┌─────────────┐
│ 🤝 Manual   │  - 手动任务 (系统外)
└─────────────┘

┌─────────────┐
│ 💼 Business │  - 业务规则任务
│    Rule     │
└─────────────┘
```

**Sub-Process (子流程)**:

```
┌─────────────┐
│    ┌─┐      │  - 嵌入式子流程
│    └─┘      │
└─────────────┘

┌─────────────┐
│    ┌+┐      │  - 调用活动 (可重用)
│    └─┘      │
└─────────────┘

┌─────────────┐
│    ≡≡≡      │  - 循环子流程
│    ┌─┐      │
│    └─┘      │
└─────────────┘
```

#### 1.3 Gateways (网关)

**Decision Gateways (决策网关)**:

| 符号 | 类型 | 逻辑 | 说明 |
|------|------|------|------|
| ◇ | Exclusive (XOR) | 只选一条路径 | 互斥选择 |
| ◇ + | Inclusive (OR) | 选一条或多条路径 | 包容选择 |
| ◇ + | Parallel (AND) | 所有路径并行 | 并行分支 |
| ◇ ⭐ | Event-Based | 等待事件决定路径 | 事件驱动 |
| ◇ % | Complex | 复杂逻辑 | 自定义规则 |

**示例**:

```
Exclusive Gateway (XOR):
    ───◇───
      / \
  Yes/   \No
    /     \

Parallel Gateway (AND):
    ───◇+──
      /|\
     / | \
    同时执行

Inclusive Gateway (OR):
    ───◇+──
      /|\
     / | \
    一条或多条
```

### 2. Connecting Objects (连接对象)

#### 2.1 Sequence Flow (顺序流)

```
──────────>  - 正常流向
- - - - - >  - 条件流 (带条件)
━━━━━━━━>  - 默认流 (其他条件都不满足)
```

#### 2.2 Message Flow (消息流)

```
○────────>○  - 参与者之间的消息
```

#### 2.3 Association (关联)

```
··········>  - 数据对象或文本注释关联
```

### 3. Swimlanes (泳道)

#### 3.1 Pool (池)

```
┌─────────────────────────────────┐
│ Pool: 组织/系统                  │
├─────────────────────────────────┤
│         Process Flow            │
└─────────────────────────────────┘
```

- 代表一个参与者 (组织、角色或系统)
- 可以包含多个 Lane
- Black Box Pool: 不显示内部流程

#### 3.2 Lane (泳道)

```
┌─────────────────────────────────┐
│ Pool                            │
├──────────┬──────────────────────┤
│ Lane 1   │   Process Steps      │
├──────────┼──────────────────────┤
│ Lane 2   │   Process Steps      │
└──────────┴──────────────────────┘
```

- 在 Pool 内部进一步划分职责
- 通常代表角色、部门或系统模块

### 4. Artifacts (工件)

#### 4.1 Data Object (数据对象)

```
📄 - 流程中的数据/文档
📁 - 数据集合
💾 - 数据存储
```

#### 4.2 Annotation (注释)

```
╭─────────╮
│ 注释文本 │
╰─────────╯
```

---

## 📐 BPMN 语法规则

### 1. 基本结构规则

```xml
<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI">

  <process id="Process_1" isExecutable="false">
    <!-- Flow Objects -->
    <startEvent id="StartEvent_1" name="Start"/>
    <task id="Task_1" name="Do Something"/>
    <endEvent id="EndEvent_1" name="End"/>

    <!-- Sequence Flows -->
    <sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1"/>
    <sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="EndEvent_1"/>
  </process>

</definitions>
```

### 2. 命名规则

**ID 规则**:
- 必须唯一
- 推荐格式: `ElementType_Number` (如 `Task_1`, `Gateway_2`)
- 区分大小写

**Name 规则**:
- 可选，但强烈推荐
- 用于描述元素功能
- 可以包含中文

### 3. 事件规则

**Start Event**:
- 每个流程至少有一个
- 不能有incoming flow
- 可以有多个 (多种触发方式)

**End Event**:
- 至少有一个
- 不能有 outgoing flow
- 可以有多个 (不同结束状态)

**Intermediate Event**:
- 必须有 incoming 和 outgoing flow
- 可以附加到 Activity 边界 (Boundary Event)

### 4. Gateway 规则

**Exclusive Gateway (XOR)**:
- 必须有多个 outgoing flow
- 每个 outgoing flow 应有条件表达式
- 必须有一个默认流 (default flow)

**Parallel Gateway (AND)**:
- 分支: 1 个 incoming, 多个 outgoing
- 汇聚: 多个 incoming, 1 个 outgoing
- 必须成对使用 (分支和汇聚)

**Inclusive Gateway (OR)**:
- 类似 Exclusive，但可以选择多条路径
- 汇聚时等待所有活动路径

### 5. 消息流规则

- 只能在不同 Pool 之间
- 不能在同一个 Pool 内部使用
- 必须连接到 Message Event 或 Send/Receive Task

### 6. 数据关联规则

```xml
<dataObjectReference id="DataObject_1" name="订单" dataObjectRef="DataObject_Order"/>
<dataInputAssociation>
  <sourceRef>DataObject_1</sourceRef>
  <targetRef>Task_1</targetRef>
</dataInputAssociation>
```

---

## 🔧 Kroki BPMN 支持

### 在 Kroki 中使用 BPMN

**API 格式**:
```
POST https://kroki.io/bpmn/svg
Content-Type: text/plain

<BPMN XML content>
```

**URL 编码格式**:
```
GET https://kroki.io/bpmn/svg/<base64_encoded_xml>
```

### 支持的输出格式

- **SVG** (推荐): 矢量图，可缩放
- **PNG**: 位图
- **PDF**: 文档格式

### 限制

1. **复杂度限制**: 单个图表建议不超过 50 个元素
2. **文件大小**: XML 不超过 100KB
3. **渲染超时**: 5 秒

---

## 📚 标准文档

### OMG BPMN 2.0 规范

- **规范文档**: https://www.omg.org/spec/BPMN/2.0/
- **ISO 标准**: ISO/IEC 19510:2013
- **页数**: 538 页完整规范

### 相关标准

- **BPEL**: Business Process Execution Language (执行引擎)
- **DMN**: Decision Model and Notation (决策建模)
- **CMMN**: Case Management Model and Notation (案例管理)

---

## 🛠️ 工具生态

### 1. 建模工具

- **Camunda Modeler** (开源): https://camunda.com/download/modeler/
- **bpmn.io** (在线): https://demo.bpmn.io/
- **Signavio** (商业)
- **Bizagi Modeler** (免费)

### 2. 执行引擎

- **Camunda Platform** (开源)
- **Flowable** (开源)
- **Activiti** (开源)
- **jBPM** (开源)

### 3. 库和框架

- **bpmn-js** (JavaScript): BPMN 渲染和建模
- **bpmn-python** (Python): BPMN 解析
- **bpmn-moddle** (JavaScript): BPMN XML 解析

---

## 📖 学习资源

### 官方资源

- **OMG BPMN**: https://www.omg.org/bpmn/
- **BPMN Quick Guide**: https://www.omg.org/bpmn/Documents/BPMN_Quick_Guide.pdf

### 社区资源

- **bpmn.io Forum**: https://forum.bpmn.io/
- **Camunda Forum**: https://forum.camunda.io/
- **BPMN.io Blog**: https://bpmn.io/blog/

### 在线教程

- **Camunda BPMN Tutorial**: https://camunda.com/bpmn/
- **BPMN Guide by Heflo**: https://www.heflo.com/blog/bpmn-notation/
- **Visual Paradigm BPMN**: https://www.visual-paradigm.com/guide/bpmn/

---

## 💡 最佳实践

### 1. 命名约定

```xml
<!-- ✅ 好的命名 -->
<startEvent id="StartEvent_OrderReceived" name="订单接收"/>
<task id="Task_ValidateOrder" name="验证订单"/>
<endEvent id="EndEvent_OrderProcessed" name="订单处理完成"/>

<!-- ❌ 避免 -->
<startEvent id="start1"/>
<task id="task"/>
<endEvent id="end"/>
```

### 2. 流程层次

- **Level 1**: 高层次流程 (5-10 个活动)
- **Level 2**: 详细流程 (10-30 个活动)
- **Level 3**: 实现细节 (使用子流程)

### 3. Gateway 使用

```xml
<!-- ✅ 推荐: 使用 Exclusive Gateway 的默认流 -->
<exclusiveGateway id="Gateway_1" default="Flow_Default"/>
<sequenceFlow id="Flow_Approved" sourceRef="Gateway_1" targetRef="Task_Approve">
  <conditionExpression>approved == true</conditionExpression>
</sequenceFlow>
<sequenceFlow id="Flow_Default" sourceRef="Gateway_1" targetRef="Task_Reject"/>

<!-- ❌ 避免: 所有分支都有条件，可能死锁 -->
<exclusiveGateway id="Gateway_1"/>
<sequenceFlow id="Flow_1" sourceRef="Gateway_1" targetRef="Task_1">
  <conditionExpression>score > 80</conditionExpression>
</sequenceFlow>
<sequenceFlow id="Flow_2" sourceRef="Gateway_1" targetRef="Task_2">
  <conditionExpression>score <= 80</conditionExpression>
</sequenceFlow>
```

### 4. 错误处理

```xml
<!-- 使用 Boundary Error Event -->
<subProcess id="SubProcess_1">
  <!-- 子流程内容 -->
</subProcess>
<boundaryEvent id="BoundaryEvent_Error" attachedToRef="SubProcess_1">
  <errorEventDefinition/>
</boundaryEvent>
<sequenceFlow sourceRef="BoundaryEvent_Error" targetRef="Task_HandleError"/>
```

---

**文档更新**: 2025-10-13
**数据来源**: OMG BPMN 规范, Kroki 文档, 社区最佳实践
