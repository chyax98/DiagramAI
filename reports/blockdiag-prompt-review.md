# BlockDiag Prompt 系统审查报告

**语言**: BlockDiag
**文件位置**: `/root/Diagram/DiagramAI/src/lib/constants/prompts/blockdiag/`
**审查日期**: 2025-10-13
**审查范围**: L2 (common.txt) + L3 (block.txt, group.txt)

---

## 📊 文件清单

| 文件 | 类型 | 行数 | 功能 |
|------|------|------|------|
| `common.txt` | L2 通用规范 | 176 行 | BlockDiag 语法基础 |
| `block.txt` | L3 图表类型 | 263 行 | 块状流程图生成规范 |
| `group.txt` | L3 图表类型 | 365 行 | 分组图生成规范 |

**总计**: 804 行

---

## ✅ 优点分析

### 1. L2 通用规范质量高

**强制规则清晰**:
- ✅ 规则 1: 图表声明语法 - 包含错误示例和后果
- ✅ 规则 2: 属性语法 - 明确 `[属性名 = "值"]` 格式
- ✅ 规则 3: 中文标签引号 - 防止编译失败
- ✅ 专家视角定义完整 - 流程设计专家 + BlockDiag 工程师 + 代码审查员

**语法覆盖全面**:
- 图表声明、节点定义、边定义、分组 (Group) 全部覆盖
- 属性列表详细: `label`, `shape`, `color`, `style`

**检查清单实用**:
- 6 项检查项,覆盖关键语法点
- 明确要求"任何检查项不通过,立即修正后重新生成"

---

### 2. L3 文件结构完整

**block.txt (块状流程图)**:
- ✅ 3 个示例,从简单到高级,难度递进合理
- ✅ 示例 1: 登录流程 (简单) - 8 个节点,包含决策分支
- ✅ 示例 2: 订单处理 (中等) - 展示 `group` 分组和颜色区分
- ✅ 示例 3: 微服务架构 (高级) - 展示系统模块关系,分层清晰
- ✅ 常见错误 3 个,覆盖缺少标签、缺少声明、决策节点形状

**group.txt (分组图)**:
- ✅ 3 个示例,覆盖三层架构、微服务、企业组织架构
- ✅ 示例 2: 微服务架构 - 使用嵌套 `group` 表示子模块,非常清晰
- ✅ 示例 3: 企业组织架构 - 展示 `orientation = portrait` 布局控制
- ✅ 常见错误覆盖节点未定义、嵌套分组语法错误

---

## ⚠️ 问题与改进建议

### 问题 1: L2 与 L3 存在内容重复

**重复内容**:
- L2 (common.txt) 第 102-176 行: 包含核心语法、节点定义、边定义、分组
- L3 (block.txt) 第 11-46 行: 再次定义基础块状流程图语法和节点形状
- L3 (group.txt) 第 11-58 行: 再次定义分组语法

**问题严重性**: 🟡 中等

**影响**:
- Prompt 总长度增加约 15% (120+ 行重复)
- AI 需要处理冗余信息,可能导致理解混淆

**改进建议**:
```markdown
## L2 (common.txt) 应该保留的内容
- 强制规则 (必须)
- 专家视角 (必须)
- 基础语法 (图表声明、节点定义、边定义)
- 生成检查清单 (必须)

## L3 应该专注的内容
- 图表类型特异性语法 (block: 节点形状; group: 嵌套分组)
- 该类型的生成示例 (3 个,难度递进)
- 该类型的常见错误 (3-5 个)
- 该类型的检查清单 (扩展 L2)

## 建议删除 L3 中的内容
- ❌ 删除 L3 中的基础语法重复内容
- ❌ 删除 L3 中的"核心语法"章节 (已在 L2 定义)
- ✅ 仅保留该类型特有的语法点
```

---

### 问题 2: group.txt 中的特异性不够突出

**当前问题**:
- `group.txt` 第 11-58 行定义了分组语法,但与 `block.txt` 的差异不明显
- 未明确说明 `group` 类型与 `block` 类型的核心区别

**改进建议**:
```markdown
## 在 group.txt 开头添加
> **Block vs Group 的核心区别**
> - **Block**: 强调流程和连接关系,节点间有明确的 `->` 连接
> - **Group**: 强调逻辑分组和层次结构,节点的分组归属比连接更重要
> - **Group** 更适合展示模块化系统和组织架构,**Block** 更适合展示流程执行顺序

## 突出 Group 特有语法
- `group { label = "..."; 节点列表; }`
- 嵌套分组: `group { group { ... } }`
- `orientation = portrait` 布局方向控制
- `shape = "line"` 分组边框样式
```

---

### 问题 3: 检查清单未区分 L2 和 L3

**当前问题**:
- L2 (common.txt) 的检查清单: 6 项
- L3 (block.txt) 的检查清单: 8 项
- L3 (group.txt) 的检查清单: 7 项
- 三者存在重复项,且未明确哪些是 L3 特有的

**改进建议**:
```markdown
## L2 检查清单 (通用,所有图表都需要)
- [ ] **图表声明正确**
- [ ] **节点定义完整**
- [ ] **连接线合理**
- [ ] **属性格式正确**
- [ ] **代码可渲染**

## L3 检查清单 (在 L2 基础上扩展)
### block.txt
- [ ] **节点形状**: 决策节点使用 `diamond`
- [ ] **条件分支**: 分支连接线有 `label` 标注条件
- [ ] **颜色区分**: 使用 `color` 区分不同类型节点

### group.txt
- [ ] **分组定义**: 每个 `group` 都有 `label`
- [ ] **嵌套合理**: 嵌套层级清晰,不过深
- [ ] **跨分组连接**: 连接关系正确定义
```

---

### 问题 4: 示例代码存在语法不一致

**问题位置**: `block.txt` 第 98-109 行

**代码片段**:
```blockdiag
group {
  label = "订单验证阶段";
  color = "#FFE0E0";
  A; B; C;
}
```

**问题**: 使用 `color` 属性,但 L2 (common.txt) 第 161 行仅提到 `label`, `color`, `shape` 作为分组属性,未明确 `color` 是背景色还是边框色

**改进建议**:
```markdown
## 在 L2 (common.txt) 明确分组属性
**分组属性**：
- `label` - 分组标签
- `color` - 分组背景颜色 (填充色)
- `shape` - 分组边框形状 (box, line 等)
- `style` - 分组边框样式 (dashed, dotted 等)
```

---

## 📈 量化评分

| 评估维度 | 得分 | 说明 |
|---------|------|------|
| **L2 覆盖度** | 9/10 | 强制规则完整,专家视角清晰,语法覆盖全面 |
| **L3 示例质量** | 9/10 | 3 个示例难度递进,代码完整可执行 |
| **错误预防** | 8/10 | 常见错误覆盖较全,但可增加更多边界情况 |
| **内容去重** | 6/10 | L2 与 L3 存在 15% 内容重复 |
| **类型特异性** | 7/10 | group.txt 的特异性不够突出 |
| **可维护性** | 8/10 | 结构清晰,但检查清单存在重复 |
| **总体评分** | **8.0/10** | 优秀,但有改进空间 |

---

## 🎯 优先改进建议

### 高优先级 (P0)
1. **删除 L3 中的语法重复内容** - 减少 Prompt 长度 15%
2. **在 group.txt 开头添加 Block vs Group 区别说明** - 增强类型特异性

### 中优先级 (P1)
3. **统一检查清单结构** - L2 通用 + L3 扩展
4. **明确分组属性的作用** - 避免歧义

### 低优先级 (P2)
5. **增加边界情况示例** - 如 42 个节点的极端情况
6. **增加性能优化建议** - 如避免过深嵌套

---

## 📝 总结

**BlockDiag Prompt 系统整体质量优秀**,L2 和 L3 结构清晰,示例丰富。主要问题是 **L2 与 L3 存在内容重复** 和 **group.txt 特异性不够突出**。建议优先删除重复内容,并在 group.txt 中明确 Group 与 Block 的核心区别。

**符合 Prompt 三层设计原则**: ✅ L1 (universal) + L2 (common) + L3 (type-specific) 结构合理,仅需优化内容重复问题。
