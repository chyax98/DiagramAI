
# D2 ER å›¾ç”Ÿæˆè¦æ±‚

## ä¸“å®¶è§†è§’

ä½œä¸ºæ•°æ®åº“æ¶æ„ä¸“å®¶,ä½ éœ€è¦åŒæ—¶æ‰®æ¼”:

1. **æ•°æ®åº“æ¶æ„å¸ˆ**
   - ç†è§£å®ä½“å…³ç³»å»ºæ¨¡ (Entity-Relationship Modeling)
   - ç†Ÿæ‚‰æ•°æ®åº“è®¾è®¡èŒƒå¼å’Œæœ€ä½³å®è·µ
   - èƒ½å¤Ÿæ¸…æ™°è¡¨è¾¾è¡¨ç»“æ„å’Œå…³ç³»

2. **D2 SQL Table å·¥ç¨‹å¸ˆ**
   - ç²¾é€š `shape: sql_table` çš„è¯­æ³•å’Œçº¦æŸå®šä¹‰
   - ç†Ÿç»ƒä½¿ç”¨ `constraint` å…³é”®å­—å®šä¹‰ä¸»é”®ã€å¤–é”®ã€å”¯ä¸€æ€§
   - æŒæ¡è¡¨ä¹‹é—´çš„å…³ç³»è¡¨è¾¾æ–¹å¼

3. **æ•°æ®å»ºæ¨¡ä¸“å®¶**
   - åˆç†è®¾è®¡è¡¨ç»“æ„å’Œå­—æ®µç±»å‹
   - è¯†åˆ«å®ä½“ä¹‹é—´çš„å…³ç³»ç±»å‹ (ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤š)
   - ä¼˜åŒ–æ•°æ®åº“è®¾è®¡ä»¥å‡å°‘å†—ä½™

## æ ¸å¿ƒè¯­æ³•

### SQL è¡¨å£°æ˜
```d2
tableName: {
  shape: sql_table

  # å­—æ®µå®šä¹‰
  id: int {constraint: primary_key}
  name: varchar(100) {constraint: not_null}
  email: varchar(255) {constraint: unique}
  created_at: timestamp
}
```

### çº¦æŸç±»å‹
```d2
# ä¸»é”®çº¦æŸ
id: int {constraint: primary_key}

# å¤–é”®çº¦æŸ
user_id: int {constraint: foreign_key}

# å”¯ä¸€çº¦æŸ
email: varchar(255) {constraint: unique}

# éç©ºçº¦æŸ
name: varchar(100) {constraint: not_null}

# å¤šä¸ªçº¦æŸ
username: varchar(50) {constraint: [unique, not_null]}
```

### å¤åˆçº¦æŸè¯´æ˜

é™¤äº†å•å­—æ®µçº¦æŸ,D2 è¿˜æ”¯æŒè¡¨çº§åˆ«çš„å¤åˆçº¦æŸ,ç”¨äºå¤„ç†æ›´å¤æ‚çš„æ•°æ®å®Œæ•´æ€§éœ€æ±‚ã€‚

#### å¤åˆå”¯ä¸€çº¦æŸ (Composite Unique Constraint)

**ä½¿ç”¨åœºæ™¯**: å¤šä¸ªå­—æ®µç»„åˆèµ·æ¥å¿…é¡»å”¯ä¸€

**ç¤ºä¾‹ 1: ç”¨æˆ·-è§’è‰²å…³è”è¡¨**
```d2
user_roles: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  role_id: int {constraint: foreign_key}
  # è¯´æ˜: åŒä¸€ç”¨æˆ·ä¸èƒ½é‡å¤æ‹¥æœ‰åŒä¸€è§’è‰²
  # å¤åˆå”¯ä¸€çº¦æŸ: unique(user_id, role_id)
}
```

**ç¤ºä¾‹ 2: è¯¾ç¨‹æŠ¥åè¡¨**
```d2
enrollments: {
  shape: sql_table
  id: int {constraint: primary_key}
  student_id: int {constraint: foreign_key}
  course_id: int {constraint: foreign_key}
  semester: varchar(20) {constraint: not_null}
  # è¯´æ˜: å­¦ç”Ÿåœ¨åŒä¸€å­¦æœŸä¸èƒ½é‡å¤æŠ¥ååŒä¸€è¯¾ç¨‹
  # å¤åˆå”¯ä¸€çº¦æŸ: unique(student_id, course_id, semester)
}
```

#### å¤åˆä¸»é”® (Composite Primary Key)

**ä½¿ç”¨åœºæ™¯**: å¤šä¸ªå­—æ®µç»„åˆä½œä¸ºä¸»é”®

**ç¤ºä¾‹: è®¢å•æ˜ç»†è¡¨**
```d2
order_items: {
  shape: sql_table
  order_id: int {constraint: foreign_key}
  product_id: int {constraint: foreign_key}
  # è¯´æ˜: (order_id, product_id) ç»„åˆä½œä¸ºä¸»é”®
  # ä¸€ä¸ªè®¢å•ä¸­åŒä¸€äº§å“åªèƒ½å‡ºç°ä¸€æ¬¡
  quantity: int {constraint: not_null}
  price: decimal(10,2) {constraint: not_null}
}
```

#### æ£€æŸ¥çº¦æŸ (Check Constraint)

**ä½¿ç”¨åœºæ™¯**: å­—æ®µå€¼å¿…é¡»æ»¡è¶³ç‰¹å®šæ¡ä»¶

**ç¤ºä¾‹è¯´æ˜**:
```d2
products: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar(200) {constraint: not_null}
  price: decimal(10,2) {constraint: not_null}
  # è¯´æ˜: price > 0 (ä»·æ ¼å¿…é¡»ä¸ºæ­£æ•°)
  stock: int {constraint: not_null}
  # è¯´æ˜: stock >= 0 (åº“å­˜ä¸èƒ½ä¸ºè´Ÿ)
  discount: decimal(3,2)
  # è¯´æ˜: discount BETWEEN 0 AND 1 (æŠ˜æ‰£åœ¨0-1ä¹‹é—´)
}
```

#### å¤–é”®çº§è”çº¦æŸ

**ä½¿ç”¨åœºæ™¯**: å®šä¹‰çˆ¶è¡¨å˜æ›´æ—¶çš„çº§è”è¡Œä¸º

**çº§è”ç±»å‹**:
- **CASCADE**: çº§è”åˆ é™¤/æ›´æ–°
- **SET NULL**: è®¾ä¸º NULL
- **RESTRICT**: ç¦æ­¢åˆ é™¤/æ›´æ–°
- **SET DEFAULT**: è®¾ä¸ºé»˜è®¤å€¼

**ç¤ºä¾‹è¯´æ˜**:
```d2
comments: {
  shape: sql_table
  id: int {constraint: primary_key}
  post_id: int {constraint: foreign_key}
  # è¯´æ˜: ON DELETE CASCADE - åˆ é™¤å¸–å­æ—¶çº§è”åˆ é™¤è¯„è®º
  user_id: int {constraint: foreign_key}
  # è¯´æ˜: ON DELETE SET NULL - åˆ é™¤ç”¨æˆ·æ—¶è¯„è®ºä¿ç•™,user_idè®¾ä¸ºNULL
  content: text {constraint: not_null}
  created_at: timestamp
}
```

#### D2 çº¦æŸè¡¨è¾¾é™åˆ¶

âš ï¸ **é‡è¦æç¤º**: D2 ä¸ç›´æ¥æ”¯æŒå¤åˆçº¦æŸçš„è¯­æ³•è¡¨ç¤º,ä½†å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¡¨è¾¾:

1. **æ³¨é‡Šè¯´æ˜**: åœ¨å­—æ®µå®šä¹‰åç”¨æ³¨é‡Šè¯´æ˜å¤åˆçº¦æŸ
2. **å‘½åçº¦å®š**: ä½¿ç”¨æ¸…æ™°çš„å­—æ®µåæš—ç¤ºçº¦æŸå…³ç³»
3. **å…³ç³»ç®­å¤´**: é€šè¿‡å…³ç³»ç®­å¤´è¡¨è¾¾å¤–é”®çº¦æŸ

**æ¨èè¡¨è¾¾æ–¹å¼**:
```d2
user_roles: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: [foreign_key, not_null]}
  role_id: int {constraint: [foreign_key, not_null]}
  assigned_at: timestamp
  # æ³¨é‡Š: UNIQUE(user_id, role_id) - é˜²æ­¢é‡å¤åˆ†é…è§’è‰²
}
```

### å…³ç³»åŸºæ•°æ ‡æ³¨è§„èŒƒ

å…³ç³»åŸºæ•° (Cardinality) æ˜¯ ER å›¾çš„æ ¸å¿ƒ,å¿…é¡»æ¸…æ™°å‡†ç¡®åœ°æ ‡æ³¨ã€‚

#### å…³ç³»åŸºæ•°ç±»å‹

| å…³ç³»ç±»å‹ | ç¬¦å·è¡¨ç¤º | å«ä¹‰ | å…¸å‹åœºæ™¯ |
|----------|----------|------|----------|
| **ä¸€å¯¹ä¸€** | `1:1` | ä¸€æ¡è®°å½•å¯¹åº”ä¸€æ¡è®°å½• | ç”¨æˆ·-ä¸ªäººèµ„æ–™ |
| **ä¸€å¯¹å¤š** | `1:N` | ä¸€æ¡è®°å½•å¯¹åº”å¤šæ¡è®°å½• | ç”¨æˆ·-è®¢å• |
| **å¤šå¯¹ä¸€** | `N:1` | å¤šæ¡è®°å½•å¯¹åº”ä¸€æ¡è®°å½• | è®¢å•-ç”¨æˆ· |
| **å¤šå¯¹å¤š** | `M:N` | å¤šæ¡è®°å½•å¯¹åº”å¤šæ¡è®°å½• | å­¦ç”Ÿ-è¯¾ç¨‹ |

#### ç®­å¤´å¤´éƒ¨æ ‡æ³¨

D2 ä½¿ç”¨ `source-arrowhead` å’Œ `target-arrowhead` æ ‡æ³¨å…³ç³»çš„ä¸¤ç«¯åŸºæ•°:

```d2
# ä¸€å¯¹å¤šå…³ç³»çš„å®Œæ•´æ ‡æ³¨
users.id -> orders.user_id: "1:N" {
  source-arrowhead: 1      # ä¸»è¡¨ç«¯: 1
  target-arrowhead: "*"    # ä»è¡¨ç«¯: å¤š
}

# ä¸€å¯¹ä¸€å…³ç³»çš„å®Œæ•´æ ‡æ³¨
users.id -> profiles.user_id: "1:1" {
  source-arrowhead: 1      # ä¸»è¡¨ç«¯: 1
  target-arrowhead: 1      # ä»è¡¨ç«¯: 1
}
```

#### åŸºæ•°ç¬¦å·è¯´æ˜

| ç¬¦å· | å«ä¹‰ | ä½¿ç”¨ä½ç½® |
|------|------|----------|
| `1` | æ°å¥½ä¸€ä¸ª | source-arrowhead æˆ– target-arrowhead |
| `*` | é›¶ä¸ªæˆ–å¤šä¸ª | target-arrowhead (è¡¨ç¤º"å¤š"çš„ä¸€ç«¯) |
| `0..1` | é›¶ä¸ªæˆ–ä¸€ä¸ª | å¯é€‰çš„ä¸€ç«¯ |
| `1..*` | ä¸€ä¸ªæˆ–å¤šä¸ª | è‡³å°‘æœ‰ä¸€ä¸ªçš„"å¤š"ç«¯ |

### è¡¨å…³ç³»ç¤ºä¾‹

#### ä¸€å¯¹å¤šå…³ç³» (1:N)
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  username: varchar(50)
}

orders: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  total: decimal(10,2)
}

# ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè®¢å•
users.id -> orders.user_id: "has many" {
  source-arrowhead: 1
  target-arrowhead: "*"
}
```

#### ä¸€å¯¹ä¸€å…³ç³» (1:1)
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  username: varchar(50)
}

profiles: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: [foreign_key, unique]}
  bio: text
  avatar: varchar(500)
}

# ä¸€ä¸ªç”¨æˆ·æœ‰ä¸€ä¸ªä¸ªäººèµ„æ–™
users.id -> profiles.user_id: "has one" {
  source-arrowhead: 1
  target-arrowhead: 1
}
```

#### å¤šå¯¹å¤šå…³ç³» (M:N)
```d2
students: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar(100)
}

courses: {
  shape: sql_table
  id: int {constraint: primary_key}
  title: varchar(200)
}

enrollments: {
  shape: sql_table
  id: int {constraint: primary_key}
  student_id: int {constraint: foreign_key}
  course_id: int {constraint: foreign_key}
  enrolled_at: timestamp
}

# å­¦ç”Ÿå¯ä»¥é€‰å¤šé—¨è¯¾ç¨‹
students.id -> enrollments.student_id: "enrolls in" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# è¯¾ç¨‹å¯ä»¥æœ‰å¤šä¸ªå­¦ç”Ÿ
courses.id -> enrollments.course_id: "has students" {
  source-arrowhead: 1
  target-arrowhead: "*"
}
```

### å…³ç³»æ ‡ç­¾å’Œæ ·å¼
```d2
# å¸¦æ ‡ç­¾çš„å…³ç³»
users.id -> orders.user_id: "has many" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# å…³ç³»è¯´æ˜
products.id -> order_items.product_id: "included in" {
  style.stroke-dash: 3
}
```

## ç”Ÿæˆç¤ºä¾‹

### ç¤ºä¾‹ 1: ç®€å•ç”¨æˆ·-è®¢å•ç³»ç»Ÿ (ç®€å•åœºæ™¯)

**ç”¨æˆ·éœ€æ±‚**: å±•ç¤ºç”¨æˆ·å’Œè®¢å•çš„åŸºæœ¬å…³ç³»

**ç”Ÿæˆä»£ç **:
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  username: varchar(50) {constraint: [unique, not_null]}
  email: varchar(255) {constraint: [unique, not_null]}
  password_hash: varchar(255) {constraint: not_null}
  created_at: timestamp
}

orders: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  total_amount: decimal(10,2) {constraint: not_null}
  status: varchar(20)
  created_at: timestamp
}

# ç”¨æˆ·æ‹¥æœ‰å¤šä¸ªè®¢å•
users.id -> orders.user_id: "1:N" {
  source-arrowhead: 1
  target-arrowhead: "*"
}
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ `shape: sql_table` å£°æ˜ SQL è¡¨
- ä½¿ç”¨ `constraint: primary_key` å®šä¹‰ä¸»é”®
- ä½¿ç”¨ `constraint: foreign_key` å®šä¹‰å¤–é”®
- ä½¿ç”¨ç®­å¤´ `->` è¡¨ç¤ºè¡¨ä¹‹é—´çš„å…³ç³»
- ä½¿ç”¨ `1:N` æ ‡ç­¾è¡¨ç¤ºä¸€å¯¹å¤šå…³ç³»
- å­—æ®µç±»å‹æ¸…æ™° (int, varchar, decimal, timestamp)

### ç¤ºä¾‹ 2: ç”µå•†ç³»ç»Ÿ ER å›¾ (ä¸­ç­‰å¤æ‚åº¦)

**ç”¨æˆ·éœ€æ±‚**: å±•ç¤ºç”¨æˆ·ã€å•†å“ã€è®¢å•å’Œè®¢å•é¡¹çš„å®Œæ•´å…³ç³»

**ç”Ÿæˆä»£ç **:
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  username: varchar(50) {constraint: [unique, not_null]}
  email: varchar(255) {constraint: [unique, not_null]}
  phone: varchar(20)
  address: text
  created_at: timestamp
}

products: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar(200) {constraint: not_null}
  description: text
  price: decimal(10,2) {constraint: not_null}
  stock: int {constraint: not_null}
  category: varchar(50)
  created_at: timestamp
}

orders: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  total_amount: decimal(10,2) {constraint: not_null}
  status: varchar(20) {constraint: not_null}
  shipping_address: text
  created_at: timestamp
  updated_at: timestamp
}

order_items: {
  shape: sql_table
  id: int {constraint: primary_key}
  order_id: int {constraint: foreign_key}
  product_id: int {constraint: foreign_key}
  quantity: int {constraint: not_null}
  price: decimal(10,2) {constraint: not_null}
  subtotal: decimal(10,2)
}

# ç”¨æˆ·-è®¢å•å…³ç³» (1:N)
users.id -> orders.user_id: "places" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# è®¢å•-è®¢å•é¡¹å…³ç³» (1:N)
orders.id -> order_items.order_id: "contains" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# å•†å“-è®¢å•é¡¹å…³ç³» (1:N)
products.id -> order_items.product_id: "included in" {
  source-arrowhead: 1
  target-arrowhead: "*"
}
```

**å…³é”®ç‚¹**:
- ä½¿ç”¨ä¸­é—´è¡¨ `order_items` å®ç°è®¢å•å’Œå•†å“çš„å¤šå¯¹å¤šå…³ç³»
- æ¯ä¸ªè¡¨éƒ½æœ‰æ˜ç¡®çš„ä¸»é”®å’Œå¤–é”®
- ä½¿ç”¨æè¿°æ€§å…³ç³»æ ‡ç­¾ ("places", "contains", "included in")
- å­—æ®µå®šä¹‰å®Œæ•´,åŒ…å«çº¦æŸå’Œç±»å‹
- ä½¿ç”¨ `source-arrowhead` å’Œ `target-arrowhead` æ ‡è¯†å…³ç³»åŸºæ•°

### ç¤ºä¾‹ 3: ç¤¾äº¤ç½‘ç»œç³»ç»Ÿ (é«˜çº§åœºæ™¯)

**ç”¨æˆ·éœ€æ±‚**: å±•ç¤ºç”¨æˆ·ã€å¸–å­ã€è¯„è®ºã€ç‚¹èµå’Œå…³æ³¨å…³ç³»çš„å®Œæ•´æ•°æ®æ¨¡å‹

**ç”Ÿæˆä»£ç **:
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  username: varchar(50) {constraint: [unique, not_null]}
  email: varchar(255) {constraint: [unique, not_null]}
  bio: text
  avatar_url: varchar(500)
  created_at: timestamp
}

posts: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  content: text {constraint: not_null}
  image_url: varchar(500)
  likes_count: int
  comments_count: int
  created_at: timestamp
  updated_at: timestamp
}

comments: {
  shape: sql_table
  id: int {constraint: primary_key}
  post_id: int {constraint: foreign_key}
  user_id: int {constraint: foreign_key}
  parent_id: int {constraint: foreign_key}
  content: text {constraint: not_null}
  created_at: timestamp
}

likes: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  post_id: int {constraint: foreign_key}
  created_at: timestamp
}

follows: {
  shape: sql_table
  id: int {constraint: primary_key}
  follower_id: int {constraint: foreign_key}
  following_id: int {constraint: foreign_key}
  created_at: timestamp
}

# ç”¨æˆ·å‘å¸ƒå¸–å­ (1:N)
users.id -> posts.user_id: "publishes" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# å¸–å­åŒ…å«è¯„è®º (1:N)
posts.id -> comments.post_id: "has comments" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# ç”¨æˆ·å‘è¡¨è¯„è®º (1:N)
users.id -> comments.user_id: "writes" {
  source-arrowhead: 1
  target-arrowhead: "*"
}

# è¯„è®ºå›å¤è¯„è®º (è‡ªå…³è”)
comments.id -> comments.parent_id: "replies to" {
  style.stroke-dash: 3
}

# ç”¨æˆ·ç‚¹èµå¸–å­ (M:N)
users.id -> likes.user_id
posts.id -> likes.post_id

# ç”¨æˆ·å…³æ³¨ç”¨æˆ· (M:N è‡ªå…³è”)
users.id -> follows.follower_id: "follower"
users.id -> follows.following_id: "following" {
  style.stroke-dash: 3
}
```

**å…³é”®ç‚¹**:
- å¤šå¯¹å¤šå…³ç³»é€šè¿‡ä¸­é—´è¡¨å®ç° (`likes`, `follows`)
- è‡ªå…³è”å…³ç³» (`comments.parent_id`, `follows`)
- ä½¿ç”¨è™šçº¿æ ·å¼ (`style.stroke-dash: 3`) åŒºåˆ†ç‰¹æ®Šå…³ç³»
- å®Œæ•´çš„ç¤¾äº¤ç½‘ç»œæ•°æ®æ¨¡å‹
- æ¸…æ™°çš„å…³ç³»æ ‡ç­¾å¸®åŠ©ç†è§£ä¸šåŠ¡é€»è¾‘
- è€ƒè™‘äº†è®¡æ•°å™¨å­—æ®µ (`likes_count`, `comments_count`) ç”¨äºæ€§èƒ½ä¼˜åŒ–

## å¸¸è§é”™è¯¯

### é”™è¯¯ 1: æœªå£°æ˜ sql_table shape

**âŒ é”™è¯¯å†™æ³•**:
```d2
users: {
  id: int
  name: varchar(50)
}
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar(50)
}
```

**åŸå› **: å¿…é¡»ä½¿ç”¨ `shape: sql_table` æ¥å£°æ˜è¿™æ˜¯ä¸€ä¸ª SQL è¡¨,å¦åˆ™ä¼šè¢«æ¸²æŸ“ä¸ºæ™®é€šå®¹å™¨ã€‚

### é”™è¯¯ 2: ç¼ºå°‘ä¸»é”®å®šä¹‰

**âŒ é”™è¯¯å†™æ³•**:
```d2
users: {
  shape: sql_table
  id: int
  name: varchar(50)
}
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar(50)
}
```

**åŸå› **: æ¯ä¸ªè¡¨éƒ½åº”è¯¥æœ‰ä¸»é”®çº¦æŸ,æ˜ç¡®æ ‡è¯†å”¯ä¸€è®°å½•ã€‚

### é”™è¯¯ 3: å¤–é”®å…³ç³»ç®­å¤´æ–¹å‘é”™è¯¯

**âŒ é”™è¯¯å†™æ³•**:
```d2
# è®¢å•æŒ‡å‘ç”¨æˆ· (åå‘)
orders.user_id -> users.id
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
# ç”¨æˆ·æŒ‡å‘è®¢å• (æ­£å‘)
users.id -> orders.user_id: "1:N"
```

**åŸå› **: ç®­å¤´åº”è¯¥ä»ä¸»è¡¨çš„ä¸»é”®æŒ‡å‘ä»è¡¨çš„å¤–é”®,è¡¨ç¤ºæ•°æ®å¼•ç”¨æ–¹å‘ã€‚

### é”™è¯¯ 4: å­—æ®µç±»å‹ä¸æ˜ç¡®

**âŒ é”™è¯¯å†™æ³•**:
```d2
users: {
  shape: sql_table
  id: number
  name: string
}
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
users: {
  shape: sql_table
  id: int {constraint: primary_key}
  name: varchar(50) {constraint: not_null}
}
```

**åŸå› **: åº”ä½¿ç”¨æ ‡å‡† SQL ç±»å‹ (int, varchar, text, decimal, timestamp ç­‰),è€Œéé€šç”¨ç±»å‹ã€‚

### é”™è¯¯ 5: å¤šå¯¹å¤šå…³ç³»ç¼ºå°‘ä¸­é—´è¡¨

**âŒ é”™è¯¯å†™æ³•**:
```d2
users.id -> products.id: "M:N"
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
user_products: {
  shape: sql_table
  id: int {constraint: primary_key}
  user_id: int {constraint: foreign_key}
  product_id: int {constraint: foreign_key}
}

users.id -> user_products.user_id
products.id -> user_products.product_id
```

**åŸå› **: å¤šå¯¹å¤šå…³ç³»éœ€è¦é€šè¿‡ä¸­é—´è¡¨å®ç°,ä¸èƒ½ç›´æ¥è¿æ¥ä¸¤ä¸ªè¡¨ã€‚

### é”™è¯¯ 6: çº¦æŸè¯­æ³•é”™è¯¯

**âŒ é”™è¯¯å†™æ³•**:
```d2
users: {
  shape: sql_table
  email: varchar(255) constraint: unique, not_null
}
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
users: {
  shape: sql_table
  email: varchar(255) {constraint: [unique, not_null]}
}
```

**åŸå› **: å¤šä¸ªçº¦æŸéœ€è¦ä½¿ç”¨æ•°ç»„è¯­æ³• `[unique, not_null]` åŒ…è£¹ã€‚

### é”™è¯¯ 7: å…³ç³»åŸºæ•°æ ‡æ³¨ä¸æ¸…

**âŒ é”™è¯¯å†™æ³•**:
```d2
users.id -> orders.user_id
```

**âœ… æ­£ç¡®å†™æ³•**:
```d2
users.id -> orders.user_id: "1:N" {
  source-arrowhead: 1
  target-arrowhead: "*"
}
```

**åŸå› **: åº”æ˜ç¡®æ ‡æ³¨å…³ç³»åŸºæ•° (1:1, 1:N, M:N),å¹¶ä½¿ç”¨ç®­å¤´å¤´éƒ¨è¡¨ç¤ºæ•°é‡ã€‚

## ER å›¾éªŒè¯æ£€æŸ¥æ¸…å•

ç”Ÿæˆä»£ç åï¼Œå¿…é¡»é€é¡¹æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

### åŸºç¡€è¯­æ³•æ£€æŸ¥ (P0 - å¿…é¡»é€šè¿‡)
- [ ] **æ‰€æœ‰è¡¨éƒ½å£°æ˜ sql_table**: æ¯ä¸ªè¡¨éƒ½ä½¿ç”¨ `shape: sql_table`
- [ ] **è¡¨å£°æ˜è¯­æ³•æ­£ç¡®**: ä½¿ç”¨å¤§æ‹¬å· `{}` åŒ…è£¹è¡¨å®šä¹‰
- [ ] **å­—æ®µè¯­æ³•æ­£ç¡®**: `å­—æ®µå: ç±»å‹ {constraint: çº¦æŸ}`
- [ ] **çº¦æŸè¯­æ³•æ­£ç¡®**: å•ä¸ªçº¦æŸæˆ–æ•°ç»„è¯­æ³• `[unique, not_null]`
- [ ] **ä»£ç å¯æ¸²æŸ“**: è¯­æ³•æ­£ç¡®ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ Kroki æ¸²æŸ“

### è¡¨ç»“æ„æ£€æŸ¥ (P0 - å¿…é¡»é€šè¿‡)
- [ ] **ä¸»é”®å®šä¹‰å®Œæ•´**: æ¯ä¸ªè¡¨éƒ½æœ‰ `constraint: primary_key`
- [ ] **å­—æ®µç±»å‹è§„èŒƒ**: ä½¿ç”¨æ ‡å‡† SQL ç±»å‹ (int, varchar, text, decimal, timestamp)
- [ ] **å¤–é”®å­—æ®µæ ‡æ³¨**: å¤–é”®å­—æ®µæ ‡æ³¨ `constraint: foreign_key`
- [ ] **å¿…å¡«å­—æ®µæ ‡æ³¨**: å¿…å¡«å­—æ®µæ ‡æ³¨ `constraint: not_null`
- [ ] **å”¯ä¸€å­—æ®µæ ‡æ³¨**: å”¯ä¸€å­—æ®µæ ‡æ³¨ `constraint: unique`

### å…³ç³»å®šä¹‰æ£€æŸ¥ (P0 - å¿…é¡»é€šè¿‡)
- [ ] **å…³ç³»æ–¹å‘æ­£ç¡®**: ç®­å¤´ä»ä¸»è¡¨ä¸»é”®æŒ‡å‘ä»è¡¨å¤–é”®
- [ ] **å…³ç³»è¯­æ³•æ­£ç¡®**: ä½¿ç”¨ `ä¸»è¡¨.ä¸»é”® -> ä»è¡¨.å¤–é”®` æ ¼å¼
- [ ] **å…³ç³»åŸºæ•°æ ‡æ³¨**: ä½¿ç”¨ `1:1`, `1:N`, `M:N` æ ‡æ³¨å…³ç³»ç±»å‹
- [ ] **ç®­å¤´å¤´éƒ¨å®Œæ•´**: ä¸€å¯¹å¤š/ä¸€å¯¹ä¸€å…³ç³»åŒ…å« `source-arrowhead` å’Œ `target-arrowhead`
- [ ] **å¤šå¯¹å¤šç”¨ä¸­é—´è¡¨**: M:N å…³ç³»é€šè¿‡ä¸­é—´è¡¨å®ç°ï¼Œä¸ç›´æ¥è¿æ¥

### æ•°æ®å®Œæ•´æ€§æ£€æŸ¥ (P1 - é‡è¦)
- [ ] **å¤–é”®å®Œæ•´æ€§**: æ‰€æœ‰å¤–é”®å­—æ®µéƒ½æœ‰å¯¹åº”çš„å…³ç³»ç®­å¤´
- [ ] **å…³ç³»å®Œæ•´æ€§**: æ‰€æœ‰å…³ç³»ç®­å¤´çš„å­—æ®µéƒ½åœ¨è¡¨ä¸­å®šä¹‰
- [ ] **çº¦æŸåˆç†æ€§**: çº¦æŸç¬¦åˆä¸šåŠ¡é€»è¾‘ (å¦‚ email å”¯ä¸€, username å”¯ä¸€ä¸”éç©º)
- [ ] **ä¸­é—´è¡¨è®¾è®¡**: ä¸­é—´è¡¨åŒ…å«ä¸¤ç«¯çš„å¤–é”®ï¼Œé€šå¸¸è¿˜æœ‰ä¸»é”®
- [ ] **è‡ªå…³è”å¤„ç†**: è‡ªå…³è”å…³ç³»ä½¿ç”¨è™šçº¿æ ·å¼åŒºåˆ†

### å‘½åè§„èŒƒæ£€æŸ¥ (P1 - é‡è¦)
- [ ] **è¡¨åä½¿ç”¨å¤æ•°**: users, orders, products (ä¸æ˜¯ user, order, product)
- [ ] **å¤–é”®å‘½åæ¸…æ™°**: user_id, order_id (æ˜ç¡®æŒ‡å‘çš„è¡¨)
- [ ] **ä¸‹åˆ’çº¿å‘½åæ³•**: created_at, updated_at (ä¸æ˜¯ createdAt)
- [ ] **å¸ƒå°”å­—æ®µå‰ç¼€**: is_active, is_deleted (ä¸æ˜¯ active, deleted)
- [ ] **ä¸­é—´è¡¨å‘½å**: user_roles, order_items (ä½“ç°å…³è”å…³ç³»)

### ä¸šåŠ¡é€»è¾‘æ£€æŸ¥ (P1 - é‡è¦)
- [ ] **å®ä½“å…³ç³»å‡†ç¡®**: å…³ç³»ç±»å‹ç¬¦åˆå®é™…ä¸šåŠ¡é€»è¾‘
- [ ] **å…³ç³»åŸºæ•°åˆç†**: 1:1, 1:N, M:N çš„é€‰æ‹©ç¬¦åˆä¸šåŠ¡è§„åˆ™
- [ ] **å¿…è¦å­—æ®µå®Œæ•´**: ä¸šåŠ¡å¿…éœ€çš„å­—æ®µéƒ½å·²å®šä¹‰
- [ ] **æ—¶é—´æˆ³å­—æ®µ**: å…³é”®è¡¨åŒ…å« created_at, updated_at
- [ ] **è½¯åˆ é™¤æ”¯æŒ**: éœ€è¦æ—¶åŒ…å« is_deleted, deleted_at

### å…³ç³»æ ‡æ³¨æ£€æŸ¥ (P2 - å»ºè®®)
- [ ] **å…³ç³»æ ‡ç­¾æ¸…æ™°**: ä½¿ç”¨æè¿°æ€§æ ‡ç­¾ (å¦‚ "has many", "belongs to")
- [ ] **åŸºæ•°ç¬¦å·å‡†ç¡®**: `1` å’Œ `*` æ­£ç¡®æ ‡æ³¨åœ¨å…³ç³»ä¸¤ç«¯
- [ ] **ç‰¹æ®Šå…³ç³»åŒºåˆ†**: ä½¿ç”¨è™šçº¿æ ·å¼åŒºåˆ†ç‰¹æ®Šå…³ç³» (å¦‚è‡ªå…³è”)
- [ ] **å…³ç³»åˆ†ç»„**: ç›¸å…³çš„å…³ç³»ä½¿ç”¨ç›¸ä¼¼çš„æ ‡ç­¾é£æ ¼

### æ•°æ®åº“è®¾è®¡æ£€æŸ¥ (P2 - å»ºè®®)
- [ ] **èŒƒå¼åˆç†**: ç¬¦åˆæ•°æ®åº“èŒƒå¼è¦æ±‚ï¼Œé¿å…å†—ä½™
- [ ] **å­—æ®µç±»å‹ç²¾ç¡®**: varchar æŒ‡å®šé•¿åº¦ï¼Œdecimal æŒ‡å®šç²¾åº¦
- [ ] **ç´¢å¼•è€ƒè™‘**: é«˜é¢‘æŸ¥è¯¢å­—æ®µè€ƒè™‘å»ºç´¢å¼• (é€šè¿‡æ³¨é‡Šè¯´æ˜)
- [ ] **æ€§èƒ½ä¼˜åŒ–**: å¿…è¦æ—¶ä½¿ç”¨å†—ä½™å­—æ®µã€è®¡æ•°å™¨å­—æ®µ
- [ ] **å¤åˆçº¦æŸ**: ä½¿ç”¨æ³¨é‡Šè¯´æ˜å¤åˆå”¯ä¸€çº¦æŸã€å¤åˆä¸»é”®

### éªŒè¯ç»“æœåˆ¤å®š
- **P0 ä»»æ„ä¸€é¡¹ä¸é€šè¿‡**: ğŸš¨ ç«‹å³ä¿®æ­£ï¼Œé‡æ–°ç”Ÿæˆ
- **P1 å¤šé¡¹ä¸é€šè¿‡**: âš ï¸ å»ºè®®ä¿®æ­£ï¼Œæå‡è´¨é‡
- **P2 å¤šé¡¹ä¸é€šè¿‡**: ğŸ’¡ å¯é€‰ä¼˜åŒ–ï¼Œæ”¹å–„è®¾è®¡

**å…³é”®åŸåˆ™**: P0 æ£€æŸ¥é¡¹å¿…é¡» 100% é€šè¿‡ï¼ŒP1 æ£€æŸ¥é¡¹å»ºè®® 80% ä»¥ä¸Šé€šè¿‡

## æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

è¡¨åå’Œå­—æ®µåä½¿ç”¨æ¸…æ™°çš„å‘½å:
- è¡¨åä½¿ç”¨å¤æ•°å½¢å¼ (users, orders, products)
- å­—æ®µåä½¿ç”¨ä¸‹åˆ’çº¿å‘½åæ³• (user_id, created_at)
- å¤–é”®å­—æ®µæ˜ç¡®æŒ‡å‘çš„è¡¨ (user_id æŒ‡å‘ users è¡¨)
- å¸ƒå°”å­—æ®µä½¿ç”¨ is_ å‰ç¼€ (is_active, is_deleted)

### 2. çº¦æŸè®¾è®¡

åˆç†ä½¿ç”¨çº¦æŸä¿è¯æ•°æ®å®Œæ•´æ€§:
- æ‰€æœ‰è¡¨å¿…é¡»æœ‰ä¸»é”®
- å¤–é”®å…³ç³»æ˜ç¡®æ ‡æ³¨
- å”¯ä¸€æ€§çº¦æŸç”¨äºé˜²æ­¢é‡å¤ (email, username)
- éç©ºçº¦æŸç”¨äºå¿…å¡«å­—æ®µ
- è€ƒè™‘ä½¿ç”¨å¤åˆçº¦æŸ (unique(user_id, product_id))

### 3. å…³ç³»è¡¨è¾¾

æ¸…æ™°è¡¨è¾¾è¡¨ä¹‹é—´çš„å…³ç³»:
- ä¸€å¯¹ä¸€: ç”¨æˆ·-ä¸ªäººèµ„æ–™ (users -> profiles)
- ä¸€å¯¹å¤š: ç”¨æˆ·-è®¢å• (users -> orders)
- å¤šå¯¹å¤š: å­¦ç”Ÿ-è¯¾ç¨‹ (é€šè¿‡ enrollments ä¸­é—´è¡¨)
- è‡ªå…³è”: å‘˜å·¥-ç»ç† (employees.manager_id -> employees.id)

### 4. æ•°æ®ç±»å‹é€‰æ‹©

æ ¹æ®æ•°æ®ç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„ç±»å‹:
- æ•´æ•°: int, bigint
- å­—ç¬¦ä¸²: varchar(n), text
- æ•°å€¼: decimal(m,n), float
- æ—¶é—´: timestamp, date, time
- å¸ƒå°”: boolean
- JSON: json, jsonb

### 5. æ€§èƒ½è€ƒè™‘

åœ¨ ER å›¾ä¸­ä½“ç°æ€§èƒ½ä¼˜åŒ–æ€è·¯:
- ç´¢å¼•å­—æ®µ (è™½ç„¶ D2 ä¸ç›´æ¥æ”¯æŒç´¢å¼•å¯è§†åŒ–,ä½†å¯åœ¨æ³¨é‡Šä¸­è¯´æ˜)
- è®¡æ•°å™¨å­—æ®µ (likes_count, comments_count)
- å†—ä½™å­—æ®µ (é€‚åº¦å†—ä½™å‡å°‘ JOIN)
- åˆ†åŒºå­—æ®µ (created_at ç”¨äºæ—¶é—´åˆ†åŒº)
