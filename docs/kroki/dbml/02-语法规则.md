# DBML 语法规则详解

> **验证时间**: 2025-10-13
> **参考来源**: https://dbml.dbdiagram.io/docs/

---

## 🎯 核心语法规则

### 1. 命名规则

#### 1.1 标识符命名

```dbml
// ✅ 推荐: 使用蛇形命名 (snake_case)
Table user_profiles { ... }
Table order_items { ... }

// ✅ 可选: 使用驼峰命名 (camelCase)
Table userProfiles { ... }

// ✅ 特殊字符: 使用双引号
Table "User Profiles" { ... }
Table "order-items" { ... }

// ❌ 避免: 保留关键字作为名称 (除非用引号)
Table select { ... }  // 不推荐
Table "select" { ... } // 可以
```

#### 1.2 Schema 规则

```dbml
// 默认 schema (public)
Table users { ... }
// 等同于
Table public.users { ... }

// 指定 schema
Table core.users { ... }
Table v2.orders { ... }

// Enum 也支持 schema
enum public.job_status { ... }
enum v2.job_status { ... }
```

### 2. 数据类型规则

#### 2.1 基本类型

```dbml
Table data_types {
  // 整数
  id integer
  big_id bigint
  small_id smallint

  // 浮点数
  price decimal(10,2)
  rating float
  score double

  // 字符串
  name varchar(100)
  description text
  code char(10)

  // 日期时间
  created_at timestamp
  birth_date date
  login_time time

  // 布尔
  is_active boolean

  // JSON
  metadata json
  settings jsonb

  // 其他
  file_data blob
  uuid_col uuid
}
```

#### 2.2 类型规范

**规则**:
- 数据类型必须是**单个单词** (移除所有空格)
- 参数用括号包裹: `decimal(10,2)`, `varchar(255)`

```dbml
// ✅ 正确
column_a decimal(10,2)
column_b varchar(255)
column_c "bigint unsigned"  // 特殊情况用引号

// ❌ 错误
column_d decimal (10, 2)    // 空格错误
column_e big int            // 应为 bigint
```

### 3. 列设置规则

#### 3.1 基本设置

```dbml
Table users {
  // 主键
  id integer [pk]
  id2 integer [primary key]  // 等同于 pk

  // 唯一约束
  email varchar [unique]

  // 非空约束
  username varchar [not null]
  password varchar [null]  // 默认可空

  // 自增
  auto_id integer [increment]

  // 组合设置
  created_at timestamp [not null, default: `now()`]
}
```

#### 3.2 默认值规则

```dbml
Table defaults {
  // 数字 (不带引号)
  count integer [default: 0]
  price decimal(10,2) [default: 99.99]

  // 字符串 (单引号)
  status varchar [default: 'active']
  source varchar [default: 'direct']

  // 布尔值
  is_enabled boolean [default: true]
  is_deleted boolean [default: false]
  is_null boolean [default: null]

  // 表达式 (反引号)
  created_at timestamp [default: `now()`]
  expires_at timestamp [default: `now() + interval '1 day'`]
  computed integer [default: `id * 2`]
}
```

**重要**:
- 数字: 直接写数字
- 字符串: 用单引号 `'string'`
- 表达式: 用反引号 `` `expression` ``
- 布尔: `true`, `false`, `null`

#### 3.3 注释规则

```dbml
Table comments {
  // 单行注释
  status varchar [note: 'User status']

  // 多行注释
  description text [note: '''
    This is a multi-line note
    It can span multiple lines
  ''']

  // 包含特殊字符
  emoji_status varchar [note: '💸 1=processing, ✔️ 2=shipped']
}
```

### 4. 索引规则

#### 4.1 单列索引

```dbml
Table users {
  id integer
  email varchar
  created_at timestamp

  indexes {
    id [pk]                              // 主键索引
    email [unique]                       // 唯一索引
    created_at                           // 普通索引
    created_at [name: 'idx_created']     // 命名索引
    email [type: hash]                   // 指定类型
  }
}
```

#### 4.2 复合索引

```dbml
Table orders {
  id integer
  user_id integer
  status varchar
  created_at timestamp

  indexes {
    (id, user_id) [pk]                   // 复合主键
    (user_id, created_at)                // 复合索引
    (user_id, status) [unique]           // 复合唯一索引
  }
}
```

#### 4.3 表达式索引

```dbml
Table advanced_indexes {
  id integer
  name varchar

  indexes {
    (`id * 2`)                           // 简单表达式
    (`lower(name)`)                      // 函数表达式
    (`id * 3`, `getdate()`)              // 多个表达式
    (`id * 3`, id)                       // 表达式 + 列
  }
}
```

#### 4.4 索引设置

```dbml
indexes {
  email [
    name: 'idx_email',        // 索引名称
    type: hash,               // 类型: btree, hash, gin, gist
    unique,                   // 唯一约束
    note: 'Email index'       // 注释
  ]
}
```

### 5. 关系规则

#### 5.1 关系符号

| 符号 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `<` | one-to-many | 左表 1 : 右表 N | `users.id < posts.user_id` |
| `>` | many-to-one | 左表 N : 右表 1 | `posts.user_id > users.id` |
| `-` | one-to-one | 左表 1 : 右表 1 | `users.id - profiles.user_id` |
| `<>` | many-to-many | 左表 N : 右表 N | `authors.id <> books.id` |

#### 5.2 关系语法

```dbml
// 1. 内联形式 (Inline)
Table posts {
  user_id integer [ref: > users.id]
}

// 2. 短格式 (Short form)
Ref: posts.user_id > users.id

// 3. 长格式 (Long form)
Ref post_user {
  posts.user_id > users.id
}

// 4. 带设置
Ref: posts.user_id > users.id [
  delete: cascade,
  update: no action,
  color: #79AD51
]
```

#### 5.3 复合外键

```dbml
// 复合外键
Ref: order_items.(order_id, product_id) > orders.(id, store_id)

// 跨 schema 关系
Ref: blogging.posts.user_id > core.users.id
```

#### 5.4 关系设置

```dbml
Ref: products.merchant_id > merchants.id [
  delete: cascade | restrict | set null | set default | no action,
  update: cascade | restrict | set null | set default | no action,
  color: #79AD51
]
```

#### 5.5 Zero-to-One/Many 关系

```dbml
Table follows {
  // many-to-zero (可空外键)
  following_user_id int [ref: > users.id, null]

  // many-to-one (非空外键)
  followed_user_id int [ref: > users.id, not null]
}
```

#### 5.6 One-to-One 规则

**重要**: 在 one-to-one 关系中，列的顺序决定外键位置

```dbml
// Long/Short form: 第二列是外键
users.id - user_infos.user_id  // user_infos.user_id 是外键

// Inline form: 有 ref 的列是外键
Table user_infos {
  user_id integer [ref: - users.id]  // user_id 是外键
}
```

### 6. 枚举规则

```dbml
// 基本枚举
enum status {
  active
  inactive
  suspended
}

// 带注释
enum order_status {
  pending [note: 'Order placed']
  processing [note: 'Being processed']
  shipped
  delivered
}

// 包含特殊字符 (用双引号)
enum grade {
  "A+"
  "A"
  "A-"
  "Not Yet Set"
}

// 指定 schema
enum v2.status {
  active
  inactive
}

// 使用枚举
Table orders {
  status order_status
  grade v2.grade
}
```

### 7. 表模板规则 (TablePartial)

```dbml
// 定义模板
TablePartial base_template [headerColor: #ff0000] {
  id int [pk, not null]
  created_at timestamp [default: `now()`]

  indexes {
    created_at
  }
}

TablePartial soft_delete {
  deleted_at timestamp
  deleted_by integer
}

// 使用模板 (~ 前缀)
Table users {
  ~base_template        // 注入 base_template
  username varchar
  email varchar
  ~soft_delete          // 注入 soft_delete
}

// 冲突解决优先级:
// 1. 本地表定义 (最高)
// 2. 最后注入的模板
// 3. 先注入的模板
```

### 8. 注释和字符串规则

#### 8.1 单行注释

```dbml
// 这是单行注释
Table users { ... }  // 行尾注释
```

#### 8.2 多行注释

```dbml
/*
  这是多行注释
  可以跨越多行
*/
Table users { ... }
```

#### 8.3 多行字符串

```dbml
Note: '''
  这是多行字符串
  - 换行: 直接按 Enter
  - 续行: 使用 \
  - 转义:
    - \\ 代表 \
    - \' 代表 '
'''

// 自动去除缩进
Note: '''
  Line 1
    Line 2 (缩进)
  Line 3
'''
// 输出:
// Line 1
//   Line 2 (缩进)
// Line 3
```

### 9. 表分组规则 (TableGroup)

```dbml
// 基本分组
TableGroup e_commerce {
  merchants
  countries
  products
}

// 带设置
TableGroup core [color: #345, note: 'Core tables'] {
  users
  roles
  permissions
}

// 跨 schema
TableGroup mixed {
  core.users
  blogging.posts
  public.comments
}
```

### 10. Sticky Notes 规则

```dbml
// 单行便签
Note reminder {
  'Remember to add indexes'
}

// 多行便签
Note architecture {'''
  ## Database Architecture

  - Users: Core user data
  - Orders: Transaction records
  - Products: Inventory management
'''}
```

### 11. 特殊规则

#### 11.1 保留名称处理

```dbml
Table users {
  // "id" 和 "url" 是保留名称，需要前缀
  "userDefined:id" integer
  "userDefined:url" varchar

  // 或者用其他名称
  user_id integer
  profile_url varchar
}
```

#### 11.2 Schema 优先级

```dbml
// 显式 schema
Table core.users { ... }           // 使用 core schema

// 默认 public
Table users { ... }                // 使用 public schema
Enum status { ... }                // 使用 public schema
```

#### 11.3 表别名

```dbml
Table very_long_user_table as U {
  id integer [pk]
}

// 在关系中使用别名
Ref: U.id < posts.user_id
```

---

## 📋 语法检查清单

### ✅ 必须遵守

- [ ] 所有列类型为单个单词 (移除空格)
- [ ] 字符串值用单引号 `'string'`
- [ ] 表达式用反引号 `` `expression` ``
- [ ] 变量名引用用双引号 `"column name"`
- [ ] 多行字符串用三单引号 `'''...'''`
- [ ] 设置用方括号 `[setting]`
- [ ] 分组用花括号 `{...}`

### ✅ 推荐做法

- [ ] 使用 snake_case 命名
- [ ] 为关键列添加注释
- [ ] 使用 TablePartial 减少重复
- [ ] 为复杂关系添加名称
- [ ] 使用 TableGroup 组织表
- [ ] 添加项目级别 Note

### ❌ 常见错误

- [ ] 数据类型包含空格: `big int` → `bigint`
- [ ] 默认值引号错误: `[default: "string"]` → `[default: 'string']`
- [ ] 表达式引号错误: `[default: 'now()']` → ``[default: `now()`]``
- [ ] 忘记 one-to-one 外键顺序
- [ ] 使用保留名称未加前缀

---

## 🔧 调试技巧

### 1. 使用 dbdiagram.io 验证

```
1. 访问 https://dbdiagram.io
2. 粘贴 DBML 代码
3. 查看语法错误提示
4. 实时预览图表
```

### 2. 使用 DBML CLI 验证

```bash
# 安装
npm install -g @dbml/cli

# 验证语法
dbml2sql schema.dbml --postgres

# 如果有错误会显示具体位置
```

### 3. 使用 VSCode 插件

```
1. 安装 "dbml-language" 插件
2. 打开 .dbml 文件
3. 获得语法高亮和错误提示
```

---

**文档更新**: 2025-10-13
**参考来源**: DBML 官方语法文档 (https://dbml.dbdiagram.io/docs/)
