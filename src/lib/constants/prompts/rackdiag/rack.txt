# RackDiag Rack 生成要求

## 图表类型:机柜图(Rack Diagram)

机柜图用于展示**单机柜设备布局**(U位规划),适用于数据中心机柜设计、设备安装规划、空间占用分析。

---

## 核心语法

### 基础机架定义
```
rackdiag {
  U位: 设备名称;
  U位: 设备名称 [2U];               // 占用2个U位
  U位: 设备名称 [4U, description = "详细说明"];
}
```

**语法规则**:
- **U位编号**: 1-42 (标准42U机柜,从底部到顶部)
- **设备名称**: 简洁描述设备类型
- **多U标记**: `[2U]`, `[3U]`, `[4U]` 标注占用空间
- **描述属性**: `description = "文本"` 添加详细说明

### 标准设备类型和U位占用

| 设备类型 | 典型U位占用 | 安装位置建议 |
|----------|-------------|--------------|
| **UPS** | 2-3U | 底部 (U1-U3) |
| **PDU** | 1U | 底部 (U4-U5) |
| **核心交换机** | 1-2U | 中下部 (U6-U10) |
| **接入交换机** | 1U | 中部 (U11-U15) |
| **刀片服务器** | 10U | 中部 (U16-U25) |
| **机架服务器** | 1-2U | 中上部 (U26-U38) |
| **存储阵列** | 4U | 中上部 (U30-U38) |
| **KVM** | 1U | 顶部 (U40-U42) |

---

## 生成示例

### 示例 1: 标准42U机柜 (Web服务器机架)
```
rackdiag {
  // 电源层 (U1-U5)
  1: UPS [2U, description = "APC Smart-UPS 3000"];
  3: PDU-1 [description = "Primary Power"];
  4: PDU-2 [description = "Backup Power"];

  // 网络层 (U6-U10)
  6: Core Switch [description = "48-port Gigabit"];
  7: Access Switch 1;
  8: Access Switch 2;

  // 计算层 (U10-U38)
  10: Web Server 1 [2U];
  12: Web Server 2 [2U];
  14: Web Server 3 [2U];
  16: App Server 1 [2U];
  18: App Server 2 [2U];
  20: DB Server [4U, description = "MySQL Primary"];
  24: Storage [4U, description = "SAN Array"];

  // 管理层 (U40-U42)
  40: KVM Switch [description = "Console Management"];
  41: Patch Panel;
}
```

**关键点**:
- U位从1(底部)到42(顶部)
- 分层清晰:电源→网络→计算→管理
- 4U设备占用U20-U23,下一设备从U24开始

### 示例 2: 高密度计算机架 (16台1U服务器)
```
rackdiag {
  // 电源+网络 (U1-U6)
  1: UPS [3U];
  4: PDU;
  5: ToR Switch [description = "Top-of-Rack"];

  // 计算密集区 (U7-U22, 16台服务器)
  7: Node-01;
  8: Node-02;
  9: Node-03;
  10: Node-04;
  11: Node-05;
  12: Node-06;
  13: Node-07;
  14: Node-08;
  15: Node-09;
  16: Node-10;
  17: Node-11;
  18: Node-12;
  19: Node-13;
  20: Node-14;
  21: Node-15;
  22: Node-16;

  // 管理 (U40)
  40: KVM;
}
```

**关键点**:
- 高密度部署:16台1U服务器
- 连续编号便于管理
- 预留U23-U39空间用于扩展

### 示例 3: 存储专用机架
```
rackdiag {
  // 电源 (U1-U4)
  1: UPS [2U];
  3: PDU-1;
  4: PDU-2;

  // 网络 (U5-U7)
  5: SAN Switch A;
  6: SAN Switch B;

  // 存储阵列 (U8-U35, 7个4U存储)
  8: Storage-01 [4U, description = "24TB"];
  12: Storage-02 [4U, description = "24TB"];
  16: Storage-03 [4U, description = "24TB"];
  20: Storage-04 [4U, description = "24TB"];
  24: Storage-05 [4U, description = "24TB"];
  28: Storage-06 [4U, description = "24TB"];
  32: Storage-07 [4U, description = "24TB"];

  // 管理 (U40)
  40: Management Console;
}
```

**关键点**:
- 存储密集型部署
- 双PDU冗余电源
- 双SAN交换机冗余网络

---

## 常见错误

### 错误 1: U位重叠
**❌ 错误**:
```
rackdiag {
  1: Server 1 [2U];  // 占用 U1-U2
  2: Server 2;       // U2 已被占用
}
```

**✅ 正确**:
```
rackdiag {
  1: Server 1 [2U];  // 占用 U1-U2
  3: Server 2;       // 从 U3 开始
}
```

**原因**: 多U设备占用的空间不能与其他设备重叠。

---

### 错误 2: U位超出范围
**❌ 错误**:
```
rackdiag {
  45: Server;  // 超出42U范围
}
```

**✅ 正确**:
```
rackdiag {
  40: Server;  // 1-42范围内
}
```

**原因**: 标准42U机柜只有U1-U42。

---

### 错误 3: 布局不合理
**❌ 错误**: 电源设备放在顶部,KVM放在底部
**✅ 正确**: 遵循"电源底部、网络中部、管理顶部"原则

**原因**:
- 电源底部:重心低,稳定性好
- KVM顶部:方便操作维护
- 热空气上升:重要设备避��放顶部

---

### 错误 4: 缺少多U标记
**❌ 错误**:
```
rackdiag {
  1: Storage;  // 未标注占用空间
  2: Server;   // 可能与Storage冲突
}
```

**✅ 正确**:
```
rackdiag {
  1: Storage [4U];  // 明确占用U1-U4
  5: Server;        // 从U5开始
}
```

---

## 设计原则

### 1. 分层规划
- **底部(U1-U5)**: 电源设备(UPS, PDU)
- **中下部(U6-U15)**: 网络设备(交换机)
- **中上部(U16-U38)**: 计算/存储设备
- **顶部(U39-U42)**: 管理设备(KVM, Patch Panel)

### 2. 散热考虑
- 高发热设备(服务器)避免堆叠在顶部
- 预留空U位用于散热通风
- 热空气上升原则:重要设备放中下部

### 3. 重量分布
- 重设备(UPS, Storage)放底部
- 轻设备(交换机, KVM)可放上部
- 避免头重脚轻导致不稳定

### 4. 线缆管理
- 预留U位用于线缆整理
- 考虑走线方便性
- 避免交叉干扰

---

## 生成检查清单

- [ ] **U位编号合法**:所有设备在1-42范围内
- [ ] **无U位重叠**:多U设备占用空间计算正确
- [ ] **布局分层合理**:电源底部、网络中部、管理顶部
- [ ] **多U标记完整**:所有多U设备使用`[2U]`/`[4U]`标记
- [ ] **设备名称清晰**:使用标准设备类型名称
- [ ] **描述信息完整**:关键设备添加`description`属性
- [ ] **代码可渲染**:语法正确,通过Kroki渲染

**任何检查项不通过,立即修正后重新生成**
