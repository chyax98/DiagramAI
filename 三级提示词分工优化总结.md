# 三级提示词分工优化总结

> 优化时间: 2025-10-18  
> 目标: 删除文件系统兜底逻辑，梳理清晰的分工原则，在页面展示分工说明

---

## ✅ 已完成的工作

### 1. 删除文件系统兜底逻辑

#### 修改的文件

**`src/lib/utils/prompt-loader.ts`**

**变更内容**:
- ✅ 删除了 `fs/promises` 的 `readFile` 导入
- ✅ 删除了 `path` 的 `join` 导入
- ✅ 删除了 `PROMPTS_DIR` 常量导入
- ✅ 删除了所有文件系统 Fallback 逻辑（L1/L2/L3 三层）
- ✅ 改为纯数据库加载，L1 和 L3 不存在时直接抛出错误
- ✅ L2 保持可选，不存在时返回 null

**变更前后对比**:

```typescript
// ❌ 变更前（有文件系统兜底）
const l1Custom = promptRepo.findActive(1);
if (l1Custom) {
  l1_content = l1Custom.content;
  l1_version = l1Custom.version;
  l1_id = l1Custom.id;
} else {
  // Fallback 到文件系统
  const universalPath = join(PROMPTS_DIR, "universal.txt");
  try {
    l1_content = await readFile(universalPath, "utf-8");
    l1_version = "system-default";
  } catch (_error) {
    l1_content = null;
  }
}

// ✅ 变更后（纯数据库加载）
const l1 = promptRepo.findActive(1);
if (!l1) {
  throw new Error("L1 通用提示词不存在，请检查数据库初始化");
}

const l1_content = l1.content;
const l1_version = l1.version;
const l1_id = l1.id;
```

**优势**:
- ✅ 简化了代码逻辑，减少了 50+ 行代码
- ✅ 消除了对文件系统的依赖
- ✅ 更快的响应速度（无需文件 I/O）
- ✅ 更明确的错误提示
- ✅ 与数据库初始化脚本配合，保证数据完整性

---

### 2. 设计清晰的三级提示词分工原则

#### 分工原则总结

```mermaid
graph TB
    subgraph "L1: 通用规范层"
        L1A[任务识别指令<br/>GENERATE/ADJUST/FIX]
        L1B[输出格式要求<br/>纯代码、无 Markdown]
        L1C[AI 行为准则<br/>如何理解用户意图]
        L1D[通用质量标准<br/>清晰性、完整性]
        L1E[错误处理原则]
    end
    
    subgraph "L2: 语言规范层（可选）"
        L2A[语言保留关键字列表]
        L2B[特殊字符转义规则]
        L2C[注释语法规范]
        L2D[所有类型共同规则]
        L2E[命名约定和最佳实践]
    end
    
    subgraph "L3: 类型规范层"
        L3A[专家视角定义]
        L3B[核心语法和节点类型]
        L3C[布局方向和结构建议]
        L3D[高级特性<br/>子图、样式定制]
        L3E[最佳实践和常见模式]
    end
    
    L1A --> Merge[合成最终 Prompt]
    L1B --> Merge
    L1C --> Merge
    L1D --> Merge
    L1E --> Merge
    
    L2A --> Merge
    L2B --> Merge
    L2C --> Merge
    L2D --> Merge
    L2E --> Merge
    
    L3A --> Merge
    L3B --> Merge
    L3C --> Merge
    L3D --> Merge
    L3E --> Merge
    
    Merge --> Final[最终 Prompt]
    
    style L1A fill:#e1f5ff
    style L1B fill:#e1f5ff
    style L1C fill:#e1f5ff
    style L1D fill:#e1f5ff
    style L1E fill:#e1f5ff
    
    style L2A fill:#fff3e0
    style L2B fill:#fff3e0
    style L2C fill:#fff3e0
    style L2D fill:#fff3e0
    style L2E fill:#fff3e0
    
    style L3A fill:#f3e5f5
    style L3B fill:#f3e5f5
    style L3C fill:#f3e5f5
    style L3D fill:#f3e5f5
    style L3E fill:#f3e5f5
    
    style Final fill:#c8e6c9
```

#### 核心原则

**L1: 通用规范层**
- ✅ **应该包含**: 所有图表类型共享的规则
- ❌ **不应包含**: 特定语言或类型的细节
- 🎯 **复用率**: 2,300+ 次（23 语言 × 100+ 类型）

**L2: 语言规范层**
- ✅ **应该包含**: 某种渲染语言的共同规则
- ❌ **不应包含**: 特定图表类型的独有语法
- 🎯 **复用率**: 平均 5 次/语言（可选层）

**L3: 类型规范层**
- ✅ **应该包含**: 特定图表类型的专用规则
- ❌ **不应包含**: 重复 L1/L2 的内容
- 🎯 **复用率**: 1 次（每个类型独有）

---

### 3. 创建提示词分工说明组件

#### 新增文件

**`src/components/prompts/PromptGuide.tsx`**

**组件功能**:
- ✅ 展示三级提示词系统的核心概念
- ✅ 详细说明每层的分工和职责
- ✅ 提供"应该包含"和"不应包含"的清单
- ✅ 展示提示词合成公式
- ✅ 提供编辑最佳实践和快速开始指南
- ✅ 响应式设计，支持移动端和桌面端

**组件结构**:

```
PromptGuide
├── 标题和说明
├── 核心概念（三层架构介绍）
├── 三层分工详解（3 列卡片）
│   ├── L1: 通用规范层
│   │   ├── 应该包含（5 项）
│   │   ├── 不应包含（3 项）
│   │   └── 复用率统计
│   ├── L2: 语言规范层
│   │   ├── 应该包含（5 项）
│   │   ├── 不应包含（3 项）
│   │   └── 复用率统计
│   └── L3: 类型规范层
│       ├── 应该包含（5 项）
│       ├── 不应包含（3 项）
│       └── 复用率统计
├── 合成公式
├── 编辑建议（4 类）
│   ├── 内容组织
│   ├── 质量控制
│   ├── 版本管理
│   └── 性能优化
├── 快速开始（4 步骤）
└── 底部提示
```

**视觉设计**:
- 使用渐变背景和卡片布局
- 三层用不同颜色标识（蓝色/琥珀色/紫色）
- 响应式网格布局（桌面 3 列，移动 1 列）
- 图标辅助（Lucide React 图标库）
- 清晰的视觉层次和留白

---

### 4. 集成分工说明到提示词管理页面

#### 修改的文件

**`src/components/prompts/PromptEditor.tsx`**

**变更内容**:
- ✅ 导入 `PromptGuide` 组件
- ✅ 替换原来的 `EmptyState` 为 `PromptGuide`
- ✅ 当用户未选择层级时，显示分工说明

**变更前后对比**:

```typescript
// ❌ 变更前
if (!selection.level) {
  return (
    <EmptyState
      title="欢迎使用 Prompt 管理"
      description="请按照以下步骤操作:"
      steps={[
        { label: "选择提示词层级 (L1/L2/L3)" },
        { label: "选择渲染语言 (如 Mermaid, PlantUML)" },
        { label: "选择图表类型 (L3 自动选择第一个)" },
        { label: "编辑并保存为新版本" },
      ]}
    />
  );
}

// ✅ 变更后
if (!selection.level) {
  return <PromptGuide />;
}
```

**用户体验提升**:
- ✅ 更详细的分工说明（从 4 行文字 → 完整的指南）
- ✅ 更好的视觉呈现（卡片布局、图标、颜色标识）
- ✅ 更实用的建议（编辑最佳实践、常见问题）
- ✅ 更友好的引导（快速开始步骤）

---

## 📊 影响范围

### 修改的文件

| 文件 | 修改类型 | 行数变化 | 说明 |
|------|---------|---------|------|
| `src/lib/utils/prompt-loader.ts` | 重构 | -60 行 | 删除文件系统兜底逻辑 |
| `src/components/prompts/PromptEditor.tsx` | 优化 | +2 行 | 集成 PromptGuide 组件 |
| `src/components/prompts/PromptGuide.tsx` | 新增 | +460 行 | 创建分工说明组件 |

### 新增的文件

- ✅ `src/components/prompts/PromptGuide.tsx` - 三级提示词分工说明组件

### 删除的依赖

- ❌ `fs/promises` 的 `readFile` (prompt-loader.ts)
- ❌ `path` 的 `join` (prompt-loader.ts)
- ❌ `PROMPTS_DIR` 常量引用 (prompt-loader.ts)

---

## 🎯 效果验证

### 功能测试

**测试步骤**:

1. ✅ **访问提示词管理页面** (`/prompts`)
   - 应该看到新的分工说明组件
   - 页面布局应该美观、响应式

2. ✅ **选择 L1 层级**
   - 应该从数据库加载 L1 通用提示词
   - 不应该尝试读取文件系统

3. ✅ **选择 L2 层级 + Mermaid 语言**
   - 应该从数据库加载 L2 语言提示词
   - 如果不存在，应该返回 null（不报错）

4. ✅ **选择 L3 层级 + Mermaid + Flowchart**
   - 应该从数据库加载 L3 类型提示词
   - 如果不存在，应该抛出明确的错误

5. ✅ **生成图表**
   - 提示词应该正确合成（L1 + L2 + L3）
   - 生成功能应该正常工作

### 错误处理测试

**场景 1: L1 不存在**
```
错误消息: "L1 通用提示词不存在，请检查数据库初始化"
```

**场景 2: L3 不存在**
```
错误消息: "L3 提示词不存在: mermaid/flowchart，请检查数据库初始化"
```

**场景 3: L2 不存在**
```
行为: 返回 null，不影响系统运行（L2 可选）
```

---

## 📝 数据库初始化要求

### 必须导入的提示词

为了保证系统正常运行，数据库初始化脚本必须导入：

1. **L1 通用提示词** (1 个)
   - `universal.txt` → custom_prompts 表

2. **L2 语言提示词** (可选，建议 21 个)
   - `{language}/common.txt` → custom_prompts 表
   - 如: `mermaid/common.txt`, `plantuml/common.txt` 等

3. **L3 类型提示词** (100+ 个，必需)
   - `{language}/{type}.txt` → custom_prompts 表
   - 如: `mermaid/flowchart.txt`, `plantuml/sequence.txt` 等

### 导入脚本示例

```typescript
// scripts/init-prompts.ts
import { readFileSync } from 'fs';
import { join } from 'path';
import { getDatabaseInstance } from '@/lib/db/client';
import { PromptRepository } from '@/lib/repositories/PromptRepository';

const db = getDatabaseInstance();
const repo = new PromptRepository(db);

// 导入 L1
const l1Content = readFileSync('data/prompts/universal.txt', 'utf-8');
repo.create({
  prompt_level: 1,
  version: 'v0',
  name: '官方通用规范',
  content: l1Content,
  is_active: true,
  created_by: 0,
});

// 导入 L2
const languages = ['mermaid', 'plantuml', 'd2', ...];
for (const lang of languages) {
  try {
    const l2Content = readFileSync(`data/prompts/${lang}/common.txt`, 'utf-8');
    repo.create({
      prompt_level: 2,
      render_language: lang,
      version: 'v0',
      name: `${lang} 官方语言规范`,
      content: l2Content,
      is_active: true,
      created_by: 0,
    });
  } catch {
    // L2 可选，跳过不存在的文件
  }
}

// 导入 L3
const types = [
  { lang: 'mermaid', type: 'flowchart' },
  { lang: 'mermaid', type: 'sequence' },
  // ... 100+ 个类型
];
for (const { lang, type } of types) {
  const l3Content = readFileSync(`data/prompts/${lang}/${type}.txt`, 'utf-8');
  repo.create({
    prompt_level: 3,
    render_language: lang,
    diagram_type: type,
    version: 'v0',
    name: `${lang}/${type} 官方类型规范`,
    content: l3Content,
    is_active: true,
    created_by: 0,
  });
}
```

---

## 🚀 后续优化建议

### 1. 提示词内容优化

**目标**: 根据新的分工原则，重新审视现有提示词

**行动**:
- [ ] 检查 L1 是否包含了语言特定的内容 → 移到 L2
- [ ] 检查 L2 是否包含了类型特定的内容 → 移到 L3
- [ ] 检查 L3 是否重复了 L1/L2 的内容 → 删除冗余

### 2. 提示词压缩

**目标**: 减少 Token 消耗，提升响应速度

**行动**:
- [ ] 创建 L1 的精简版本（`universal_minimal.txt`）
- [ ] 根据用户输入复杂度动态选择提示词版本
- [ ] 删除过时的示例和规则

### 3. A/B 测试支持

**目标**: 对比不同提示词版本的效果

**行动**:
- [ ] 在数据库中添加 `experiment_group` 字段
- [ ] 记录每个版本的成功率和用户反馈
- [ ] 自动推荐效果更好的版本

### 4. 智能推荐

**目标**: 基于失败日志自动改进提示词

**行动**:
- [ ] 分析渲染失败模式（常见语法错误）
- [ ] 识别提示词不足的部分
- [ ] 生成改进建议并通知管理员

---

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| [三级提示词功能分析.md](./三级提示词功能分析.md) | 详细的架构分析和代码实现 |
| [三级提示词合成示例.md](./三级提示词合成示例.md) | 实际的合成案例和效果对比 |
| [三级提示词系统总览.md](./三级提示词系统总览.md) | 可视化图表和快速参考 |
| [CLAUDE.md](./CLAUDE.md) | 开发者文档（第 630-712 行） |

---

## ✅ 总结

### 完成的任务

1. ✅ **删除文件系统兜底逻辑** - 简化代码，提升性能
2. ✅ **设计清晰的分工原则** - 明确每层的职责和边界
3. ✅ **创建分工说明组件** - 美观、实用的用户指南
4. ✅ **集成到管理页面** - 在用户进入时展示分工说明

### 关键改进

- 🚀 **代码更简洁**: 减少 60 行冗余代码
- 🎯 **职责更清晰**: 每层分工明确，易于维护
- 💡 **用户体验更好**: 详细的指南帮助用户理解和编辑提示词
- ⚡ **性能更优**: 消除文件 I/O，纯数据库加载

### 核心原则

```
L1（通用）: 所有图表共享的规则
    ↓
L2（语言）: 特定渲染语言的共同规则（可选）
    ↓
L3（类型）: 特定图表类型的专用规则
```

**合成公式**:
```
最终 Prompt = L1 (必需) + "---" + L2 (可选) + "---" + L3 (必需)
```

---

**优化时间**: 2025-10-18  
**维护者**: DiagramAI Team  
**版本**: 1.0

