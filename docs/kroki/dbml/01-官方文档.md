# DBML 官方文档

> **验证时间**: 2025-10-13
> **信息来源**: https://dbml.dbdiagram.io/

---

## 📋 概述

**DBML (Database Markup Language)** 是一个开源的领域特定语言 (DSL)，专为定义和文档化数据库模式和结构而设计。

- **官方网站**: https://dbml.dbdiagram.io/
- **GitHub**: https://github.com/holistics/dbml
- **维护者**: Holistics (https://holistics.io)
- **标准**: ISO/IEC 19510

---

## 🎯 设计理念

### 核心特点

1. **声明式语法** - 与 SQL DDL 不同，DBML 是声明式而非命令式
2. **数据库无关** - 不绑定特定数据库 (PostgreSQL, MySQL, etc.)
3. **高可读性** - 专注于高层次数据库架构，而非底层创建细节
4. **简单一致** - 语法规则简单且一致

### 与 SQL DDL 的区别

| 特性       | DBML                 | SQL DDL                       |
| ---------- | -------------------- | ----------------------------- |
| 范式       | 声明式 (Declarative) | 命令式 (Imperative)           |
| 用途       | 定义和文档化 Schema  | 物理创建/修改表               |
| 数据库特定 | 否                   | 是 (Oracle, PostgreSQL, etc.) |
| 可读性     | 高                   | 中等                          |

---

## 📊 统计数据

- **文档创建数**: 250 万+ (截至 2025 年 2 月)
- **用户数**: 140 万+ (截至 2025 年 2 月)
- **社区贡献**: 20+ 开源项目和插件

---

## 🏗️ 核心语法结构

### 1. Project Definition (项目定义)

```dbml
Project project_name {
  database_type: 'PostgreSQL'
  Note: 'Description of the project'
}
```

### 2. Table Definition (表定义)

```dbml
// 默认 public schema
Table table_name {
  column_name column_type [column_settings]
}

// 指定 schema
Table schema_name.table_name {
  column_name column_type [column_settings]
}
```

**语法规则**:

- Schema 名称可选，默认为 `public`
- 表名和列名可用普通文本或双引号 `"column name"`
- 列类型支持所有单词类型 (如 `JSON`, `JSONB`, `decimal(1,2)`)
- 列表用 `{}` 包裹
- 设置用 `[]` 包裹
- 字符串值用单引号 `'string'`

### 3. Column Settings (列设置)

```dbml
Table buildings {
  id integer [pk, unique, default: 123, note: 'Number']
  address varchar(255) [unique, not null, note: 'to include unit number']
}
```

**可用设置**:

- `primary key` / `pk` - 主键
- `null` / `not null` - 可空/非空
- `unique` - 唯一约束
- `default: value` - 默认值
- `increment` - 自增
- `note: 'text'` - 注释

### 4. Default Value (默认值)

```dbml
Table users {
  id integer [default: 123]                    // 数字
  source varchar(255) [default: 'direct']      // 字符串
  created_at timestamp [default: `now()`]      // 表达式
  active boolean [default: true]               // 布尔值
}
```

### 5. Index Definition (索引定义)

```dbml
Table bookings {
  id integer
  country varchar
  booking_date date
  created_at timestamp

  indexes {
    (id, country) [pk]                         // 复合主键
    created_at [name: 'created_at_index']      // 命名索引
    (country, booking_date) [unique]           // 复合唯一索引
    booking_date [type: hash]                  // 指定索引类型
    (`id*2`)                                   // 表达式索引
  }
}
```

**索引设置**:

- `type: btree | hash | gin | gist` - 索引类型
- `name: 'index_name'` - 索引名称
- `unique` - 唯一索引
- `pk` - 主键

### 6. Relationship Definition (关系定义)

**四种关系类型**:

- `<` - one-to-many (一对多)
- `>` - many-to-one (多对一)
- `-` - one-to-one (一对一)
- `<>` - many-to-many (多对多)

**三种语法形式**:

```dbml
// 1. Long form (长格式)
Ref name_optional {
  schema1.table1.column1 < schema2.table2.column2
}

// 2. Short form (短格式)
Ref name_optional: schema1.table1.column1 < schema2.table2.column2

// 3. Inline form (内联格式)
Table posts {
  id integer
  user_id integer [ref: > users.id]
}
```

**关系设置**:

```dbml
Ref: products.merchant_id > merchants.id [
  delete: cascade,
  update: no action,
  color: #79AD51
]
```

**复合外键**:

```dbml
Ref: merchant_periods.(merchant_id, country_code) > merchants.(id, country_code)
```

### 7. Enum Definition (枚举定义)

```dbml
// 默认 public schema
enum job_status {
  created [note: 'Waiting to be processed']
  running
  done
  failure
}

// 指定 schema
enum v2.job_status {
  ...
}

// 包含特殊字符
enum grade {
  "A+"
  "A"
  "A-"
  "Not Yet Set"
}
```

### 8. TableGroup (表分组)

```dbml
TableGroup e_commerce [color: #345, note: 'E-commerce tables'] {
  merchants
  countries
  products
}
```

### 9. TablePartial (表模板)

```dbml
// 定义可重用模板
TablePartial base_template [headerColor: #ff0000] {
  id int [pk, not null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
}

TablePartial soft_delete_template {
  delete_status boolean [not null]
  deleted_at timestamp [default: `now()`]
}

// 使用模板 (用 ~ 前缀)
Table users {
  ~base_template
  name varchar
  ~soft_delete_template
}
```

### 10. Notes (注释)

```dbml
// 项目注释
Project DBML {
  Note: '''
  # DBML - Database Markup Language
  多行注释示例
  '''
}

// 表注释
Table users {
  Note: 'Stores user data'
}

// 列注释
Table orders {
  status varchar [note: '💸 1=processing, ✔️ 2=shipped']
}

// Sticky Notes (便签)
Note single_line_note {
  'This is a single line note'
}

Note multiple_lines_note {'''
  This is a multiple lines note
  This string can spans over multiple lines.
'''}
```

### 11. Multi-line String (多行字符串)

```dbml
Note: '''
  This is a block string
  This string can spans over multiple lines.
'''
```

**规则**:

- 用三个单引号 `'''` 包裹
- 换行: 直接按 Enter
- 续行: 使用 `\` 反斜杠
- 转义字符:
  - `\`: 使用 `\\`
  - `'`: 使用 `\'`
- 自动去除缩进

### 12. Comments (注释)

```dbml
// 单行注释

/*
  多行注释
  可以跨越多行
*/
```

---

## 🔄 语法一致性原则

| 符号        | 用途                      | 示例                  |
| ----------- | ------------------------- | --------------------- |
| `{}`        | 分组 (索引、约束、表定义) | `Table users {...}`   |
| `[]`        | 设置                      | `[pk, not null]`      |
| `//`        | 单行注释                  | `// 这是注释`         |
| `/* */`     | 多行注释                  | `/* ... */`           |
| `'string'`  | 字符串值                  | `default: 'value'`    |
| `"name"`    | 引用变量                  | `"column name"`       |
| `'''...'''` | 多行字符串                | `Note: '''...'''`     |
| `` ` ``     | 函数表达式                | ``default: `now()` `` |

---

## 🛠️ 配套工具

### 1. dbdiagram.io

- **功能**: 可视化数据库图表
- **网址**: https://dbdiagram.io
- **用途**: 从 DBML 代码生成 ER 图

### 2. dbdocs.io

- **功能**: 数据库文档生成器
- **网址**: https://dbdocs.io
- **用途**: 从 DBML 代码生成文档网站

### 3. RunSQL

- **功能**: SQL 查询测试工具
- **网址**: https://runsql.com
- **用途**: 创建模拟数据库环境

### 4. DBML CLI

- **功能**: 命令行工具
- **安装**: `npm install -g @dbml/cli`
- **用途**: DBML ↔ SQL 互转

```bash
# SQL 转 DBML
sql2dbml schema.sql --postgres -o schema.dbml

# DBML 转 SQL
dbml2sql schema.dbml --postgres -o schema.sql
```

### 5. @dbml/core (JS 模块)

- **功能**: Node.js 库
- **安装**: `npm install @dbml/core`
- **用途**: 程序化转换 DBML ↔ SQL

---

## 📦 社区贡献项目

1. **编辑器支持**:
   - VSCode: `dbml-language` by duynvu
   - Vim: `vim-dbml` by jidn
   - Emacs: `dbd-mode` by ccod

2. **解析器**:
   - Python: `PyDBML` by Vanderhoof
   - Go: `dbml-go` by duythinht
   - PHP: `dbml-parser` by Butschster
   - Java: `dbml-java` by Nils Wende
   - C#: `Ivy.Dbml.Parser` by Niels Bosma

3. **框架集成**:
   - Django: `DbmlForDjango` by hamedsj
   - Laravel: `Kacher` by Arsanandha
   - Rails: `SchemaToDbml` by Ricardo Ribeiro
   - Prisma: `prisma-dbml-generator` by Marc Stammerjohann

4. **其他工具**:
   - Android Room: `FloorPlan` by julioz
   - Parse Server: `parseServerSchema2dbml` by stepanic
   - Snowflake: `snowflake-dbml-generator` by Ryan Rozich
   - Dynamics 365: `d365fo-entity-schema` by noakesey

---

## 🔗 相关资源

- **官方文档**: https://dbml.dbdiagram.io/docs/
- **CLI 文档**: https://dbml.dbdiagram.io/cli
- **JS 模块文档**: https://dbml.dbdiagram.io/js-module/core
- **GitHub Issues**: https://github.com/holistics/dbml/issues
- **社区论坛**: https://community.dbdiagram.io/

---

## 📝 完整示例

```dbml
Project ecommerce_db {
  database_type: 'PostgreSQL'
  Note: 'E-commerce database schema'
}

// 枚举定义
enum order_status {
  pending [note: 'Order placed']
  processing
  shipped
  delivered
  cancelled
}

// 表定义
Table users {
  id integer [pk, increment]
  username varchar(50) [unique, not null]
  email varchar(100) [unique, not null]
  created_at timestamp [default: `now()`]

  indexes {
    email [unique]
    created_at
  }

  Note: 'User account information'
}

Table orders {
  id integer [pk, increment]
  user_id integer [not null, ref: > users.id]
  status order_status [default: 'pending']
  total_amount decimal(10,2) [not null]
  created_at timestamp [default: `now()`]

  indexes {
    (user_id, created_at)
    status
  }
}

// 关系定义
Ref: orders.user_id > users.id [delete: cascade]

// 表分组
TableGroup core {
  users
  orders
}
```

---

**文档更新**: 2025-10-13
**数据来源**: DBML 官方网站 (dbml.dbdiagram.io)
